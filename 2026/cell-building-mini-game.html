<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cell Systems: Emergency Mode</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

    :root {
        /* Kurzgesagt-inspired Color Palette */
        --bg-space: #0B0C10;
        --panel-bg: #1F2833;
        --cell-membrane: #45A29E;
        --atp-color: #F6E27F;
        --waste-color: #F4A261;
        --inf-color: #EF476F;
        --water-color: #118AB2;
        --success-color: #06D6A0;
        --text-light: #C5C6C7;
    }

    * { box-sizing: border-box; user-select: none; font-family: 'Nunito', sans-serif; }
    
    body {
        margin: 0; background-color: var(--bg-space); color: var(--text-light);
        overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center;
        background-image: radial-gradient(circle at center, #1a1c23 0%, #0B0C10 100%);
    }

    /* Screen Management */
    .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    .active { display: flex; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* Typography & Buttons */
    h1 { font-size: 4rem; text-shadow: 0 6px 0 rgba(0,0,0,0.5); color: #fff; margin: 0 0 10px 0; font-weight: 900; }
    h2 { font-size: 2.5rem; color: var(--cell-membrane); margin: 0 0 20px 0; font-weight: 900; }
    
    .btn {
        background: var(--cell-membrane); color: #000; border: none; padding: 15px 30px;
        font-size: 1.2rem; font-weight: 900; border-radius: 16px; cursor: pointer;
        box-shadow: 0 8px 0 rgba(0,0,0,0.4); transition: transform 0.1s, box-shadow 0.1s;
        text-transform: uppercase; letter-spacing: 1px;
    }
    .btn:active { transform: translateY(8px); box-shadow: 0 0px 0 transparent; }
    .btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

    /* Dashboard UI */
    #dashboard { flex-direction: row; padding: 25px; gap: 30px; }
    
    .side-panel {
        width: 360px; background: var(--panel-bg); border-radius: 25px; padding: 25px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; z-index: 10;
        border: 4px solid #334155;
    }

    /* Meters */
    .meter-box { margin-bottom: 15px; }
    .meter-label { display: flex; justify-content: space-between; font-weight: 900; font-size: 1.15rem; margin-bottom: 8px; color: #fff; }
    .meter-bg { background: #0f172a; height: 26px; border-radius: 13px; border: 2px solid #334155; overflow: hidden; box-shadow: inset 0 4px 6px rgba(0,0,0,0.5); }
    .meter-fill { height: 100%; transition: width 0.3s ease-out, background-color 0.3s; border-radius: 13px; width: 50%; }

    /* Cell Environment */
    .main-view { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
    .cell {
        width: 65vh; height: 65vh; max-width: 600px; max-height: 600px;
        background: #1F2833; border: 15px solid var(--cell-membrane);
        border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; position: relative;
        box-shadow: inset 0 0 60px rgba(0,0,0,0.6), 0 0 50px rgba(69, 162, 158, 0.2);
        animation: breathe 8s infinite alternate ease-in-out;
    }
    @keyframes breathe { 0% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; transform: scale(1); } 100% { border-radius: 60% 40% 30% 70% / 50% 60% 40% 50%; transform: scale(1.03); } }

    /* Organelles */
    .organelle {
        position: absolute; display: flex; flex-direction: column; justify-content: center; align-items: center;
        cursor: pointer; border-radius: 50%; box-shadow: 0 10px 0 rgba(0,0,0,0.3); color: white;
        font-weight: 900; transition: all 0.15s; border: 3px solid rgba(255,255,255,0.1);
    }
    .organelle:hover { filter: brightness(1.2); z-index: 20; margin-top: -5px; box-shadow: 0 15px 0 rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.3); }
    .organelle:active { margin-top: 5px; box-shadow: 0 0px 0 rgba(0,0,0,0.3); }
    .organelle.cooldown { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
    
    .org-icon { font-size: 2.8rem; margin-bottom: 2px; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5)); }
    .org-name { font-size: 0.9rem; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 12px; text-transform: uppercase; letter-spacing: 1px; }

    #org-nucleus { top: 35%; left: 35%; width: 30%; height: 30%; background: #9D4EDD; }
    #org-mitochondria { top: 18%; left: 62%; width: 25%; height: 16%; border-radius: 40px; background: #F77F00; transform: rotate(20deg); }
    #org-ribosomes { top: 68%; left: 22%; width: 18%; height: 18%; background: transparent; border: 4px dashed #EF476F; box-shadow: none; }
    #org-ribosomes:hover { margin-top: 0; transform: scale(1.1); }
    #org-er { top: 25%; left: 12%; width: 22%; height: 26%; border-radius: 20px; background: #4361EE; transform: rotate(-15deg); }
    #org-golgi { top: 62%; left: 68%; width: 20%; height: 16%; border-radius: 10px 30px 10px 30px; background: #4CC9F0; }
    #org-lysosome { top: 42%; left: 78%; width: 16%; height: 16%; background: #FFD166; }
    #org-membrane { bottom: -30px; left: 50%; transform: translateX(-50%); width: 220px; height: 60px; border-radius: 30px; background: var(--water-color); flex-direction: row; gap: 10px; }
    #org-membrane:hover { transform: translateX(-50%) scale(1.05); }

    /* Modal Styling */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 12, 16, 0.85);
        backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 100;
    }
    .modal {
        background: var(--panel-bg); width: 700px; max-width: 95%; border-radius: 30px; border: 4px solid #334155;
        box-shadow: 0 25px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header { background: rgba(0,0,0,0.4); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; }
    .mg-timer-text { font-size: 2.2rem; font-weight: 900; color: var(--inf-color); text-shadow: 0 0 10px rgba(239, 71, 111, 0.5); }
    .teacher-hint { background: rgba(246, 226, 127, 0.1); color: var(--atp-color); padding: 15px 30px; font-weight: 800; font-size: 1.1rem; border-bottom: 2px solid #334155; border-left: 5px solid var(--atp-color); }
    .mg-content { padding: 30px; min-height: 380px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .modal-footer { padding: 20px 30px; background: rgba(0,0,0,0.4); border-top: 2px solid #334155; display: flex; justify-content: flex-end; }

    /* Minigame Custom Assets */
    @keyframes floatDown { 0% { top: -20%; } 100% { top: 120%; } }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }

    .falling-item { position: absolute; font-size: 3.5rem; cursor: pointer; user-select: none; animation: floatDown 2.5s linear forwards; }
    .falling-item:active { transform: scale(0.8); }
    
    .er-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #000; padding: 15px; border-radius: 20px; border: 2px solid #334155; margin: 0 auto; }
    .er-cell { width: 70px; height: 70px; background: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; box-shadow: inset 0 4px 6px rgba(0,0,0,0.5); transition: transform 0.1s; }
    .er-cell:active { transform: scale(0.9); }

</style>
</head>
<body>

<div id="start-screen" class="screen active" style="flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <div style="font-size: 6rem; filter: drop-shadow(0 10px 0 rgba(0,0,0,0.5)); margin-bottom: 20px;">ü¶†üö®</div>
    <h1>Cell Systems</h1>
    <h2>Emergency Mode</h2>
    <p style="font-size: 1.3rem; max-width: 650px; margin-bottom: 30px; line-height: 1.6; font-weight: bold;">
        The human body is under extreme metabolic stress! You have exactly <strong>3 minutes</strong> to maintain homeostasis by managing the organelles.<br><br>
        Generate Energy (ATP), clear Toxic Waste, fight Viral Infections, and balance Water levels. If any vital hits a critical fail state, the cell dies!
    </p>
    
    <div style="background: var(--panel-bg); padding: 20px 40px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 40px; box-shadow: 0 8px 0 rgba(0,0,0,0.3); border: 2px solid #334155;">
        <label style="font-size: 1.2rem; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" id="teacher-hints" checked style="width: 24px; height: 24px; accent-color: var(--cell-membrane);"> Enable Teacher Hints (Year 8 Science)
        </label>
        <label style="font-size: 1.2rem; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" id="sound-toggle" checked style="width: 24px; height: 24px; accent-color: var(--cell-membrane);"> Enable Sound Effects
        </label>
    </div>
    
    <button class="btn" style="font-size: 1.8rem; padding: 20px 50px;" onclick="startGame()">Initiate Override</button>
</div>

<div id="dashboard" class="screen">
    <div class="side-panel">
        <h2 style="margin-top: 0; color: #fff; font-size: 2.2rem; border-bottom: 3px solid rgba(255,255,255,0.1); padding-bottom: 15px;">Vitals</h2>
        
        <div class="meter-box">
            <div class="meter-label"><span>‚ö° ATP (Energy)</span> <span id="val-atp">50%</span></div>
            <div class="meter-bg"><div class="meter-fill" id="fill-atp" style="background: var(--atp-color); width: 50%; box-shadow: 0 0 15px var(--atp-color);"></div></div>
        </div>
        <div class="meter-box">
            <div class="meter-label"><span>üóëÔ∏è Toxic Waste</span> <span id="val-waste">20%</span></div>
            <div class="meter-bg"><div class="meter-fill" id="fill-waste" style="background: var(--waste-color); width: 20%;"></div></div>
        </div>
        <div class="meter-box">
            <div class="meter-label"><span>ü¶† Viral Infection</span> <span id="val-inf">0%</span></div>
            <div class="meter-bg"><div class="meter-fill" id="fill-inf" style="background: var(--inf-color); width: 0%;"></div></div>
        </div>
        <div class="meter-box">
            <div class="meter-label"><span>üíß Water Balance</span> <span id="val-water">50%</span></div>
            <div class="meter-bg"><div class="meter-fill" id="fill-water" style="background: var(--water-color); width: 50%;"></div></div>
        </div>
        
        <div style="margin-top: auto; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 20px; text-align: center; border: 2px solid var(--cell-membrane);">
            <div style="font-size: 1.1rem; color: #C5C6C7; margin-bottom: 5px; text-transform: uppercase; font-weight: 900;">Time to Division</div>
            <div id="global-timer" style="font-size: 3.5rem; font-weight: 900; color: var(--cell-membrane); text-shadow: 0 0 15px rgba(69,162,158,0.5);">03:00</div>
        </div>
    </div>
    
    <div class="main-view">
        <div class="cell">
            <div class="organelle" id="org-nucleus" onclick="openGame('nucleus')">
                <span class="org-icon">üß¨</span><span class="org-name">Nucleus</span>
            </div>
            <div class="organelle" id="org-mitochondria" onclick="openGame('mitochondria')">
                <span class="org-icon">‚ö°</span><span class="org-name">Mitochondria</span>
            </div>
            <div class="organelle" id="org-ribosomes" onclick="openGame('ribosomes')">
                <span class="org-icon">üî¥</span><span class="org-name" style="background: #EF476F;">Ribosomes</span>
            </div>
            <div class="organelle" id="org-er" onclick="openGame('er')">
                <span class="org-icon">üé¢</span><span class="org-name">Rough E.R.</span>
            </div>
            <div class="organelle" id="org-golgi" onclick="openGame('golgi')">
                <span class="org-icon">üì¶</span><span class="org-name">Golgi</span>
            </div>
            <div class="organelle" id="org-lysosome" onclick="openGame('lysosome')">
                <span class="org-icon">‚ôªÔ∏è</span><span class="org-name" style="color:#000; background:rgba(255,255,255,0.8);">Lysosome</span>
            </div>
            <div class="organelle" id="org-membrane" onclick="openGame('membrane')">
                <span class="org-icon" style="font-size: 1.8rem;">üõ°Ô∏è</span><span class="org-name" style="background:transparent; font-size:1.1rem;">Cell Membrane</span>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="mg-title" style="margin: 0; color: #fff;">Protocol Name</h2>
            <div class="mg-timer-text" id="mg-timer">30s</div>
        </div>
        <div class="teacher-hint" id="mg-hint">Teacher Hint: ...</div>
        <div class="mg-content" id="mg-area">
            </div>
        <div class="modal-footer">
            <button class="btn" style="background: var(--inf-color); color: #fff; box-shadow: 0 6px 0 #b91c1c;" onclick="abortMinigame()">Abort Task (-5 ATP)</button>
        </div>
    </div>
</div>

<div id="end-screen" class="screen" style="flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <div id="end-emoji" style="font-size: 7rem; filter: drop-shadow(0 10px 0 rgba(0,0,0,0.5)); margin-bottom: 20px;">üèÜ</div>
    <h1 id="end-title" style="font-size: 4.5rem; text-shadow: 0 6px 0 rgba(0,0,0,0.5); margin: 0 0 10px 0;">Homeostasis Maintained!</h1>
    <h2 id="end-reason" style="font-size: 1.6rem; color: #C5C6C7; margin: 0 0 30px 0; max-width: 650px; line-height: 1.5; font-weight: bold;">The cell survived the emergency and is ready to divide.</h2>
    <div id="end-rating" style="font-size: 3.5rem; font-weight: 900; margin-bottom: 50px; text-shadow: 0 4px 10px rgba(0,0,0,0.5);">Survival Rating: S+</div>
    <button class="btn" style="font-size: 1.8rem; padding: 20px 50px;" onclick="location.reload()">Reboot Simulation</button>
</div>

<script>
    // --- GLOBAL STATE ---
    const state = { active: false, inMinigame: false, atp: 50, waste: 20, infection: 0, water: 50, time: 180 };
    let loop, mgTimer, lysoInterval, mitoInterval;
    let activeGame = null;
    let mgTimeLeft = 0;
    let cooldowns = {};

    // --- AUDIO SYSTEM ---
    let audioCtx = null;
    let soundEnabled = true;

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playTone(freq, type, duration, vol=0.1) {
        if (!soundEnabled || !audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    function sfxClick() { playTone(600, 'sine', 0.1); }
    function sfxCorrect() { playTone(400, 'sine', 0.1); setTimeout(()=>playTone(600, 'sine', 0.15), 100); }
    function sfxWrong() { playTone(150, 'sawtooth', 0.3, 0.2); }
    function sfxWin() { playTone(400, 'square', 0.1); setTimeout(()=>playTone(500, 'square', 0.1), 100); setTimeout(()=>playTone(600, 'square', 0.2), 200); }

    // --- CORE MECHANICS ---
    function flashScreen(color) {
        let f = document.createElement('div');
        f.style.cssText = `position: fixed; top:0; left:0; width:100%; height:100%; background:${color}; z-index: 1000; pointer-events:none; transition: opacity 0.3s; opacity: 1;`;
        document.body.appendChild(f);
        setTimeout(() => { f.style.opacity = 0; setTimeout(()=>f.remove(), 300); }, 50);
    }

    function startGame() {
        soundEnabled = document.getElementById('sound-toggle').checked;
        if (soundEnabled) initAudio();
        sfxClick();
        
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('dashboard').classList.add('active');
        
        state.active = true;
        updateUI();
        
        loop = setInterval(() => {
            if (!state.active) return;
            state.time--;
            
            // Drain rates logic (Minigames slow down drain)
            let drainMult = state.inMinigame ? 0.3 : 1.0;

            state.atp -= 0.8 * drainMult;
            state.waste += 0.5 * drainMult;
            if (Math.random() < 0.25) state.infection += 1.5 * drainMult;
            if (state.water > 50) state.water += 0.5 * drainMult; else state.water -= 0.5 * drainMult;
            
            // Clamping
            state.atp = Math.max(0, Math.min(100, state.atp));
            state.waste = Math.max(0, Math.min(100, state.waste));
            state.infection = Math.max(0, Math.min(100, state.infection));
            state.water = Math.max(0, Math.min(100, state.water));

            updateUI();
            checkGameOver();
        }, 1000);
    }

    function updateUI() {
        const setMeter = (id, val, danger, color) => {
            document.getElementById(`val-${id}`).innerText = Math.round(val) + '%';
            let fill = document.getElementById(`fill-${id}`);
            fill.style.width = val + '%';
            fill.style.background = danger ? 'var(--inf-color)' : color;
            fill.style.boxShadow = (id==='atp' && !danger) ? `0 0 15px ${color}` : (danger ? '0 0 15px var(--inf-color)' : 'none');
        };

        setMeter('atp', state.atp, state.atp < 20, 'var(--atp-color)');
        setMeter('waste', state.waste, state.waste > 80, 'var(--waste-color)');
        setMeter('inf', state.infection, state.infection > 80, 'var(--inf-color)');
        setMeter('water', state.water, state.water < 20 || state.water > 80, 'var(--water-color)');

        let m = Math.floor(state.time / 60);
        let s = state.time % 60;
        document.getElementById('global-timer').innerText = `0${m}:${s<10?'0':''}${s}`;
    }

    function checkGameOver() {
        if (!state.active) return;
        
        let isLoss = (state.atp <= 0 || state.waste >= 100 || state.infection >= 100 || state.water <= 0 || state.water >= 100);
        let isWin = (state.time <= 0 && !isLoss);
        
        if (isLoss || isWin) {
            state.active = false;
            clearInterval(loop);
            if (mgTimer) clearInterval(mgTimer);
            if (lysoInterval) clearInterval(lysoInterval);
            if (mitoInterval) clearInterval(mitoInterval);
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('modal').style.display = 'none';
            document.getElementById('end-screen').classList.add('active');
            
            let title = isWin ? "Homeostasis Maintained!" : "Cellular Death!";
            let emoji = isWin ? "üèÜ" : "üíÄ";
            let reason = isWin ? "The cell survived the emergency and is ready to divide." : "";
            
            if (!isWin) {
                if (state.atp <= 0) reason = "Energy Depletion (Starvation)";
                else if (state.waste >= 100) reason = "Toxic Shock (Waste Overload)";
                else if (state.infection >= 100) reason = "Viral Takeover (Defenses Failed)";
                else if (state.water <= 0) reason = "Plasmolysis (Severe Dehydration)";
                else if (state.water >= 100) reason = "Cytolysis (Membrane Ruptured)";
            }

            let score = isWin ? Math.floor(state.atp + (100 - state.waste) + (100 - state.infection) - Math.abs(50 - state.water)*2) : 0;
            let rating = "F (Debris)";
            if (score >= 250) rating = "S+ (Master Biologist)";
            else if (score >= 200) rating = "A (Optimal Stability)";
            else if (score >= 150) rating = "B (Stable Environment)";
            else if (score >= 100) rating = "C (Functional Level)";
            else if (isWin) rating = "D (Barely Survived)";

            document.getElementById('end-title').innerText = title;
            document.getElementById('end-emoji').innerText = emoji;
            document.getElementById('end-reason').innerText = reason;
            document.getElementById('end-rating').innerText = `Survival Rating: ${rating}`;
            
            document.getElementById('end-title').style.color = isWin ? "var(--success-color)" : "var(--inf-color)";
            document.getElementById('end-rating').style.color = isWin ? "var(--atp-color)" : "var(--inf-color)";
            
            if (isWin) sfxWin(); else sfxWrong();
        }
    }

    // --- MINIGAME SYSTEM ---
    const mgData = {
        nucleus: { title: "Nucleus: DNA Repair", time: 25, hint: "Adenine (A) pairs with Thymine (T). Cytosine (C) pairs with Guanine (G).", init: initNucleus },
        mitochondria: { title: "Mitochondria: Generator", time: 30, hint: "Cellular Respiration needs 1 Glucose and 6 Oxygen to synthesize ATP.", init: initMito },
        ribosomes: { title: "Ribosomes: Protein Synthesis", time: 25, hint: "Ribosomes read mRNA instructions to string together amino acids into proteins.", init: initRibo },
        er: { title: "Rough E.R.: Transport Network", time: 25, hint: "The ER acts as a folded membrane highway to transport proteins. Build a path.", init: initER },
        golgi: { title: "Golgi Body: Packaging", time: 20, hint: "The Golgi packages items. Enzymes go to the Lysosome. Hormones are Exported.", init: initGolgi },
        lysosome: { title: "Lysosome: Waste Disposal", time: 20, hint: "Lysosomes digest waste and viruses. DO NOT digest healthy proteins (ü•©).", init: initLyso },
        membrane: { title: "Cell Membrane: Gateway", time: 30, hint: "Osmosis balances water toward salt. Active transport uses ATP for large molecules.", init: initMembrane }
    };

    function openGame(id) {
        if (!state.active || state.inMinigame) return;
        
        if (cooldowns[id] && Date.now() - cooldowns[id] < 6000) {
            flashScreen('rgba(255,255,255,0.2)'); return; 
        }
        
        sfxClick();
        state.inMinigame = true;
        activeGame = id;
        let game = mgData[id];
        
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('mg-title').innerText = game.title;
        
        let hintEl = document.getElementById('mg-hint');
        if (document.getElementById('teacher-hints').checked) {
            hintEl.style.display = 'block'; hintEl.innerText = "üë®‚Äçüè´ Teacher Hint: " + game.hint;
        } else { hintEl.style.display = 'none'; }
        
        mgTimeLeft = game.time;
        document.getElementById('mg-timer').innerText = mgTimeLeft + 's';
        
        game.init();
        
        mgTimer = setInterval(() => {
            mgTimeLeft--;
            document.getElementById('mg-timer').innerText = mgTimeLeft + 's';
            if (mgTimeLeft <= 0) abortMinigame(true);
        }, 1000);
    }

    function abortMinigame(isTimeout = false) {
        sfxWrong();
        state.atp = Math.max(0, state.atp - 5);
        endMinigame(false);
    }

    function endMinigame(success) {
        clearInterval(mgTimer);
        if (lysoInterval) clearInterval(lysoInterval);
        if (mitoInterval) clearInterval(mitoInterval);
        
        state.inMinigame = false;
        document.getElementById('modal').style.display = 'none';
        
        if (success) {
            flashScreen('rgba(6, 214, 160, 0.3)');
            sfxWin();
            
            // Rewards
            let id = activeGame;
            if (id === 'nucleus') { state.infection -= 25; state.waste -= 10; }
            if (id === 'mitochondria') { state.atp += 40; state.waste += 5; }
            if (id === 'ribosomes') { state.waste -= 15; state.infection -= 10; state.atp -= 5; }
            if (id === 'er') { state.waste -= 25; state.atp -= 5; }
            if (id === 'golgi') { state.waste -= 20; state.infection -= 10; state.atp -= 5; }
            if (id === 'lysosome') { state.waste -= 35; state.infection -= 25; state.atp -= 5; }
            if (id === 'membrane') { state.water = 50; state.infection -= 15; state.atp -= 5; }
            
            // Cooldowns
            let btn = document.getElementById('org-' + id);
            if (btn) {
                btn.classList.add('cooldown');
                cooldowns[id] = Date.now();
                setTimeout(() => btn.classList.remove('cooldown'), 6000);
            }
        } else {
            flashScreen('rgba(239, 71, 111, 0.3)');
            state.waste += 10;
        }
        
        updateUI();
        checkGameOver();
    }

    // --- INDIVIDUAL MINIGAMES ---

    // 1. Nucleus
    let nucTarget = '', nucScore = 0;
    const nucPairs = { 'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C' };
    function initNucleus() { nucScore = 0; renderNuc(); }
    function renderNuc() {
        nucTarget = ['A', 'T', 'C', 'G'][Math.floor(Math.random() * 4)];
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 25px;">Pair the DNA Base! (${nucScore}/5)</div>
            <div style="font-size: 5rem; margin-bottom: 30px; background: #000; padding: 20px 40px; border-radius: 20px; border: 3px solid var(--cell-membrane);">
                <span style="color: var(--cell-membrane)">${nucTarget}</span> ... <span style="color: var(--inf-color)">?</span>
            </div>
            <div style="display: flex; gap: 20px;">
                <button class="btn" style="background: #EF476F; width:80px; height:80px; font-size:2rem; padding:0;" onclick="checkNuc('A')">A</button>
                <button class="btn" style="background: #F77F00; width:80px; height:80px; font-size:2rem; padding:0;" onclick="checkNuc('T')">T</button>
                <button class="btn" style="background: #06D6A0; width:80px; height:80px; font-size:2rem; padding:0;" onclick="checkNuc('C')">C</button>
                <button class="btn" style="background: #118AB2; width:80px; height:80px; font-size:2rem; padding:0;" onclick="checkNuc('G')">G</button>
            </div>
        `;
    }
    window.checkNuc = function(base) {
        if (base === nucPairs[nucTarget]) { sfxCorrect(); nucScore++; if (nucScore >= 5) endMinigame(true); else renderNuc(); }
        else { sfxWrong(); mgTimeLeft -= 2; document.getElementById('mg-timer').innerText = mgTimeLeft + 's'; flashScreen('rgba(239, 71, 111, 0.3)'); }
    }

    // 2. Mitochondria
    let mitoGlu = 0, mitoOxy = 0, mitoATP = 0;
    function initMito() {
        mitoGlu = 0; mitoOxy = 0; mitoATP = 0;
        renderMitoUI();
        mitoInterval = setInterval(() => {
            if (!state.inMinigame) return clearInterval(mitoInterval);
            let area = document.getElementById('mito-drop-zone');
            if (!area) return;
            let type = Math.random() > 0.4 ? 'oxy' : 'glu';
            let el = document.createElement('div');
            el.className = 'falling-item'; el.innerText = type === 'oxy' ? 'ü´ß' : 'üç¨';
            el.style.left = (10 + Math.random() * 80) + '%';
            el.onmousedown = () => {
                sfxClick();
                if (type === 'oxy' && mitoOxy < 6) mitoOxy++;
                if (type === 'glu' && mitoGlu < 1) mitoGlu++;
                el.remove(); updateMitoStats();
            };
            area.appendChild(el);
            setTimeout(() => { if (el.parentNode) el.remove(); }, 2500);
        }, 400);
    }
    function renderMitoUI() {
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 10px;">Synthesize ATP (${mitoATP}/3)</div>
            <div id="mito-stats" style="font-size: 1.3rem; margin-bottom: 20px; color: var(--cell-membrane); font-weight: 900;">Glucose (üç¨): ${mitoGlu}/1 | Oxygen (ü´ß): ${mitoOxy}/6</div>
            <div id="mito-drop-zone" style="position: relative; width: 100%; height: 200px; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #334155; margin-bottom: 25px;"></div>
            <button id="btn-synth" class="btn" style="font-size: 1.5rem; padding: 15px 40px; background: #555; color: #000;" onclick="synthATP()" disabled>Synthesize ATP ‚ö°</button>
        `;
        updateMitoStats();
    }
    function updateMitoStats() {
        let statEl = document.getElementById('mito-stats');
        if(statEl) statEl.innerText = `Glucose (üç¨): ${mitoGlu}/1 | Oxygen (ü´ß): ${mitoOxy}/6`;
        let btn = document.getElementById('btn-synth');
        if(btn) {
            if (mitoGlu >= 1 && mitoOxy >= 6) { btn.disabled = false; btn.style.background = 'var(--atp-color)'; }
            else { btn.disabled = true; btn.style.background = '#555'; }
        }
    }
    window.synthATP = function() {
        sfxCorrect(); mitoGlu = 0; mitoOxy = 0; mitoATP++;
        if (mitoATP >= 3) { clearInterval(mitoInterval); endMinigame(true); } else updateMitoStats();
    }

    // 3. Ribosomes
    let riboTarget = [], riboStep = 0;
    const riboColors = ['#EF476F', '#06D6A0', '#118AB2', '#FFD166'];
    function initRibo() {
        riboTarget = []; for(let i=0; i<4; i++) riboTarget.push(riboColors[Math.floor(Math.random()*4)]);
        riboStep = 0; renderRibo();
    }
    function renderRibo() {
        let dots = riboTarget.map((c, i) => `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${c}; opacity: ${i < riboStep ? 1 : 0.3}; border: ${i === riboStep ? '4px solid white' : 'none'}; transform: ${i === riboStep ? 'scale(1.2)' : 'scale(1)'}; transition: all 0.2s;"></div>`).join('');
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 25px;">Match the mRNA Sequence!</div>
            <div style="display: flex; gap: 20px; margin-bottom: 40px; background: #000; padding: 25px 40px; border-radius: 25px; border: 3px solid #334155;">${dots}</div>
            <div style="display: flex; gap: 20px;">
                ${riboColors.map(c => `<button class="btn" style="width: 80px; height: 80px; border-radius: 50%; padding: 0; background: ${c};" onclick="checkRibo('${c}')"></button>`).join('')}
            </div>
        `;
    }
    window.checkRibo = function(c) {
        if (c === riboTarget[riboStep]) { sfxCorrect(); riboStep++; if (riboStep >= 4) endMinigame(true); else renderRibo(); }
        else { sfxWrong(); riboStep = 0; renderRibo(); flashScreen('rgba(239, 71, 111, 0.3)'); }
    }

    // 4. Rough ER
    let erPos = 0;
    function initER() { erPos = 0; renderER(); }
    function renderER() {
        let cells = "";
        for(let i=0; i<9; i++) {
            let content = "";
            if (i === erPos) content = "üîµ"; else if (i === 8) content = "üèÅ";
            cells += `<div class="er-cell" onclick="moveER(${i})">${content}</div>`;
        }
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 25px;">Guide the Protein out of the ER!</div>
            <div class="er-grid">${cells}</div>
        `;
    }
    window.moveER = function(i) {
        let validMoves = [erPos-1, erPos+1, erPos-3, erPos+3];
        if (erPos%3 === 0) validMoves = validMoves.filter(m => m !== erPos-1);
        if (erPos%3 === 2) validMoves = validMoves.filter(m => m !== erPos+1);
        let isWall = [2, 3, 6].includes(i); 

        if (validMoves.includes(i) && !isWall) {
            sfxClick(); erPos = i;
            if (erPos === 8) { sfxCorrect(); endMinigame(true); } else renderER();
        } else {
            sfxWrong(); mgTimeLeft -= 2; document.getElementById('mg-timer').innerText = mgTimeLeft + 's'; flashScreen('rgba(239, 71, 111, 0.3)');
        }
    }

    // 5. Golgi
    let golgiItems = [ { name: "Digestive Enzyme", dest: "lys", icon: "üî•" }, { name: "Waste Material", dest: "lys", icon: "üóëÔ∏è" }, { name: "Growth Hormone", dest: "exp", icon: "‚úâÔ∏è" }, { name: "Antibody", dest: "exp", icon: "üõ°Ô∏è" } ];
    let golgiScore = 0, curGolgi = null;
    function initGolgi() { golgiScore = 0; renderGolgi(); }
    function renderGolgi() {
        curGolgi = golgiItems[Math.floor(Math.random() * golgiItems.length)];
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 20px;">Sort & Package (${golgiScore}/4)</div>
            <div style="font-size: 5rem; margin-bottom: 10px; animation: breathe 1.5s infinite alternate ease-in-out;">${curGolgi.icon}</div>
            <div style="font-size: 1.8rem; font-weight: 900; margin-bottom: 40px; color: var(--cell-membrane);">${curGolgi.name}</div>
            <div style="display: flex; gap: 30px; width: 100%; justify-content: center;">
                <button class="btn" style="background: var(--waste-color); padding: 20px 30px; font-size: 1.3rem;" onclick="sortGolgi('lys')">To Lysosome</button>
                <button class="btn" style="background: #9D4EDD; color: white; padding: 20px 30px; font-size: 1.3rem;" onclick="sortGolgi('exp')">Export Outside</button>
            </div>
        `;
    }
    window.sortGolgi = function(dest) {
        if (dest === curGolgi.dest) { sfxCorrect(); golgiScore++; if (golgiScore >= 4) endMinigame(true); else renderGolgi(); }
        else { sfxWrong(); mgTimeLeft -= 3; document.getElementById('mg-timer').innerText = mgTimeLeft + 's'; flashScreen('rgba(239, 71, 111, 0.3)'); }
    }

    // 6. Lysosome
    let lysoScore = 0;
    function initLyso() {
        lysoScore = 0;
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 10px;">Digest the Waste! (<span id="lyso-score-span">0</span>/8)</div>
            <div style="font-size: 1.1rem; color: #aaa; margin-bottom: 20px; font-weight: bold;">DO NOT click the healthy proteins (ü•©)!</div>
            <div id="lyso-box" style="width: 100%; height: 280px; background: #000; border-radius: 20px; position: relative; overflow: hidden; border: 4px solid var(--cell-membrane);"></div>
        `;
        
        lysoInterval = setInterval(() => {
            if (!state.inMinigame) return clearInterval(lysoInterval);
            let box = document.getElementById('lyso-box');
            let el = document.createElement('div');
            let isBad = Math.random() > 0.3;
            el.innerText = isBad ? (Math.random() > 0.5 ? 'ü¶†' : 'üóëÔ∏è') : 'ü•©';
            el.style.cssText = `position: absolute; font-size: 4rem; cursor: pointer; left: ${10+Math.random()*70}%; top: ${10+Math.random()*60}%; animation: fadeIn 0.1s ease-out;`;
            
            el.onmousedown = () => {
                el.remove();
                if (isBad) {
                    sfxClick(); lysoScore++;
                    document.getElementById('lyso-score-span').innerText = lysoScore;
                    if (lysoScore >= 8) { clearInterval(lysoInterval); sfxCorrect(); endMinigame(true); }
                } else { sfxWrong(); mgTimeLeft -= 3; document.getElementById('mg-timer').innerText = mgTimeLeft + 's'; flashScreen('rgba(239, 71, 111, 0.3)'); }
            };
            box.appendChild(el);
            setTimeout(() => { if (el.parentNode) el.remove(); }, 1100);
        }, 600);
    }

    // 7. Cell Membrane
    let memQuestions = [
        { q: "Cell is in pure water. Which way does water move?", ans: 0, opts: ["Into the cell (Osmosis)", "Out of the cell (Osmosis)"] },
        { q: "How do massive glucose molecules enter?", ans: 1, opts: ["Simple Diffusion", "Carrier Protein Channel"] },
        { q: "How do small oxygen molecules enter?", ans: 0, opts: ["Simple Diffusion", "Active Transport Pump"] },
        { q: "The cell needs to expel waste AGAINST the concentration gradient.", ans: 1, opts: ["Osmosis (Passive)", "Active Transport (Uses ATP)"] }
    ];
    let memCur = 0;
    function initMembrane() { memQuestions.sort(() => Math.random() - 0.5); memCur = 0; renderMembrane(); }
    function renderMembrane() {
        let q = memQuestions[memCur];
        document.getElementById('mg-area').innerHTML = `
            <div style="font-size: 1.2rem; font-weight: 900; margin-bottom: 10px; color: #aaa;">Question ${memCur+1} of 3</div>
            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 40px; color: var(--cell-membrane); padding: 0 20px; line-height: 1.5;">${q.q}</div>
            <div style="display: flex; flex-direction: column; gap: 20px; width: 90%;">
                <button class="btn" style="background: #1e293b; color: white; padding: 20px; font-size: 1.2rem;" onclick="checkMem(0)">${q.opts[0]}</button>
                <button class="btn" style="background: #1e293b; color: white; padding: 20px; font-size: 1.2rem;" onclick="checkMem(1)">${q.opts[1]}</button>
            </div>
        `;
    }
    window.checkMem = function(ans) {
        if (ans === memQuestions[memCur].ans) { sfxCorrect(); memCur++; if (memCur >= 3) endMinigame(true); else renderMembrane(); }
        else { sfxWrong(); mgTimeLeft -= 5; document.getElementById('mg-timer').innerText = mgTimeLeft + 's'; flashScreen('rgba(239, 71, 111, 0.3)'); }
    }

</script>
</body>
</html>
