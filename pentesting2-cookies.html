<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Skin Emporium - Security Demo v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Font */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Source Sans Pro', sans-serif;
            line-height: 1.6;
            background: #1a1a2e; /* Dark blueish background */
            color: #e0e1dd; /* Light grey text */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Container */
        .container { max-width: 1100px; margin: 25px auto; padding: 0 20px; flex-grow: 1; }

        /* Header */
        header {
            background-color: #0f3460; /* Darker blue header */
            color: #e94560; /* Accent pink/red */
            padding: 1rem 0;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 4px solid #e94560;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        header h1 {
            font-family: 'Press Start 2P', cursive; /* Pixel font */
            margin-bottom: 0;
            font-size: 1.8em;
            color: #ffffff;
            text-shadow: 2px 2px #e94560;
        }

        /* Navigation */
        nav {
            background: #16213e; /* Even darker blue */
            padding: 0.9rem 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        nav ul { list-style: none; text-align: center; }
        nav ul li { display: inline; margin: 0 15px; }
        nav ul li a {
            color: #a8dadc; /* Light cyan links */
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-weight: 600;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        nav ul li a:hover, nav ul li a.active { background-color: #e94560; color: #fff; }
        nav ul li a#nav-logout,
        nav ul li a#nav-admin,
        nav ul li a#nav-inventory,
        nav ul li a#nav-send,
        nav ul li a#nav-payment { display: none; } /* Initially hidden logged-in links */
        #nav-super-admin-link { display: none; } /* Hidden Super Admin link */

        /* Content Sections */
        .content-section {
            background: #1f4068; /* Medium blue content background */
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid #3a6088; /* Lighter border */
            display: none; /* Hide all sections by default */
        }
        #home { display: block; } /* Show home section initially */

        .content-section h2, .content-section h1 {
            font-family: 'Press Start 2P', cursive;
            color: #e94560; /* Accent pink */
            margin-bottom: 25px;
            border-bottom: 2px solid #a8dadc; /* Cyan border */
            padding-bottom: 12px;
            font-size: 1.5em;
            text-shadow: 1px 1px #16213e;
        }
        #super-admin { /* VULNERABILITY: Hidden via CSS */ }

        /* Forms & Buttons */
        form label { display: block; margin-bottom: 8px; font-weight: 700; color: #a8dadc; font-size: 0.95em; }
        form input[type="text"], form input[type="password"], form input[type="number"], form select {
            width: 100%; padding: 12px 15px; margin-bottom: 20px;
            border: 1px solid #3a6088; background-color: #16213e; color: #e0e1dd;
            border-radius: 4px; font-size: 1em; font-family: 'Source Sans Pro', sans-serif;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        form input[type="text"]:focus, form input[type="password"]:focus, form input[type="number"]:focus, form select:focus {
             border-color: #a8dadc; outline: 0; box-shadow: 0 0 0 0.2rem rgba(168, 218, 220, 0.25);
        }
        button, input[type="submit"] {
            display: inline-block; background: #e94560; color: #fff; border: none;
            padding: 12px 25px; cursor: pointer; border-radius: 4px; font-size: 1em;
            font-weight: 700; transition: background-color 0.3s ease, transform 0.1s ease;
            text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover, input[type="submit"]:hover { background: #c73850; transform: translateY(-1px); }
        button:active, input[type="submit"]:active { transform: translateY(0px); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
        button.secondary { background: #5dade2; } /* Light blue secondary */
        button.secondary:hover { background: #3498db; }
        button:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Message Output / Info Boxes */
        #status-message, .info-box, .vulnerability-note, .localstorage-note, #xss-output-unsafe, .explanation-box {
            margin-top: 20px; padding: 15px 20px; border-left-width: 5px; border-left-style: solid;
            background-color: #16213e; border-radius: 5px; word-wrap: break-word; font-size: 0.95em;
            border: 1px solid #3a6088;
        }
        .info-box { border-left-color: #5dade2; background-color: #1f2c4a; }
        .vulnerability-note { border-left-color: #f1c40f; background-color: #3b3f0a; color: #f1c40f; } /* Yellow */
        .localstorage-note { border-left-color: #e94560; background-color: #3a1f3f; color: #e94560; } /* Pink/Red */
        .explanation-box { border-left-color: #9b59b6; background-color: #2c1f3a; color: #bdc3c7; } /* Purple */
        .vulnerability-note strong, .localstorage-note strong, .explanation-box strong { color: #ffffff; }
        #status-message { border-left-color: #5dade2; display: none; } /* Hide initially */
        #status-message.error { border-left-color: #e74c3c; background-color: #4a1f2b; color: #e74c3c; } /* Red error */
        #status-message.success { border-left-color: #2ecc71; background-color: #1f4a3a; color: #2ecc71; } /* Green success */
        #xss-output-unsafe { border-left-color: #f1c40f; background-color: #3b3f0a; color: #f1c40f; margin-top: 10px; }
         #xss-output-unsafe h4 { color: #fff; }
         code { background-color: #3a6088; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #a8dadc; }
         pre { background-color: #16213e; padding: 10px; border-radius: 4px; border: 1px solid #3a6088; overflow-x: auto; }


        /* Item/Skin Display Grids */
        .item-grid, .skin-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .item-card, .skin-card {
            background: #16213e; border: 1px solid #3a6088; border-radius: 6px; padding: 15px;
            text-align: center; transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .item-card:hover, .skin-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
        .item-card img, .skin-card img { max-width: 100%; height: 120px; object-fit: contain; margin-bottom: 10px; background-color: #3a6088; border-radius: 4px; padding: 5px; }
        .item-card h3, .skin-card h3 { font-family: 'Source Sans Pro', sans-serif; color: #a8dadc; font-size: 1.1em; margin: 10px 0 5px 0; }
        .item-card p, .skin-card p { font-size: 0.9em; color: #e0e1dd; margin-bottom: 10px; flex-grow: 1; }
        .item-card .price { font-weight: bold; color: #2ecc71; font-size: 1.2em; margin-bottom: 15px; }
        .item-card .price::before { content: 'R$ '; } /* Robux symbol */
        .item-card button { width: 100%; font-size: 0.9em; padding: 8px 15px; }

        /* Inventory & Admin Lists */
        .inventory-list-ul, .user-list { list-style: none; margin-top: 15px; padding: 0; }
        .inventory-list-ul li, .user-list li {
            background: #16213e; padding: 12px 18px; border: 1px solid #3a6088;
            border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; /* Allow wrap on small screens */
            gap: 10px;
        }
        .user-list li span:nth-child(3) { color: #f1c40f; font-family: monospace; } /* Ciphered Password */
        .inventory-list-ul .item-info { display: flex; align-items: center; gap: 15px; }
        .inventory-list-ul img { width: 40px; height: 40px; object-fit: contain; background: #3a6088; border-radius: 3px; }
        .user-list button { padding: 4px 10px; font-size: 0.85em; }

        /* Footer */
        footer {
            text-align: center; margin-top: 40px; padding: 25px; background: #0f3460;
            color: #a8dadc; font-size: 0.9em; border-top: 3px solid #e94560;
        }
        footer p { margin: 5px 0; } footer strong { color: #ffffff; }
    </style>
</head>
<body>

    <header>
        <h1>Roblox Skin Emporium</h1>
    </header>

    <div class="container">
        <nav>
            <ul>
                <li><a href="#home" class="nav-link active">Home</a></li>
                <li><a href="#marketplace" class="nav-link">Marketplace</a></li>
                <li><a href="#login" class="nav-link" id="nav-login">Login</a></li>
                <!-- Logged In Links -->
                <li><a href="#inventory" class="nav-link" id="nav-inventory">Inventory</a></li>
                <li><a href="#payment" class="nav-link" id="nav-payment">Payment Page</a></li>
                <li><a href="#send" class="nav-link" id="nav-send">Send Assets</a></li>
                <li><a href="#admin" class="nav-link" id="nav-admin">Admin Panel</a></li>
                <li><a href="#super-admin" class="nav-link" id="nav-super-admin-link">Super Admin (Hidden)</a></li>
                <li><a href="#" class="nav-link" id="nav-logout">Logout</a></li>
            </ul>
        </nav>

        <!-- Status Message Area -->
        <div id="status-message"></div>

        <!-- Home Section -->
        <div id="home" class="content-section">
            <h2>Welcome, Robloxian!</h2>
            <p>Explore the marketplace, manage your (simulated) Robux and skins, and learn about web security!</p>
            <p>This site uses <strong>your browser's Local Storage</strong> to simulate your account balance and inventory. This is <strong>highly insecure</strong> for real applications but useful for learning!</p>

             <!-- <div class="localstorage-note">
                <strong>TEACHING POINT: Insecure Client-Side Storage</strong><br>
                Press F12 to open Developer Tools, go to the "Application" (or "Storage") tab, and look under "Local Storage". You'll find keys like <code>robloxUsers</code>, <code>robloxItems</code>, and potentially your own <code>currentUser</code> info after logging in.
                <ul>
                    <li>Notice user passwords within <code>robloxUsers</code> are 'encrypted' (Caesar cipher). We'll discuss how weak this is!</li>
                    <li>If logged in, find the <code>currentUser</code> entry. You can directly edit your <code>robuxBalance</code> or add/remove item IDs from your <code>inventory</code> array right here! Refresh the page to see the changes. (See Payment page for a special User ID trick!)</li>
                </ul>
                This demonstrates why sensitive data should NEVER be stored or trusted directly on the client-side. Real applications manage balances and inventories securely on a server.
            </div>
             <div class="explanation-box">
                 <strong>TEACHING POINT: Weak Encryption (Caesar Cipher)</strong><br>
                 The passwords in Local Storage look scrambled, right? They've been "encrypted" using a Caesar Cipher (a simple letter shift). Why is this bad?
                 <ul>
                     <li><strong>Very Easy to Break:</strong> There are only 25 possible shifts. You could try them all by hand or write a simple script to decode it instantly (frequency analysis also works).</li>
                     <li><strong>Not Real Encryption:</strong> This is more like obfuscation (hiding). Real encryption uses complex mathematical algorithms and keys.</li>
                     <li><strong>Demonstrates a Principle:</strong> Even if data *looks* encrypted, if the method is weak or the key is easily found (in this case, the shift amount is constant and implied), it offers almost no real security.</li>
                 </ul>
                 You can see the ciphered passwords in the Admin Panel if you log in as <code>admin</code>. The login process simply applies the same cipher to your input before comparing.
             </div>
             <div class="vulnerability-note">
                 <strong>VULNERABILITY NOTE: Hidden Super Admin Panel</strong><br>
                 There's a "Super Admin" panel hidden with CSS. Find the link in the navigation bar HTML (Inspect Element) and the section div with <code>id="super-admin"</code>. Use the Developer Tools 'Styles' panel to make them visible. Accessing the panel itself requires a specific, hidden browser cookie... can you find what it needs?
            </div> -->
        </div>

        <!-- Marketplace Section -->
        <div id="marketplace" class="content-section">
            <h2>Marketplace</h2>
            <p>Browse available skins and items. Buying items will deduct Robux from your (locally stored) balance.</p>
            <div id="item-listing" class="item-grid">
                <!-- Items dynamically loaded by JS -->
                 <p>Loading items...</p>
            </div>
             <div class="vulnerability-note" style="margin-top: 25px;">
                 <strong>XSS DEMO AREA: Item Search (Unsafe)</strong><br>
                 <label for="item-search">Search Items:</label>
                 <input type="text" id="item-search" placeholder="Try searching for: <img src=x onerror=alert('XSS!')>" style="margin-bottom: 10px;">
                 <div id="xss-output-unsafe" style="display: none;">
                     <h4>Unsafe Search Result Display:</h4>
                     <p><small>Input rendered here using <code>innerHTML</code> without sanitization.</small></p>
                     <div id="unsafe-search-content" style="border: 1px dashed #f1c40f; padding: 10px; margin-top: 5px; background: #16213e;"></div>
                 </div>
             </div>
        </div>

        <!-- Login Section -->
        <div id="login" class="content-section">
            <h1>Login</h1>
            <p><em>(Uses insecure client-side checks & weak Caesar cipher 'encryption' for passwords stored in Local Storage)</em></p>
            <form id="login-form">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required autocomplete="username">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
                <input type="submit" value="Login">
            </form>
             <div class="info-box" style="margin-top: 25px;">
                <p style="font-weight: bold; color: #5dade2;">Hints & Security Notes:</p>
                 <ul>
                     <li>Default admin: <code>admin</code> / <code>adminpass</code></li>
                     <li>Standard user: <code>player1</code> / <code>password123</code></li>
                     <li>Check Local Storage (<code>robloxUsers</code>) for more accounts. The passwords are Caesar-ciphered (shift 3). Can you decode them?</li>
                     <li>Login works by ciphering *your input* and comparing it to the stored ciphered text.</li>
                     <li>You can still modify the <code>isAdmin</code> flag in Local Storage for a user to escalate privileges.</li>
                 </ul>
             </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <h1>My Inventory</h1>
            <p>Your current (simulated) balance and owned items.</p>
            <div class="info-box">
                Current Balance: <strong>R$ <span id="inventory-balance">0</span></strong>
                 | User ID: <strong id="inventory-userid">N/A</strong>
            </div>
            <h3>Owned Skins/Items:</h3>
            <ul id="inventory-list" class="inventory-list-ul">
                <!-- Items dynamically loaded by JS -->
                <li>No items yet. Buy some from the marketplace!</li>
            </ul>
            <!-- <div class="localstorage-note" style="margin-top: 25px;">
                <strong>REMINDER: Manipulate Your Assets!</strong><br>
                Go to DevTools (F12) -> Application -> Local Storage. Find the <code>currentUser</code> key. Edit your <code>robuxBalance</code> or add/remove item IDs (like <code>SKN001</code>, <code>HAT002</code>) to the <code>inventory</code> array. Refresh this page to see your changes instantly! (Try changing your <code>userId</code> too for the Payment Page trick).
            </div> -->
        </div>

        <!-- Payment Page Section -->
        <div id="payment" class="content-section">
             <h1>Payment Confirmation</h1>
             <p>Review the items associated with your account session below.</p>
             <div id="payment-skins-list" class="skin-list">
                 <!-- Skins loaded by JS based on currentUser inventory OR userId 5 -->
                 <p>Loading items...</p>
             </div>
             <!-- <div class="vulnerability-note" style="margin-top: 25px;">
                 <strong>VULNERABILITY: Broken Access Control (Client-Side Trust)</strong><br>
                 This page normally shows *your* skins from your <code>currentUser</code> data in Local Storage. However, there's a flaw!
                 <ol>
                     <li>Open Developer Tools (F12) -> Application -> Local Storage.</li>
                     <li>Find the <code>currentUser</code> key.</li>
                     <li>Edit the JSON data: Change the value of <code>userId</code> to exactly <code>5</code>.</li>
                     <li>Save the changes in DevTools and <strong>refresh this page</strong>.</li>
                 </ol>
                 If your <code>userId</code> is <code>5</code>, this page incorrectly trusts that value and shows you *ALL* available skins, not just yours! This demonstrates trusting client-controlled data for authorization checks. Real systems must *always* verify ownership on the server based on a secure session, not just a user ID the client can change.
             </div> -->
        </div>


        <!-- Send Assets Section -->
        <div id="send" class="content-section">
            <h1>Send Assets (Simulated)</h1>
            <p>Send Robux or an item to another user. This simulation <strong>only deducts from your local storage</strong> and logs the attempt. It doesn't actually transfer to the recipient (that needs a server).</p>
            <form id="send-robux-form">
                <h3>Send Robux</h3>
                <label for="send-robux-recipient">Recipient Username:</label>
                <input type="text" id="send-robux-recipient" required>
                <label for="send-robux-amount">Amount (R$):</label>
                <input type="number" id="send-robux-amount" min="1" required>
                <button type="submit">Send Robux</button>
            </form>
            <hr style="margin: 30px 0; border-color: #3a6088;">
            <form id="send-item-form">
                <h3>Send Item</h3>
                <label for="send-item-recipient">Recipient Username:</label>
                <input type="text" id="send-item-recipient" required>
                <label for="send-item-id">Item ID to Send (from your inventory):</label>
                <input type="text" id="send-item-id" placeholder="e.g., SKN001" required>
                <button type="submit">Send Item</button>
            </form>
             <!-- <div class="vulnerability-note" style="margin-top: 25px;">
                 <strong>TEACHING POINT: Client-Side Logic Limitations & Potential Abuse</strong><br>
                 Notice how this form only interacts with *your* data in Local Storage.
                 <ul>
                    <li><strong>No Validation:</strong> There's no check if the recipient username actually exists.</li>
                    <li><strong>No Server:</strong> Without a server, the recipient never receives anything.</li>
                    <li><strong>Manipulation Risk:</strong> A user could modify the JavaScript code in DevTools *before* submitting to bypass checks (e.g., prevent Robux deduction).</li>
                 </ul>
             </div> -->
        </div>

        <!-- Admin Panel Section -->
        <div id="admin" class="content-section">
            <h1>Admin Panel</h1>
            <div id="admin-content">
                 <!-- Content dynamically loaded by JS -->
                 <p>Loading admin data...</p>
            </div>
        </div>

        <!-- Super Admin Panel Section (Hidden by CSS, requires cookie) -->
        <div id="super-admin" class="content-section">
            <h1><span style="color: #f1c40f;">ðŸ‘‘</span> Super Admin Panel <span style="color: #f1c40f;">ðŸ‘‘</span></h1>
            <div id="super-admin-content">
                <!-- Content dynamically loaded by JS after cookie check -->
                <p>Checking authorization...</p>
            </div>
             <div class="vulnerability-note" style="margin-top: 25px;">
                <strong>VULNERABILITY NOTE: Cookie-Based Access Control</strong><br>
                Access to this panel is restricted based on a browser cookie.
                <ol>
                    <li>Ensure this section is visible (you may need to edit CSS via DevTools if it's hidden).</li>
                    <li>Open Developer Tools (F12).</li>
                    <li>Go to the "Application" (or "Storage") tab, then find "Cookies" for this site.</li>
                    <li>You need to create or modify a cookie with the correct Name and Value. What could they be? Inspect the site's code or experiment!</li>
                    <li>Once the correct cookie is set, refresh the page to gain access.</li>
                </ol>
                This demonstrates weak access control relying solely on a predictable or stealable client-side cookie. Real systems use secure, server-validated session tokens (often in HttpOnly cookies).
             </div>
        </div>

    </div> <!-- /container -->

    <footer>
        <p>Â© 2024 <strong>Roblox Skin Emporium</strong> - Educational Security Demo v2</p>
        <p>This site uses <strong>intentional vulnerabilities</strong> for teaching. Do not replicate these flaws!</p>
    </footer>

    <script>
        // --- Constants and State ---
        const USERS_STORAGE_KEY = 'robloxUsers';
        const ITEMS_STORAGE_KEY = 'robloxItems';
        const CURRENT_USER_STORAGE_KEY = 'currentUser'; // Stores { username, userId, robuxBalance, inventory: [], isAdmin }
        const SUPER_ADMIN_COOKIE_NAME = 'superuser_session';
        const SUPER_ADMIN_COOKIE_VALUE = 'SECRET_KEY_123!'; // The "secret" value students need to find
        const CAESAR_SHIFT = 3; // Shift value for the cipher

        let allItems = []; // Cache of all available items

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupNavigationAndRouting();
            setupEventListeners();
            handleUrlChange(); // Handle initial load
        });

        window.addEventListener('hashchange', handleUrlChange);

        function initializeApp() {
            // Initialize items if not present
            if (!localStorage.getItem(ITEMS_STORAGE_KEY)) {
                const defaultItems = generateInitialItems();
                localStorage.setItem(ITEMS_STORAGE_KEY, JSON.stringify(defaultItems));
                console.log("Initialized default items in localStorage.");
            }
            try {
                 allItems = JSON.parse(localStorage.getItem(ITEMS_STORAGE_KEY) || '[]');
            } catch (e) {
                 console.error("Failed to parse items from localStorage:", e);
                 allItems = [];
            }


            // Initialize users if not present
            if (!localStorage.getItem(USERS_STORAGE_KEY)) {
                const defaultUsers = generateInitialUsers();
                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(defaultUsers));
                console.log("Initialized default users (with Caesar cipher passwords) in localStorage.");
            }
            clearStatusMessage();
            updateUIBasedOnLogin(); // Reflect login state from localStorage if page reloaded
        }

        // --- Caesar Cipher ---
        function caesarCipher(str, shift) {
            // Ensure shift is within 0-25 range
            const s = shift % 26;
            if (s === 0) return str; // No shift needed

            return str.split('').map(char => {
                const code = char.charCodeAt(0);
                // Uppercase letters
                if (code >= 65 && code <= 90) {
                    return String.fromCharCode(((code - 65 + s) % 26) + 65);
                }
                // Lowercase letters
                if (code >= 97 && code <= 122) {
                    return String.fromCharCode(((code - 97 + s) % 26) + 97);
                }
                // Other characters (numbers, symbols) remain unchanged
                return char;
            }).join('');
        }

        // --- Data Generation ---
        function generateInitialItems() {
             // Same items as before...
             return [
                 { id: 'SKN001', name: 'Neon Ninja', description: 'A flashy ninja outfit.', price: 1500, imageUrl: 'https://via.placeholder.com/150/00FFFF/000000?text=NeonNinja' },
                 { id: 'SKN002', name: 'Space Explorer', description: 'Ready for cosmic adventures.', price: 1200, imageUrl: 'https://via.placeholder.com/150/C0C0C0/000000?text=SpaceSuit' },
                 { id: 'HAT001', name: 'Dominus Aureus', description: 'A classic golden Dominus.', price: 10000, imageUrl: 'https://via.placeholder.com/150/FFD700/000000?text=Dominus' },
                 { id: 'HAT002', name: 'Red Baseball Cap', description: 'Just a simple cap.', price: 50, imageUrl: 'https://via.placeholder.com/150/FF0000/FFFFFF?text=Cap' },
                 { id: 'GEAR001', name: 'Gravity Coil', description: 'Jump higher!', price: 750, imageUrl: 'https://via.placeholder.com/150/800080/FFFFFF?text=Coil' },
                 { id: 'FACE001', name: ':)', description: 'Classic smiley face.', price: 100, imageUrl: 'https://via.placeholder.com/150/FFFF00/000000?text=:)' }
             ];
        }

        function generateInitialUsers() {
             let userIdCounter = 1;
             // SECURITY TEACHING POINT: Passwords are now Caesar-ciphered
             return [
                 { userId: userIdCounter++, username: 'admin', password: caesarCipher('adminpass', CAESAR_SHIFT), robuxBalance: 5000, inventory: ['HAT001'], isAdmin: true },
                 { userId: userIdCounter++, username: 'player1', password: caesarCipher('password123', CAESAR_SHIFT), robuxBalance: 250, inventory: ['HAT002', 'FACE001'], isAdmin: false },
                 { userId: userIdCounter++, username: 'noobmaster69', password: caesarCipher('password', CAESAR_SHIFT), robuxBalance: 10, inventory: [], isAdmin: false },
                 { userId: userIdCounter++, username: 'richenjoyer', password: caesarCipher('moneybags', CAESAR_SHIFT), robuxBalance: 50000, inventory: ['SKN001', 'SKN002', 'HAT001', 'GEAR001'], isAdmin: false },
                 { userId: userIdCounter++, username: 'tester', password: caesarCipher('test', CAESAR_SHIFT), robuxBalance: 1000, inventory: [], isAdmin: false } // NOTE: This user gets ID 5 for the vulnerability demo!
             ];
        }


        // --- LocalStorage Accessors ---
        function getUsers() {
            try {
                const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
                return usersJson ? JSON.parse(usersJson) : [];
            } catch (e) { console.error("Error reading users:", e); setStatusMessage("Error loading user data.", "error", 0); return []; }
        }

        function saveUsers(users) {
            try { localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users)); }
            catch (e) { console.error("Error saving users:", e); setStatusMessage("Error saving user data.", "error", 0); }
        }

        function getCurrentUser() {
            try {
                const userJson = localStorage.getItem(CURRENT_USER_STORAGE_KEY);
                return userJson ? JSON.parse(userJson) : null;
            } catch (e) { console.error("Error reading current user:", e); localStorage.removeItem(CURRENT_USER_STORAGE_KEY); return null; }
        }

        function saveCurrentUser(user) {
             if (user) {
                 try { localStorage.setItem(CURRENT_USER_STORAGE_KEY, JSON.stringify(user)); }
                 catch (e) { console.error("Error saving current user:", e); setStatusMessage("Error saving session.", "error", 0); }
             } else {
                 localStorage.removeItem(CURRENT_USER_STORAGE_KEY);
             }
        }

        function getItemById(itemId) {
            // Ensure allItems is an array before searching
             if (!Array.isArray(allItems)) {
                 console.error("allItems is not an array:", allItems);
                 return undefined; // or null
             }
            return allItems.find(item => item && item.id === itemId);
        }

        // --- Authentication ---
        function handleLogin(event) {
            event.preventDefault();
            clearStatusMessage();
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const username = usernameInput.value.trim();
            const password = passwordInput.value; // Raw password input

            if (!username || !password) {
                setStatusMessage("Username and password required.", "error"); return;
            }

            const users = getUsers();
            // VULNERABILITY: Apply Caesar cipher to input before comparison
            const cipheredPasswordInput = caesarCipher(password, CAESAR_SHIFT);

            const foundUser = users.find(u => u.username === username && u.password === cipheredPasswordInput);

            if (foundUser) {
                // Create session object including userId
                const currentUserData = {
                    username: foundUser.username,
                    userId: foundUser.userId, // Store the user ID
                    robuxBalance: foundUser.robuxBalance,
                    inventory: foundUser.inventory || [],
                    isAdmin: foundUser.isAdmin || false
                };
                saveCurrentUser(currentUserData);
                setStatusMessage(`Login successful! Welcome, ${username}!`, "success");
                updateUIBasedOnLogin();
                 usernameInput.value = ''; // Clear username field
                 passwordInput.value = ''; // Clear password field
                window.location.hash = '#inventory'; // Redirect to inventory after login
            } else {
                setStatusMessage("Invalid username or password.", "error");
                saveCurrentUser(null); // Clear current user on failed login
                updateUIBasedOnLogin();
                passwordInput.value = ''; // Clear password field but keep username
            }
        }

        function handleLogout() {
             const user = getCurrentUser();
             if (user) setStatusMessage(`User ${user.username} logged out.`, "success");
             saveCurrentUser(null);
             updateUIBasedOnLogin();
             window.location.hash = '#home';
        }

        // --- UI Updates & Routing ---
        function updateUIBasedOnLogin() {
            const currentUser = getCurrentUser();
            const loggedIn = !!currentUser;
            const isAdmin = currentUser?.isAdmin || false;

            // Toggle visibility based on login status
            document.getElementById('nav-login').style.display = loggedIn ? 'none' : 'inline';
            document.getElementById('nav-logout').style.display = loggedIn ? 'inline' : 'none';
            document.getElementById('nav-inventory').style.display = loggedIn ? 'inline' : 'none';
            document.getElementById('nav-payment').style.display = loggedIn ? 'inline' : 'none'; // Show payment link when logged in
            document.getElementById('nav-send').style.display = loggedIn ? 'inline' : 'none';
            document.getElementById('nav-admin').style.display = loggedIn && isAdmin ? 'inline' : 'none';

            // Note: Super Admin link remains controlled by CSS and manual reveal for the demo
        }

        function setupNavigationAndRouting() {
            document.querySelector('nav').addEventListener('click', (event) => {
                const targetLink = event.target.closest('a.nav-link');
                if (!targetLink) return;

                if (targetLink.id === 'nav-logout') {
                    event.preventDefault();
                    handleLogout();
                }
                // Allow hashchange event to handle routing for other links
            });
        }

        function handleUrlChange() {
            // Default to home if hash is missing or empty
            const hash = window.location.hash.substring(1) || 'home';
            let sectionId = hash;

            // Basic validation if the element exists
            if (!document.getElementById(sectionId)) {
                sectionId = 'home'; // Fallback to home
            }

            // Access Control Checks (Client-Side - Insecure!)
            const currentUser = getCurrentUser();
             const requiresLogin = ['inventory', 'payment', 'send', 'admin', 'super-admin'];
             const requiresAdmin = ['admin', 'super-admin']; // Super-admin also requires cookie check later

            if (requiresLogin.includes(sectionId) && !currentUser) {
                 setStatusMessage("Please log in first.", "error");
                 window.location.hash = '#login'; // Redirect
                 // Need to manually show login section if redirect happens before initial render
                 showSection('login');
                 updateActiveNavLink('login');
                 return; // Stop further processing
             }

             if (requiresAdmin.includes(sectionId) && !currentUser?.isAdmin) {
                 setStatusMessage("Admin access required.", "error");
                 window.location.hash = '#inventory'; // Redirect non-admins away
                 showSection('inventory');
                 updateActiveNavLink('inventory');
                 return; // Stop further processing
             }
             // Note: Super-admin cookie check happens *inside* its render function

            showSection(sectionId);
            updateActiveNavLink(sectionId);
        }


        function showSection(sectionId) {
             // Hide all content sections first
             document.querySelectorAll('.content-section').forEach(section => {
                // Special check for super-admin: don't force hide if it was manually shown via CSS override
                if (section.id !== 'super-admin' || window.getComputedStyle(section).display === 'block') {
                    section.style.display = 'none';
                }
             });

             const sectionToShow = document.getElementById(sectionId);
             if (sectionToShow) {
                sectionToShow.style.display = 'block';

                // Dynamically render content when section is shown
                 if (sectionId === 'marketplace') renderMarketplace();
                 else if (sectionId === 'inventory') renderInventory();
                 else if (sectionId === 'payment') renderPaymentPage(); // Render payment page
                 else if (sectionId === 'admin') renderAdminPanel();
                 else if (sectionId === 'super-admin') renderSuperAdminPanel();
                 // Send assets section has static forms, no dynamic render needed on show
             } else {
                 // Fallback if section somehow doesn't exist
                 document.getElementById('home').style.display = 'block';
                 updateActiveNavLink('home');
             }

             clearStatusMessage(); // Clear status when changing sections
        }

        function updateActiveNavLink(activeSectionId) {
             document.querySelectorAll('nav .nav-link').forEach(link => {
                 link.classList.remove('active');
                 // Check if the link's href matches the current section ID
                 if (link.getAttribute('href') === `#${activeSectionId}`) {
                     link.classList.add('active');
                 }
             });
         }


        function setStatusMessage(message, type = 'info', duration = 5000) {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) return;
            // Use textContent to prevent accidental HTML injection in status messages
            statusDiv.textContent = message;
            statusDiv.className = type; // 'success' or 'error' or 'info'
            statusDiv.style.display = 'block';

            // Auto-hide message after duration (if duration > 0)
             if (duration > 0) {
                 // Clear existing timer if any
                 if (statusDiv.timer) clearTimeout(statusDiv.timer);
                 statusDiv.timer = setTimeout(clearStatusMessage, duration);
             }
        }

        function clearStatusMessage() {
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                 if (statusDiv.timer) clearTimeout(statusDiv.timer); // Clear timer if exists
                 statusDiv.style.display = 'none';
                 statusDiv.textContent = '';
                 statusDiv.className = '';
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('send-robux-form')?.addEventListener('submit', handleSendRobux);
            document.getElementById('send-item-form')?.addEventListener('submit', handleSendItem);
            document.getElementById('item-search')?.addEventListener('input', handleItemSearch); // XSS Demo Trigger

            // Event delegation for dynamically added buttons
             document.body.addEventListener('click', (event) => {
                 const target = event.target; // Cache the target

                 // Buy item button
                 if (target.classList.contains('buy-item-btn')) {
                     const itemId = target.getAttribute('data-item-id');
                     if (itemId) handleBuyItem(itemId);
                 }
                 // Remove user button (Admin Panel)
                 if (target.classList.contains('remove-user-btn')) {
                      const username = target.getAttribute('data-username');
                      if (username) handleRemoveUser(username);
                  }
                 // Super Admin Grant Robux button
                  if (target.id === 'super-grant-robux-btn') {
                      handleSuperGrantRobux();
                  }
                 // Super Admin Grant Item button
                  if (target.id === 'super-grant-item-btn') {
                      handleSuperGrantItem();
                  }
             });
        }

        // --- Marketplace Functionality ---
        function renderMarketplace() {
            const listingDiv = document.getElementById('item-listing');
            if (!listingDiv) return;

            if (!Array.isArray(allItems) || allItems.length === 0) {
                listingDiv.innerHTML = '<p>No items available or failed to load.</p>';
                return;
            }

            listingDiv.innerHTML = allItems.map(item => {
                // Basic check for valid item structure
                if (!item || !item.id || !item.name) return '';
                return `
                    <div class="item-card">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/150/808080/FFFFFF?text=NoImage'}" alt="${item.name}">
                        <h3>${item.name} (${item.id})</h3>
                        <p>${item.description || 'No description.'}</p>
                        <p class="price">${item.price !== undefined ? item.price : 'N/A'}</p>
                        <button class="buy-item-btn" data-item-id="${item.id}" ${item.price === undefined ? 'disabled title="Cannot buy"' : ''}>Buy</button>
                    </div>
                `;
            }).join('');
        }

        function handleBuyItem(itemId) {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                setStatusMessage("Please log in to buy items.", "error");
                window.location.hash = '#login';
                return;
            }

            const item = getItemById(itemId);
            if (!item) {
                setStatusMessage("Item not found.", "error");
                return;
            }
             if (item.price === undefined || typeof item.price !== 'number') {
                 setStatusMessage("Item cannot be purchased (invalid price).", "error");
                 return;
             }


            if (currentUser.robuxBalance >= item.price) {
                // VULNERABILITY: All logic is client-side
                currentUser.robuxBalance -= item.price;
                // Add item only if not already owned
                if (!currentUser.inventory.includes(itemId)) {
                    currentUser.inventory.push(itemId);
                } else {
                     setStatusMessage(`You already own ${item.name}. Balance updated.`, "info"); // Inform user but still charge
                }
                saveCurrentUser(currentUser);
                if(currentUser.inventory.includes(itemId)) setStatusMessage(`Successfully purchased ${item.name}!`, "success");

                // Update inventory display if currently visible
                if (document.getElementById('inventory').style.display === 'block') {
                    renderInventory();
                }
                // Also update payment page if visible
                if (document.getElementById('payment').style.display === 'block') {
                    renderPaymentPage();
                }
            } else {
                setStatusMessage("Not enough Robux!", "error");
            }
        }

         // XSS Demo for Marketplace Search
         function handleItemSearch(event) {
             const searchTerm = event.target.value;
             const outputDiv = document.getElementById('xss-output-unsafe');
             const contentDiv = document.getElementById('unsafe-search-content');
             if (!outputDiv || !contentDiv) return; // Ensure elements exist

             if (searchTerm.trim() === '') {
                 outputDiv.style.display = 'none';
                 return;
             }

             // *** XSS VULNERABILITY ***
             contentDiv.innerHTML = `Search results for: <strong>${searchTerm}</strong> (Displaying input unsafely!)`;
             outputDiv.style.display = 'block';
         }


        // --- Inventory Functionality ---
        function renderInventory() {
             const currentUser = getCurrentUser();
             const balanceSpan = document.getElementById('inventory-balance');
             const userIdSpan = document.getElementById('inventory-userid');
             const listUl = document.getElementById('inventory-list');

             if (!currentUser || !balanceSpan || !listUl || !userIdSpan) {
                 if (listUl) listUl.innerHTML = '<li>Please log in to view inventory.</li>';
                 if (balanceSpan) balanceSpan.textContent = '0';
                 if (userIdSpan) userIdSpan.textContent = 'N/A';
                 return;
             }

             balanceSpan.textContent = currentUser.robuxBalance;
             userIdSpan.textContent = currentUser.userId; // Display User ID

             if (!Array.isArray(currentUser.inventory) || currentUser.inventory.length === 0) {
                 listUl.innerHTML = '<li>No items owned. Visit the Marketplace!</li>';
             } else {
                 listUl.innerHTML = currentUser.inventory.map(itemId => {
                     const item = getItemById(itemId);
                     if (!item) return `<li>Unknown Item ID: ${itemId}</li>`; // Handle missing item data
                     return `
                         <li>
                             <div class="item-info">
                                 <img src="${item.imageUrl || 'https://via.placeholder.com/40/808080/FFFFFF?text=?'}" alt="${item.name}">
                                 <span><strong>${item.name}</strong> (${item.id})</span>
                             </div>
                             <span>Value: R$ ${item.price !== undefined ? item.price : 'N/A'}</span>
                         </li>
                     `;
                 }).join('');
             }
         }

         // --- Payment Page Functionality ---
         function renderPaymentPage() {
             const currentUser = getCurrentUser();
             const skinsListDiv = document.getElementById('payment-skins-list');

             if (!skinsListDiv) return;

             if (!currentUser) {
                 skinsListDiv.innerHTML = '<p>Please log in to view this page.</p>';
                 return;
             }

             let itemsToShow = [];
             let message = `<p>Showing items associated with your session (User ID: ${currentUser.userId}).</p>`;

             // *** VULNERABILITY CHECK: User ID = 5 ***
             if (currentUser.userId === 5) {
                 itemsToShow = allItems; // Show ALL items
                 message = `<p style="color: #f1c40f; font-weight: bold;">SPECIAL ACCESS (User ID 5): Showing ALL available items!</p>`;
             } else {
                 // Show only owned items
                 if (Array.isArray(currentUser.inventory)) {
                     itemsToShow = currentUser.inventory.map(id => getItemById(id)).filter(item => item); // Get full item details for owned IDs
                 }
             }

             if (itemsToShow.length === 0) {
                 skinsListDiv.innerHTML = message + '<p>No items to display.</p>';
             } else {
                 skinsListDiv.innerHTML = message + itemsToShow.map(item => {
                      if (!item || !item.id || !item.name) return ''; // Skip malformed items
                      return `
                         <div class="skin-card">
                              <img src="${item.imageUrl || 'https://via.placeholder.com/150/808080/FFFFFF?text=NoImage'}" alt="${item.name}">
                              <h3>${item.name}</h3>
                              <p>ID: ${item.id}</p>
                         </div>
                      `;
                 }).join('');
             }
         }


        // --- Send Assets Functionality ---
        function handleSendRobux(event) {
            event.preventDefault();
            const currentUser = getCurrentUser();
            if (!currentUser) { setStatusMessage("Login required.", "error"); return; }

            const recipientInput = document.getElementById('send-robux-recipient');
            const amountInput = document.getElementById('send-robux-amount');
            const recipient = recipientInput.value.trim();
            const amount = parseInt(amountInput.value, 10);

            if (!recipient || isNaN(amount) || amount <= 0) {
                 setStatusMessage("Invalid recipient or amount.", "error"); return;
            }
             // TEACHING POINT: Add a check to prevent sending to self
             if (recipient.toLowerCase() === currentUser.username.toLowerCase()) {
                 setStatusMessage("You cannot send Robux to yourself.", "error"); return;
             }

            if (currentUser.robuxBalance >= amount) {
                 // VULNERABILITY: Only deducts locally
                 currentUser.robuxBalance -= amount;
                 saveCurrentUser(currentUser);
                 setStatusMessage(`Simulated sending R$ ${amount} to ${recipient}. Your balance updated. Recipient data NOT changed.`, "success");
                 if (document.getElementById('inventory').style.display === 'block') renderInventory(); // Update displayed balance
                 recipientInput.value = ''; // Clear form
                 amountInput.value = '';
                 console.log(`SIMULATED SEND: ${currentUser.username} -> ${recipient}, ${amount} Robux`);
            } else {
                 setStatusMessage("Not enough Robux to send.", "error");
            }
        }

        function handleSendItem(event) {
             event.preventDefault();
             const currentUser = getCurrentUser();
             if (!currentUser) { setStatusMessage("Login required.", "error"); return; }

             const recipientInput = document.getElementById('send-item-recipient');
             const itemIdInput = document.getElementById('send-item-id');
             const recipient = recipientInput.value.trim();
             const itemId = itemIdInput.value.trim().toUpperCase(); // Match item ID case

             if (!recipient || !itemId) {
                 setStatusMessage("Invalid recipient or item ID.", "error"); return;
             }
             // TEACHING POINT: Add a check to prevent sending to self
             if (recipient.toLowerCase() === currentUser.username.toLowerCase()) {
                 setStatusMessage("You cannot send items to yourself.", "error"); return;
             }


             const itemIndex = currentUser.inventory.indexOf(itemId);
             if (itemIndex > -1) {
                 // VULNERABILITY: Only removes locally
                 currentUser.inventory.splice(itemIndex, 1);
                 saveCurrentUser(currentUser);
                 const item = getItemById(itemId);
                 const itemName = item ? item.name : itemId;
                 setStatusMessage(`Simulated sending ${itemName} (${itemId}) to ${recipient}. Item removed from your inventory. Recipient data NOT changed.`, "success");
                 if (document.getElementById('inventory').style.display === 'block') renderInventory(); // Update displayed inventory
                 recipientInput.value = ''; // Clear form
                 itemIdInput.value = '';
                 console.log(`SIMULATED SEND: ${currentUser.username} -> ${recipient}, Item ${itemId}`);
             } else {
                 setStatusMessage(`You do not own item ID: ${itemId}.`, "error");
             }
        }


        // --- Admin Panel Functionality ---
        function renderAdminPanel() {
            const adminContentDiv = document.getElementById('admin-content');
            if (!adminContentDiv) return;
            const currentUser = getCurrentUser();
             if (!currentUser?.isAdmin) {
                 adminContentDiv.innerHTML = '<p>Access Denied.</p>'; return;
             }

            const users = getUsers();
            let userListHtml = '<p>No users found or error loading.</p>';
             if (users.length > 0) {
                 userListHtml = '<ul class="user-list">';
                 users.forEach(user => {
                      if (!user || !user.username) return; // Skip malformed user entries
                     // VULNERABILITY: Displaying Caesar-ciphered passwords
                     const disableDelete = (currentUser.username === user.username) ? 'disabled title="Cannot remove self"' : '';
                     userListHtml += `
                         <li>
                             <span>${user.username} ${user.isAdmin ? '(Admin)' : ''} (ID: ${user.userId || 'N/A'})</span>
                             <span>R$ ${user.robuxBalance !== undefined ? user.robuxBalance : 'N/A'} | Inv: ${Array.isArray(user.inventory) ? user.inventory.length : 'N/A'}</span>
                             <span title="Caesar Ciphered Password (Shift ${CAESAR_SHIFT})">Pass: ${user.password || 'N/A'}</span>
                             <button class="remove-user-btn secondary" data-username="${user.username}" ${disableDelete}>Remove</button>
                         </li>
                     `;
                 });
                 userListHtml += '</ul>';
             }

            adminContentDiv.innerHTML = `
                <p>Welcome, Admin ${currentUser.username}!</p>
                <div class="admin-section">
                    <h3>Manage Users (Ciphered Passwords Shown!)</h3>
                    ${userListHtml}
                     <div class="explanation-box" style="margin-top:10px; font-size:0.9em;">
                        // <strong>Security Risk:</strong> Passwords shown are 'encrypted' with a weak Caesar cipher (Shift ${CAESAR_SHIFT}). This is easily broken and NOT secure. Never store passwords like this! Use strong, salted hashing algorithms (like Argon2, bcrypt).
                     </div>
                </div>
                <div class="localstorage-note" style="margin-top: 25px;">
                //      <strong>Admin Tip:</strong> You can directly edit the <code>robloxUsers</code> data in Local Storage (F12 -> Application -> Local Storage) to change balances, inventories, passwords (remember they are ciphered!), or admin status more powerfully than this panel allows. Refresh the page after editing.
                // </div>
            `;
        }

        function handleRemoveUser(usernameToRemove) {
             const currentUser = getCurrentUser();
             if (!currentUser?.isAdmin) { setStatusMessage("Admin required.", "error"); return; }
             if (currentUser.username === usernameToRemove) { setStatusMessage("Cannot remove yourself.", "error"); return; }

             if (confirm(`Are you sure you want to remove user "${usernameToRemove}"? This is irreversible (in this demo).`)) {
                 let users = getUsers();
                 const initialLength = users.length;
                 users = users.filter(u => u.username !== usernameToRemove);
                 if (users.length < initialLength) {
                     saveUsers(users);
                     setStatusMessage(`User "${usernameToRemove}" removed.`, "success");
                     renderAdminPanel(); // Re-render the list
                 } else {
                     setStatusMessage(`User "${usernameToRemove}" not found.`, "error");
                 }
             }
        }

        // --- Super Admin Panel Functionality ---
        function renderSuperAdminPanel() {
            const superAdminContentDiv = document.getElementById('super-admin-content');
            if (!superAdminContentDiv) return;

            // *** VULNERABILITY CHECK: Cookie (Secretive!) ***
             function checkCookie(name) {
                 const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                 return match ? match[2] : null;
             }
            const cookieValue = checkCookie(SUPER_ADMIN_COOKIE_NAME);

            if (cookieValue !== SUPER_ADMIN_COOKIE_VALUE) {
                superAdminContentDiv.innerHTML = `
                    <p style="color: #e74c3c; font-weight: bold;">ACCESS DENIED!</p>
                    <p>A specific browser cookie is required for Super Admin access.</p>
                    <p>Use Developer Tools (F12 -> Application -> Cookies) to inspect the site's cookies. You might need to find the correct cookie name and set its value appropriately, then refresh the page.</p>
                `;
                return;
            }

            // Render controls if cookie is present
            const users = getUsers();
             if (!users || users.length === 0) {
                 superAdminContentDiv.innerHTML = '<p>Error: Could not load users for Super Admin panel.</p>';
                 return;
             }

            const userOptions = users
                .filter(u => u && u.username) // Filter out invalid user entries
                .map(u => `<option value="${u.username}">${u.username}</option>`)
                .join('');

            const itemOptions = allItems
                .filter(i => i && i.id && i.name) // Filter out invalid item entries
                .map(i => `<option value="${i.id}">${i.name} (${i.id})</option>`)
                .join('');


            superAdminContentDiv.innerHTML = `
                <p style="color: #2ecc71; font-weight: bold;">Access Granted via Cookie!</p>
                <p>Welcome, Super User! You can grant assets directly by manipulating Local Storage.</p>

                <div class="admin-section" style="margin-top: 20px;">
                    <h3>Grant Robux</h3>
                    <label for="super-grant-robux-user">Target User:</label>
                    <select id="super-grant-robux-user">${userOptions}</select>
                    <label for="super-grant-robux-amount">Amount to Grant:</label>
                    <input type="number" id="super-grant-robux-amount" min="1" value="10000">
                    <button id="super-grant-robux-btn" class="secondary">Grant Robux</button>
                </div>

                 <div class="admin-section" style="margin-top: 20px;">
                    <h3>Grant Item</h3>
                    <label for="super-grant-item-user">Target User:</label>
                    <select id="super-grant-item-user">${userOptions}</select>
                    <label for="super-grant-item-id">Item to Grant:</label>
                    <select id="super-grant-item-id">${itemOptions}</select>
                    <button id="super-grant-item-btn" class="secondary">Grant Item</button>
                </div>

                <div class="localstorage-note" style="margin-top: 25px;">
                     <strong>Super Admin Power:</strong> These buttons directly modify the <code>robloxUsers</code> entry in Local Storage for the selected user. This simulates privileged server actions but is done insecurely on the client.
                </div>
            `;
        }

        function handleSuperGrantRobux() {
             // Add check for cookie again, in case it was removed after page load
             if (checkCookie(SUPER_ADMIN_COOKIE_NAME) !== SUPER_ADMIN_COOKIE_VALUE) {
                 setStatusMessage("Super Admin cookie missing or invalid.", "error");
                 renderSuperAdminPanel(); // Re-render to show access denied
                 return;
             }

             const targetUsername = document.getElementById('super-grant-robux-user')?.value;
             const amountInput = document.getElementById('super-grant-robux-amount');
             const amount = amountInput ? parseInt(amountInput.value, 10) : NaN;

             if (!targetUsername || isNaN(amount) || amount <= 0) {
                 setStatusMessage("Invalid user or amount.", "error"); return;
             }

             let users = getUsers();
             const userIndex = users.findIndex(u => u && u.username === targetUsername);

             if (userIndex > -1) {
                 // Ensure robuxBalance exists and is a number
                 if (typeof users[userIndex].robuxBalance !== 'number') {
                     users[userIndex].robuxBalance = 0;
                 }
                 users[userIndex].robuxBalance += amount;
                 saveUsers(users);

                 // Update current user view if they are the target
                 const currentUser = getCurrentUser();
                 if (currentUser && currentUser.username === targetUsername) {
                      // Update the currentUser object in localStorage directly
                      currentUser.robuxBalance += amount;
                      saveCurrentUser(currentUser);
                      // Re-render relevant sections if they are visible
                      if (document.getElementById('inventory').style.display === 'block') renderInventory();
                      if (document.getElementById('payment').style.display === 'block') renderPaymentPage();
                 }
                 setStatusMessage(`Granted R$ ${amount} to ${targetUsername}. LocalStorage updated.`, "success");
                 // Re-render admin panel if visible to show updated balances
                 if (document.getElementById('admin').style.display === 'block') renderAdminPanel();

             } else {
                 setStatusMessage(`User ${targetUsername} not found.`, "error");
             }
        }

         function handleSuperGrantItem() {
              // Add check for cookie again
              if (checkCookie(SUPER_ADMIN_COOKIE_NAME) !== SUPER_ADMIN_COOKIE_VALUE) {
                 setStatusMessage("Super Admin cookie missing or invalid.", "error");
                 renderSuperAdminPanel();
                 return;
             }

             const targetUsername = document.getElementById('super-grant-item-user')?.value;
             const itemId = document.getElementById('super-grant-item-id')?.value;


             if (!targetUsername || !itemId) {
                 setStatusMessage("Invalid user or item selection.", "error"); return;
             }

             let users = getUsers();
             const userIndex = users.findIndex(u => u && u.username === targetUsername);
             const item = getItemById(itemId); // Ensure item exists in the master list

             if (userIndex > -1 && item) {
                 // Ensure inventory is an array
                 if (!Array.isArray(users[userIndex].inventory)) {
                     users[userIndex].inventory = [];
                 }

                 if (!users[userIndex].inventory.includes(itemId)) {
                     users[userIndex].inventory.push(itemId);
                     saveUsers(users);

                     // Update current user view if they are the target
                     const currentUser = getCurrentUser();
                     if (currentUser && currentUser.username === targetUsername) {
                         if (!Array.isArray(currentUser.inventory)) currentUser.inventory = []; // Ensure array
                         currentUser.inventory.push(itemId);
                         saveCurrentUser(currentUser);
                         if (document.getElementById('inventory').style.display === 'block') renderInventory();
                          if (document.getElementById('payment').style.display === 'block') renderPaymentPage();
                     }
                      setStatusMessage(`Granted item ${item.name} (${itemId}) to ${targetUsername}. LocalStorage updated.`, "success");
                     if (document.getElementById('admin').style.display === 'block') renderAdminPanel();
                 } else {
                     setStatusMessage(`${targetUsername} already owns item ${itemId}.`, "info");
                 }
             } else if (userIndex === -1) {
                 setStatusMessage(`User ${targetUsername} not found.`, "error");
             } else {
                 setStatusMessage(`Selected item ${itemId} is invalid or not found.`, "error");
             }
         }

    </script>

</body>
</html>
