<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CytoSim: The Microverse</title>
    <style>
        :root {
            /* Cytoplasm Theme Colors */
            --bg-base: #11081a;
            --bg-panel: rgba(26, 12, 38, 0.92);
            --bg-panel-solid: #1a0c26;
            --border-primary: #4c1d95;
            --border-highlight: #ec4899;
            --text-main: #fdf2f8;
            --text-muted: #fbcfe8;
            
            /* Biological Resource Colors */
            --color-atp: #fbbf24;       /* Gold: Energy */
            --color-glucose: #38bdf8;   /* Cyan: Nutrients */
            --color-protein: #ec4899;   /* Pink: Amino chains */
            --color-waste: #84cc16;     /* Toxic Green: Metabolic Waste */
            --color-health: #f43f5e;    /* Red: Cell Integrity */
            --color-nucleus: #a855f7;   /* Purple: DNA / Command */
            --color-virus: #ef4444;     /* Bright Red: Viral Load */
            
            --font-sans: 'Segoe UI', system-ui, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
            --z-canvas: 1; --z-particles: 2; --z-hud: 10; --z-panels: 20;
            --z-quickbar: 25; --z-tooltips: 100; --z-modals: 200;
            --z-notifications: 300; --z-splash: 1000;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body {
            background: var(--bg-base); color: var(--text-main); font-family: var(--font-sans);
            overflow: hidden; width: 100vw; height: 100vh; display: flex; flex-direction: column;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(circle at 20% 60%, rgba(236,72,153,0.04), transparent 30%),
                              radial-gradient(circle at 80% 20%, rgba(168,85,247,0.05), transparent 30%),
                              radial-gradient(circle at 50% 90%, rgba(132,204,22,0.03), transparent 25%);
        }
        h1,h2,h3,h4,h5,h6 { font-weight: 600; line-height: 1.2; letter-spacing: 0.5px; margin-bottom: 0.75rem; color: var(--text-main); }
        p { line-height: 1.6; margin-bottom: 1rem; color: var(--text-muted); font-size: 0.95rem; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: var(--border-highlight); }

        /* ===== TOP HUD ===== */
        #app-container { display:flex; flex-direction:column; width:100vw; height:100vh; position:relative; }
        #top-hud {
            position:absolute; top:0; left:0; width:100%; height:68px;
            background:var(--bg-panel); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
            border-bottom:1px solid var(--border-primary); z-index:var(--z-hud);
            display:flex; justify-content:space-between; align-items:center; padding:0 16px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.6);
        }
        .hud-left { display:flex; align-items:center; gap:16px; }
        .game-title { display:flex; flex-direction:column; }
        .game-title h1 { font-size:1.1rem; margin:0; color:var(--color-protein); text-shadow:0 0 12px rgba(236,72,153,0.5); text-transform:uppercase; letter-spacing:2px; }
        .game-title span { font-size:0.6rem; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }
        
        .hud-metrics { display:flex; gap:6px; height:100%; align-items:center; flex-wrap:wrap; }
        .metric-card {
            background:rgba(0,0,0,0.5); border:1px solid var(--border-primary); border-radius:8px;
            padding:4px 8px; display:flex; flex-direction:column; justify-content:center;
            min-width:105px; height:48px; position:relative; transition:all 0.2s; cursor:help;
        }
        .metric-card:hover { transform:translateY(-2px); border-color:rgba(255,255,255,0.2); }
        .metric-label { font-size:0.55rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:1px; display:flex; justify-content:space-between; }
        .metric-value { font-family:var(--font-mono); font-size:0.95rem; font-weight:bold; display:flex; align-items:baseline; gap:3px; }
        .metric-cap { font-size:0.6rem; color:var(--text-muted); font-weight:normal; }
        .metric-delta { font-size:0.55rem; margin-left:auto; font-family:var(--font-mono); }
        .metric-bar-bg { position:absolute; bottom:-1px; left:0; width:100%; height:3px; background:transparent; border-radius:0 0 8px 8px; overflow:hidden; }
        .metric-bar-fill { height:100%; width:0%; transition:width 0.3s ease, background-color 0.3s ease; }

        .metric-atp .metric-value { color:var(--color-atp); }
        .metric-glucose .metric-value { color:var(--color-glucose); }
        .metric-glucose .metric-bar-fill { background:var(--color-glucose); box-shadow:0 0 8px var(--color-glucose); }
        .metric-protein .metric-value { color:var(--color-protein); }
        .metric-protein .metric-bar-fill { background:var(--color-protein); box-shadow:0 0 8px var(--color-protein); }
        
        .metric-waste .metric-value { color:var(--color-waste); }
        .metric-waste .metric-bar-fill { background:var(--color-waste); box-shadow:0 0 8px var(--color-waste); }
        .metric-health .metric-value { color:var(--color-health); }
        .metric-health .metric-bar-fill { background:var(--color-health); box-shadow:0 0 8px var(--color-health); }
        
        .metric-viral .metric-value { color:var(--color-virus); }
        .metric-viral .metric-bar-fill { background:var(--color-virus); box-shadow:0 0 8px var(--color-virus); }

        @keyframes pulse-danger { 0%{border-color:rgba(244,63,94,0.2);box-shadow:0 0 0 rgba(244,63,94,0)} 50%{border-color:var(--color-health);box-shadow:0 0 12px rgba(244,63,94,0.5)} 100%{border-color:rgba(244,63,94,0.2);box-shadow:0 0 0 rgba(244,63,94,0)} }
        @keyframes pulse-toxic { 0%{border-color:rgba(132,204,22,0.2);box-shadow:0 0 0 rgba(132,204,22,0)} 50%{border-color:var(--color-waste);box-shadow:0 0 12px rgba(132,204,22,0.5)} 100%{border-color:rgba(132,204,22,0.2);box-shadow:0 0 0 rgba(132,204,22,0)} }
        .metric-warning-health { animation:pulse-danger 1s infinite; }
        .metric-warning-waste { animation:pulse-toxic 1.5s infinite; }

        .hud-right { display:flex; gap:8px; align-items:center; }

        /* ===== BUTTONS ===== */
        .btn {
            background:rgba(30,10,40,0.6); border:1px solid var(--border-primary); color:var(--text-main);
            padding:7px 14px; border-radius:6px; font-family:var(--font-sans); font-weight:600; font-size:0.8rem;
            text-transform:uppercase; letter-spacing:1px; cursor:pointer;
            transition:all 0.2s cubic-bezier(0.175,0.885,0.32,1.275);
            display:inline-flex; align-items:center; justify-content:center; gap:6px; position:relative; overflow:hidden;
        }
        .btn:hover:not(:disabled) { background:rgba(255,255,255,0.1); border-color:var(--text-main); transform:translateY(-2px); }
        .btn:disabled { opacity:0.4; cursor:not-allowed; filter:grayscale(100%); }
        .btn-primary { background:rgba(168,85,247,0.15); border-color:var(--color-nucleus); color:var(--color-nucleus); }
        .btn-primary:hover:not(:disabled) { background:rgba(168,85,247,0.3); color:#fff; box-shadow:0 0 15px rgba(168,85,247,0.4); }
        .btn-codex { background:rgba(56,189,248,0.12); border-color:var(--color-glucose); color:#bae6fd; }
        .btn-codex:hover { background:rgba(56,189,248,0.25); color:#fff; box-shadow:0 0 15px rgba(56,189,248,0.3); }
        .btn-danger { background:rgba(244,63,94,0.15); border-color:var(--color-health); color:var(--color-health); }

        /* ===== GAME CANVAS ===== */
        #game-area {
            position:absolute; top:68px; left:0; width:100vw; height:calc(100vh - 68px);
            background:radial-gradient(circle at center, #1b0a26 0%, #0d0414 100%);
            z-index:var(--z-canvas); overflow:hidden; cursor:grab;
        }
        #game-area:active { cursor:grabbing; }
        #game-area.placing { cursor:crosshair!important; }
        #svg-canvas { width:100%; height:100%; position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform; }
        
        .iso-base-tile { transition:fill 0.15s,stroke 0.15s; }
        .tile-interactive:hover .iso-base-tile { fill:#2e1540!important; stroke:var(--color-protein)!important; stroke-width:1.5!important; }
        .iso-building { pointer-events:none; transition:filter 0.3s; }
        
        .bld-infected { filter: drop-shadow(0 0 15px red) brightness(1.5) sepia(1) hue-rotate(300deg) saturate(3); animation: throb 0.8s infinite; }
        @keyframes throb { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }

        .ghost-valid { opacity:0.7; filter:drop-shadow(0 0 12px var(--color-atp)) brightness(1.2); pointer-events:none; }
        .ghost-invalid { opacity:0.5; filter:drop-shadow(0 0 12px var(--color-health)) grayscale(100%); pointer-events:none; }
        .tile-highlight-valid .iso-base-tile { fill:rgba(251,191,36,0.12)!important; stroke:var(--color-atp)!important; stroke-width:2!important; }
        .tile-highlight-invalid .iso-base-tile { fill:rgba(244,63,94,0.08)!important; stroke:var(--color-health)!important; stroke-width:2!important; }

        /* Vesicles / Particles */
        .data-packet { pointer-events:none; mix-blend-mode:screen; animation:ppulse 1s infinite alternate; }
        @keyframes ppulse { 0%{filter:drop-shadow(0 0 3px currentColor);opacity:0.8} 100%{filter:drop-shadow(0 0 10px currentColor);opacity:1} }
        
        .virus-packet { stroke: #ef4444 !important; fill: #b91c1c !important; mix-blend-mode:normal; animation:pglitch 0.15s infinite !important; filter:drop-shadow(0 0 6px #ef4444); pointer-events:none; }
        @keyframes pglitch { 0%{transform:translate(0,0) scale(1)} 25%{transform:translate(3px,-3px) scale(1.1)} 50%{transform:translate(-3px,3px) scale(0.9)} 75%{transform:translate(-3px,-3px) scale(1.1)} 100%{transform:translate(3px,3px) scale(1)} }
        
        .cure-packet { stroke: #38bdf8 !important; fill: #bae6fd !important; mix-blend-mode:screen; animation: ppulse 0.4s infinite alternate; filter: drop-shadow(0 0 8px #38bdf8); pointer-events:none;}

        .canvas-float-text { position:absolute; pointer-events:none; font-family:var(--font-mono); font-weight:bold; font-size:15px; z-index:var(--z-particles); text-shadow:0 2px 4px rgba(0,0,0,0.9); animation:floatUp 1.5s ease-out forwards; }
        .txt-expense { color:var(--color-health); } .txt-income { color:var(--color-atp); } .txt-alert { color:var(--color-waste); }
        @keyframes floatUp { 0%{transform:translateY(0) scale(1);opacity:1} 20%{transform:translateY(-15px) scale(1.2);opacity:1} 100%{transform:translateY(-60px) scale(1);opacity:0} }

        /* ===== QUICK BUILD BAR ===== */
        #quick-bar {
            position:absolute; bottom:16px; left:50%; transform:translateX(-50%);
            z-index:var(--z-quickbar); display:flex; gap:5px; padding:8px 14px;
            background:var(--bg-panel); backdrop-filter:blur(12px); border:1px solid var(--border-primary);
            border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.8); flex-wrap:wrap; justify-content:center; max-width:90vw;
        }
        .qb-item {
            width:52px; height:52px; border-radius:8px; border:1px solid var(--border-primary);
            background:rgba(0,0,0,0.5); display:flex; flex-direction:column; align-items:center; justify-content:center;
            cursor:pointer; transition:all 0.2s; position:relative; gap:1px; flex-shrink:0;
        }
        .qb-item:hover:not(.qb-locked) { border-color:var(--color-protein); background:rgba(236,72,153,0.1); transform:translateY(-4px); }
        .qb-item.qb-selected { border-color:var(--color-protein); background:rgba(236,72,153,0.2); box-shadow:0 0 12px rgba(236,72,153,0.3); transform:translateY(-4px); }
        .qb-item.qb-locked { opacity:0.3; cursor:not-allowed; filter:grayscale(80%); }
        .qb-icon { font-size:1.2rem; line-height:1; margin-bottom: 2px;}
        .qb-label { font-size:0.4rem; text-transform:uppercase; letter-spacing:0.3px; color:var(--text-muted); text-align:center; line-height:1.1; max-width:48px; overflow:hidden; white-space:nowrap; }
        .qb-cost { position:absolute; top:-7px; right:-4px; font-size:0.45rem; font-family:var(--font-mono); color:var(--color-atp); background:rgba(0,0,0,0.9); padding:1px 3px; border-radius:3px; border:1px solid rgba(251,191,36,0.3); }
        .qb-key { position:absolute; bottom:-5px; left:50%; transform:translateX(-50%); font-size:0.45rem; font-family:var(--font-mono); color:var(--text-muted); background:rgba(0,0,0,0.8); padding:0 3px; border-radius:2px; border:1px solid var(--border-primary); }
        .qb-divider { width:1px; background:var(--border-primary); margin:4px 3px; }

        #build-mode-indicator {
            position:absolute; bottom:86px; left:50%; transform:translateX(-50%);
            z-index:var(--z-quickbar); background:rgba(236,72,153,0.15); border:1px solid var(--color-protein);
            border-radius:8px; padding:7px 18px; color:var(--color-protein); font-size:0.75rem; font-weight:600;
            text-transform:uppercase; letter-spacing:1px; display:none; align-items:center; gap:10px;
            box-shadow:0 0 15px rgba(236,72,153,0.2);
        }
        #build-mode-indicator.active { display:flex; }
        .bmi-esc { font-size:0.6rem; color:var(--text-muted); background:rgba(0,0,0,0.5); padding:2px 5px; border-radius:3px; border:1px solid var(--border-primary); }

        /* ===== SIDEBARS ===== */
        #sidebar-left, #sidebar-right {
            position:absolute; top:68px; width:310px; height:calc(100vh - 68px);
            background:var(--bg-panel); backdrop-filter:blur(10px);
            z-index:var(--z-panels); display:flex; flex-direction:column;
            transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        #sidebar-left { left:0; border-right:1px solid var(--border-primary); transform:translateX(0); box-shadow:5px 0 25px rgba(0,0,0,0.6); }
        #sidebar-left.collapsed { transform:translateX(-310px); }
        #sidebar-right { right:0; border-left:1px solid var(--border-primary); transform:translateX(0); box-shadow:-5px 0 25px rgba(0,0,0,0.6); }
        #sidebar-right.collapsed { transform:translateX(310px); }
        
        .sidebar-toggle-btn {
            position:absolute; top:18px; width:30px; height:56px; background:var(--bg-panel);
            border:1px solid var(--border-primary); cursor:pointer; display:flex; justify-content:center;
            align-items:center; color:var(--text-muted); transition:color 0.2s; z-index:calc(var(--z-panels)+1); font-size:0.8rem;
        }
        #sidebar-left .sidebar-toggle-btn { right:-30px; border-left:none; border-radius:0 8px 8px 0; box-shadow:5px 0 10px rgba(0,0,0,0.3); }
        #sidebar-right .sidebar-toggle-btn { left:-30px; border-right:none; border-radius:8px 0 0 8px; box-shadow:-5px 0 10px rgba(0,0,0,0.3); }
        .sidebar-toggle-btn:hover { color:var(--color-protein); }
        
        .sidebar-header { padding:12px 16px; border-bottom:1px solid var(--border-primary); background:rgba(0,0,0,0.4); display:flex; justify-content:space-between; align-items:center; }
        .cancel-tool-btn { background:none; border:1px solid var(--border-primary); color:var(--text-muted); padding:3px 7px; border-radius:4px; font-size:0.65rem; cursor:pointer; text-transform:uppercase; }
        .cancel-tool-btn:hover { background:rgba(244,63,94,0.15); color:var(--color-health); border-color:var(--color-health); }
        
        .sidebar-content { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:6px; }
        .build-category-title { font-size:0.65rem; text-transform:uppercase; letter-spacing:2px; color:var(--text-muted); border-bottom:1px solid var(--border-primary); padding-bottom:3px; margin-top:6px; margin-bottom:4px; }
        .build-card { background:rgba(0,0,0,0.3); border:1px solid var(--border-primary); border-radius:8px; padding:10px; cursor:pointer; transition:all 0.2s; display:flex; flex-direction:column; gap:5px; }
        .build-card:hover:not(.locked) { background:rgba(255,255,255,0.05); border-color:var(--text-muted); transform:translateX(3px); }
        .build-card.selected { background:rgba(236,72,153,0.1); border-color:var(--color-protein); box-shadow:inset 3px 0 0 var(--color-protein); }
        .build-card.locked { opacity:0.35; cursor:not-allowed; filter:grayscale(100%); }
        .build-card-header { display:flex; justify-content:space-between; align-items:flex-start; }
        .build-name { font-weight:600; font-size:0.9rem; }
        .build-cost { font-family:var(--font-mono); font-weight:bold; color:var(--color-atp); font-size:0.8rem; background:rgba(0,0,0,0.6); padding:2px 5px; border-radius:4px; border:1px solid rgba(251,191,36,0.3); }
        .build-desc { font-size:0.7rem; color:var(--text-muted); line-height:1.4; }
        .build-stats { display:flex; flex-wrap:wrap; gap:3px; margin-top:2px; }
        
        .stat-badge { font-size:0.55rem; padding:2px 4px; border-radius:3px; background:rgba(255,255,255,0.05); font-family:var(--font-mono); display:flex; align-items:center; gap:2px; border:1px solid transparent; }
        .stat-badge.glu { background:rgba(56,189,248,0.1); color:var(--color-glucose); border-color:rgba(56,189,248,0.3); }
        .stat-badge.atp { background:rgba(251,191,36,0.1); color:var(--color-atp); border-color:rgba(251,191,36,0.3); }
        .stat-badge.pro { background:rgba(236,72,153,0.1); color:var(--color-protein); border-color:rgba(236,72,153,0.3); }
        .stat-badge.was { background:rgba(132,204,22,0.1); color:var(--color-waste); border-color:rgba(132,204,22,0.3); }
        .stat-badge.bad { background:rgba(244,63,94,0.1); color:var(--color-health); border-color:rgba(244,63,94,0.3); }

        /* ===== QUEST & CHARTS ===== */
        #quest-panel { padding:14px; border-bottom:1px solid var(--border-primary); background:rgba(168,85,247,0.05); flex-shrink:0; }
        .quest-header { font-size:0.65rem; text-transform:uppercase; letter-spacing:2px; color:var(--color-nucleus); margin-bottom:6px; display:flex; align-items:center; gap:6px; }
        .quest-title { font-size:0.95rem; font-weight:bold; margin-bottom:5px; line-height:1.3; }
        .quest-desc { font-size:0.75rem; color:var(--text-muted); margin-bottom:10px; line-height:1.5; }
        .quest-tasks { display:flex; flex-direction:column; gap:5px; background:rgba(0,0,0,0.3); padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); }
        .quest-task { display:flex; align-items:flex-start; gap:7px; font-size:0.75rem; color:#e2e8f0; }
        .task-checkbox { width:15px; height:15px; border:1px solid var(--text-muted); border-radius:3px; flex-shrink:0; margin-top:1px; display:flex; justify-content:center; align-items:center; transition:all 0.2s; }
        .quest-task.completed { color:var(--text-muted); text-decoration:line-through; opacity:0.6; }
        .quest-task.completed .task-checkbox { background:var(--color-nucleus); border-color:var(--color-nucleus); }
        .quest-task.completed .task-checkbox::after { content:'‚úì'; color:#fff; font-size:11px; font-weight:bold; }

        #chart-panel { flex:1; display:flex; flex-direction:column; padding:14px; overflow:hidden; }
        .chart-header { font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:8px; display:flex; justify-content:space-between; }
        .chart-legend { display:flex; gap:7px; font-size:0.6rem; }
        .legend-item { display:flex; align-items:center; gap:3px; } .legend-color { width:7px; height:7px; border-radius:50%; }
        .chart-container { flex:1; width:100%; background:rgba(0,0,0,0.5); border:1px solid var(--border-primary); border-radius:8px; position:relative; padding:8px; }
        #metrics-canvas { width:100%; height:100%; display:block; }

        /* ===== TOOLTIPS & TOASTS ===== */
        #game-tooltip { position:absolute; background:rgba(15,5,25,0.96); backdrop-filter:blur(5px); border:1px solid var(--border-highlight); color:var(--text-main); padding:10px 14px; border-radius:8px; font-size:0.8rem; pointer-events:none; z-index:var(--z-tooltips); opacity:0; transition:opacity 0.2s; box-shadow:0 10px 25px rgba(0,0,0,0.8); max-width:260px; line-height:1.5; }
        #game-tooltip h4 { color:var(--color-protein); margin:0 0 5px; font-size:0.9rem; border-bottom:1px solid var(--border-primary); padding-bottom:3px; }
        #game-tooltip p { margin:0; color:#fbcfe8; font-size:0.75rem; }
        #game-tooltip .tooltip-req { margin-top:6px; font-size:0.7rem; color:var(--color-health); font-style:italic; }

        #notification-area { position:absolute; top:82px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:8px; z-index:var(--z-notifications); pointer-events:none; width:380px; }
        .toast-msg { background:rgba(20,5,30,0.96); border:1px solid var(--border-primary); padding:12px 16px; border-radius:8px; color:#fff; font-size:0.85rem; box-shadow:0 10px 30px rgba(0,0,0,0.7); display:flex; align-items:flex-start; gap:10px; position:relative; overflow:hidden; animation:toastIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards, toastOut 0.5s ease forwards 6s; }
        .toast-msg::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; }
        .toast-msg.success::before { background:var(--color-glucose); } .toast-msg.success .toast-icon { color:var(--color-glucose); }
        .toast-msg.error::before { background:var(--color-health); } .toast-msg.error .toast-icon { color:var(--color-health); }
        .toast-msg.warning::before { background:var(--color-atp); } .toast-msg.warning .toast-icon { color:var(--color-atp); }
        .toast-msg.info::before { background:var(--color-nucleus); } .toast-msg.info .toast-icon { color:var(--color-nucleus); }
        .toast-icon { font-size:1.1rem; } .toast-content { flex:1; } .toast-title { font-weight:bold; margin-bottom:2px; font-size:0.85rem; } .toast-desc { font-size:0.72rem; color:var(--text-muted); line-height:1.4; }
        @keyframes toastIn { from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }
        @keyframes toastOut { from{opacity:1;height:auto;margin-bottom:8px} to{opacity:0;height:0;margin-bottom:0;padding:0;border:none} }

        /* ===== MODALS & DASHBOARD ===== */
        .modal-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(10,2,15,0.9); backdrop-filter:blur(8px); z-index:var(--z-modals); display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:opacity 0.3s; }
        .modal-overlay.active { opacity:1; pointer-events:auto; }
        .modal-window { background:var(--bg-panel-solid); border:1px solid var(--border-primary); border-radius:12px; width:90%; max-width:720px; max-height:85vh; display:flex; flex-direction:column; box-shadow:0 30px 60px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.08); transform:translateY(30px) scale(0.95); transition:transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275); overflow:hidden; }
        .modal-overlay.active .modal-window { transform:translateY(0) scale(1); }
        
        .modal-window.theme-event { border-color:var(--color-protein); box-shadow:0 0 40px rgba(236,72,153,0.15); }
        .modal-window.theme-wildcard { border-color:var(--color-virus); box-shadow:0 0 40px rgba(239,68,68,0.2); }
        .theme-event .modal-header { background:rgba(236,72,153,0.1); border-bottom-color:rgba(236,72,153,0.3); }
        .theme-wildcard .modal-header { background:rgba(239,68,68,0.1); border-bottom-color:rgba(239,68,68,0.3); }
        
        .modal-header { padding:16px 22px; border-bottom:1px solid var(--border-primary); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.4); }
        .modal-title { font-size:1.2rem; color:var(--text-main); margin:0; display:flex; align-items:center; gap:10px; }
        .modal-close-btn { background:none; border:none; color:var(--text-muted); font-size:1.6rem; cursor:pointer; transition:color 0.2s; line-height:1; padding:0; }
        .modal-close-btn:hover { color:var(--color-health); }
        .modal-body { padding:22px; overflow-y:auto; flex:1; }
        .modal-footer { padding:14px 22px; border-top:1px solid var(--border-primary); display:flex; justify-content:flex-end; gap:10px; background:rgba(0,0,0,0.4); }

        #codex-modal-window, #modal-dashboard { max-width:960px; height:76vh; }
        .dash-layout { display:flex; height:100%; margin:-22px; }
        .dash-sidebar { width:240px; background:rgba(0,0,0,0.3); border-right:1px solid var(--border-primary); display:flex; flex-direction:column; overflow-y:auto; }
        .dash-tab { padding:16px 16px; border-bottom:1px solid rgba(255,255,255,0.03); color:var(--text-muted); cursor:pointer; transition:all 0.2s; font-size:0.9rem; font-weight:600; display:flex; align-items:center; gap:10px; background:transparent; border-left:4px solid transparent; text-align:left; border-top:none; border-right:none; }
        .dash-tab:hover { background:rgba(255,255,255,0.05); color:var(--text-main); }
        .dash-tab.active { background:rgba(168,85,247,0.15); color:var(--color-nucleus); border-left-color:var(--color-nucleus); }
        .dash-content { flex:1; padding:22px 30px; overflow-y:auto; }
        
        .dash-section { margin-bottom:24px; background:rgba(0,0,0,0.4); border:1px solid var(--border-primary); border-radius:8px; padding:18px; }
        .dash-section h3 { font-size:1.1rem; color:var(--color-nucleus); margin-top:0; border-bottom:1px solid var(--border-primary); padding-bottom:8px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center; }
        .dash-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed rgba(255,255,255,0.1); }
        .dash-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .dash-info { flex:1; padding-right:20px; }
        .dash-info h4 { margin:0 0 4px 0; font-size:0.95rem; color:var(--text-main); }
        .dash-info p { margin:0; font-size:0.8rem; color:var(--text-muted); }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink:0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background:rgba(0,0,0,0.8); border: 1px solid var(--border-primary); transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: var(--text-muted); transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: rgba(168,85,247,0.3); border-color:var(--color-nucleus); box-shadow:0 0 10px rgba(168,85,247,0.4); }
        input:checked + .slider:before { transform: translateX(20px); background-color: var(--color-nucleus); }

        .train-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
        .train-stat-box { background:rgba(0,0,0,0.6); border:1px solid var(--border-primary); border-radius:6px; padding:12px; text-align:center; }
        .train-stat-label { font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:6px; }
        .train-stat-val { font-family:var(--font-mono); font-size:1.2rem; font-weight:bold; }
        .train-stat-val.meet { color:var(--color-glucose); } 
        .train-stat-val.fail { color:var(--color-health); }
        .model-version-badge { background:var(--color-nucleus); color:#fff; padding:2px 8px; border-radius:12px; font-weight:bold; font-size:0.8rem; }

        .edu-callout { background:rgba(56,189,248,0.05); border-left:4px solid var(--color-glucose); padding:14px; border-radius:0 8px 8px 0; margin:18px 0; }
        .edu-callout.warning { border-left-color:var(--color-health); background:rgba(244,63,94,0.08); }
        .edu-callout-title { display:block; font-weight:bold; text-transform:uppercase; letter-spacing:1px; font-size:0.75rem; margin-bottom:5px; color:var(--color-glucose); }
        .edu-callout.warning .edu-callout-title { color:var(--color-health); }
        
        .event-main-text { font-size:1.05rem; line-height:1.6; color:var(--text-main); margin-bottom:22px; text-align:center; }
        .event-choices { display:flex; flex-direction:column; gap:10px; }
        .choice-btn { background:rgba(0,0,0,0.5); border:1px solid var(--border-primary); border-radius:8px; padding:14px; text-align:left; cursor:pointer; transition:all 0.2s; display:flex; flex-direction:column; gap:6px; }
        .choice-btn:hover { background:rgba(168,85,247,0.15); border-color:var(--color-nucleus); transform:translateX(4px); }
        .choice-title { font-size:0.95rem; font-weight:bold; }
        .choice-effects { display:flex; flex-wrap:wrap; gap:10px; font-family:var(--font-mono); font-size:0.78rem; }
        .eff-pos { color:var(--color-waste); } .eff-neg { color:var(--color-health); } .eff-neu { color:var(--color-glucose); }

        /* ===== SPLASH ===== */
        #splash-screen { position:fixed; top:0; left:0; width:100vw; height:100vh; background:var(--bg-base); background-image:radial-gradient(circle at center,#2c0e18 0%,#11050a 100%); z-index:var(--z-splash); display:flex; justify-content:center; align-items:center; }
        .splash-content { background:var(--bg-panel); border:1px solid var(--border-primary); padding:36px 44px; border-radius:12px; max-width:680px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.9); }
        .splash-content h1 { font-size:2.8rem; color:var(--color-protein); text-transform:uppercase; letter-spacing:5px; margin-bottom:6px; text-shadow:0 0 20px rgba(236,72,153,0.5); }
        .splash-content h2 { font-size:1.1rem; color:var(--color-glucose); font-weight:400; margin-bottom:28px; letter-spacing:2px; text-transform:uppercase; }
        .splash-objectives { text-align:left; background:rgba(0,0,0,0.4); padding:22px; border-radius:8px; margin-bottom:24px; border-left:4px solid var(--color-nucleus); }
        .splash-objectives h3 { color:var(--text-main); margin-bottom:10px; } .splash-objectives ul { margin-left:18px; color:#fbcfe8; line-height:1.8; }
        .splash-objectives li strong { color:var(--color-atp); }
        .splash-tip { font-size:0.78rem; color:var(--text-muted); margin-bottom:22px; }
        .btn-start { font-size:1.1rem; padding:14px 38px; border-radius:30px; animation:pglow 2s infinite; background:rgba(236,72,153,0.2); border-color:var(--color-protein); color:#fff; }
        @keyframes pglow { 0%{box-shadow:0 0 0 0 rgba(236,72,153,0.4)} 70%{box-shadow:0 0 0 16px rgba(236,72,153,0)} 100%{box-shadow:0 0 0 0 rgba(236,72,153,0)} }

        /* ===== INSPECTOR ===== */
        #inspector-panel { position:absolute; bottom:90px; left:50%; transform:translateX(-50%); width:330px; background:var(--bg-panel-solid); border:1px solid var(--color-protein); border-radius:8px; padding:16px; z-index:var(--z-panels); display:none; box-shadow:0 10px 30px rgba(0,0,0,0.8); animation:slideUp 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes slideUp { from{transform:translateX(-50%) translateY(20px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }
        .inspector-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; border-bottom:1px solid var(--border-primary); padding-bottom:7px; }
        .inspector-title h3 { margin:0 0 3px; color:var(--text-main); font-size:1rem; } .inspector-title span { font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
        .inspector-stats { background:rgba(0,0,0,0.4); border-radius:6px; padding:8px; display:flex; flex-direction:column; gap:5px; }
        .inspect-row { display:flex; justify-content:space-between; align-items:center; font-size:0.78rem; }
        .inspect-label { color:var(--text-muted); } .inspect-val { font-family:var(--font-mono); font-weight:bold; }

        /* ===== APOPTOSIS OVERLAY ===== */
        #apoptosis-overlay {
            position:absolute; top:68px; left:0; width:100%; height:calc(100vh - 68px);
            background:repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(244,63,94,0.06) 20px, rgba(244,63,94,0.06) 40px);
            z-index:3; pointer-events:none; opacity:0; transition:opacity 1s;
            box-shadow: inset 0 0 150px rgba(244,63,94,0.6);
        }
        #apoptosis-overlay.active { opacity:1; animation: throb-ap 2s infinite; }
        @keyframes throb-ap { 0%{box-shadow:inset 0 0 50px rgba(244,63,94,0.3);} 50%{box-shadow:inset 0 0 150px rgba(244,63,94,0.6);} 100%{box-shadow:inset 0 0 50px rgba(244,63,94,0.3);} }
    </style>
</head>
<body>

<svg id="svg-defs" style="display:none;">
    <defs>
        <g id="asset-tile-base"><polygon points="0,-30 60,0 0,30 -60,0" fill="#2d0b17" stroke="#4a1528" stroke-width="1"/></g>
        
        <g id="asset-tile-road">
            <polygon points="0,-30 60,0 0,30 -60,0" fill="#1b050d" stroke="#4a1528" stroke-width="1"/>
            <line x1="-60" y1="0" x2="60" y2="0" stroke="#fcd34d" stroke-width="2" stroke-dasharray="6,4" opacity="0.4"/>
            <line x1="0" y1="-30" x2="0" y2="30" stroke="#fcd34d" stroke-width="2" stroke-dasharray="6,4" opacity="0.4"/>
            <circle cx="0" cy="0" r="5" fill="#fbbf24" opacity="0.5"/>
        </g>
        
        <g id="asset-bld-pore">
            <path d="M-25,-15 L25,-15 M-25,-20 L25,-20" stroke="#475569" stroke-width="2" opacity="0.4"/>
            <path d="M-12,-35 L-8,-5 L-4,-5 L-8,-35 Z" fill="#38bdf8"/>
            <path d="M12,-35 L8,-5 L4,-5 L8,-35 Z" fill="#38bdf8"/>
            <circle cx="0" cy="-30" r="3" fill="#bae6fd"/>
            <circle cx="0" cy="-15" r="3" fill="#bae6fd" opacity="0.5"/>
        </g>

        <g id="asset-bld-endo">
            <ellipse cx="0" cy="-15" rx="22" ry="12" fill="#0ea5e9" opacity="0.5"/>
            <path d="M -15,-15 Q 0,5 15,-15" fill="none" stroke="#0284c7" stroke-width="4"/>
            <path d="M -22,-15 A 22 12 0 0 1 22,-15" fill="none" stroke="#38bdf8" stroke-width="2"/>
            <circle cx="-5" cy="-15" r="3" fill="#bae6fd"/><circle cx="5" cy="-12" r="4" fill="#bae6fd"/>
        </g>

        <g id="asset-bld-mito">
            <ellipse cx="0" cy="-15" rx="28" ry="16" fill="#c2410c" transform="rotate(-15)"/>
            <ellipse cx="0" cy="-15" rx="24" ry="13" fill="#ea580c" transform="rotate(-15)"/>
            <path d="M-15,-15 Q-10,-5 -5,-20 T5,-10 T15,-20" fill="none" stroke="#fde047" stroke-width="2.5" transform="rotate(-15)"/>
            <circle cx="-10" cy="-5" r="2" fill="#fef08a"/>
        </g>

        <g id="asset-bld-ribo">
            <circle cx="0" cy="-12" r="10" fill="#a855f7"/>
            <circle cx="0" cy="-22" r="6" fill="#c084fc"/>
            <path d="M-15,-17 L15,-17" fill="none" stroke="#e9d5ff" stroke-width="1.5"/>
        </g>

        <g id="asset-bld-rer">
            <path d="M-25,0 Q-15,15 -5,-10 T15,5 T30,-15" fill="none" stroke="#d946ef" stroke-width="8" stroke-linecap="round"/>
            <path d="M-20,-10 Q-10,5 0,-20 T20,-5 T25,-25" fill="none" stroke="#e879f9" stroke-width="6" stroke-linecap="round"/>
            <circle cx="-15" cy="5" r="1.5" fill="#fdf4ff"/><circle cx="-5" cy="-5" r="1.5" fill="#fdf4ff"/>
            <circle cx="10" cy="10" r="1.5" fill="#fdf4ff"/><circle cx="-10" cy="-15" r="1.5" fill="#fdf4ff"/>
            <circle cx="15" cy="-10" r="1.5" fill="#fdf4ff"/>
        </g>

        <g id="asset-bld-golgi">
            <path d="M-20,-5 Q0,10 20,-5" fill="none" stroke="#10b981" stroke-width="6" stroke-linecap="round"/>
            <path d="M-25,-15 Q0,0 25,-15" fill="none" stroke="#34d399" stroke-width="6" stroke-linecap="round"/>
            <path d="M-20,-25 Q0,-10 20,-25" fill="none" stroke="#6ee7b7" stroke-width="6" stroke-linecap="round"/>
            <circle cx="-25" cy="-5" r="4" fill="#a7f3d0"/><circle cx="25" cy="-15" r="3" fill="#a7f3d0"/>
        </g>

        <g id="asset-bld-lyso">
            <circle cx="0" cy="-18" r="15" fill="#b91c1c"/>
            <circle cx="0" cy="-18" r="13" fill="#e11d48"/>
            <circle cx="-4" cy="-20" r="2.5" fill="#fda4af"/><circle cx="4" cy="-14" r="2" fill="#fda4af"/>
            <circle cx="2" cy="-24" r="2" fill="#fda4af"/><circle cx="-2" cy="-12" r="1.5" fill="#fda4af"/>
        </g>

        <g id="asset-bld-vacuole">
            <path d="M0,0 C30,5 35,-20 15,-35 C-5,-50 -35,-25 -20,-5 C-10,5 -5,0 0,0 Z" fill="rgba(56,189,248,0.4)" stroke="#7dd3fc" stroke-width="2"/>
            <circle cx="-5" cy="-20" r="4" fill="rgba(255,255,255,0.4)"/>
        </g>

        <g id="asset-bld-protea">
            <rect x="-10" y="-35" width="20" height="25" fill="#d97706" rx="2"/>
            <rect x="-12" y="-40" width="24" height="6" fill="#fbbf24" rx="1"/>
            <rect x="-12" y="-12" width="24" height="6" fill="#fbbf24" rx="1"/>
            <line x1="-5" y1="-33" x2="-5" y2="-13" stroke="#b45309" stroke-width="2"/>
            <line x1="5" y1="-33" x2="5" y2="-13" stroke="#b45309" stroke-width="2"/>
        </g>

        <g id="asset-bld-nucleus">
            <ellipse cx="0" cy="-20" rx="35" ry="22" fill="#312e81"/>
            <ellipse cx="0" cy="-22" rx="32" ry="19" fill="#4338ca"/>
            <circle cx="-15" cy="-15" r="2" fill="#1e1b4b"/><circle cx="20" cy="-18" r="2" fill="#1e1b4b"/>
            <circle cx="5" cy="-8" r="2" fill="#1e1b4b"/><circle cx="-10" cy="-32" r="2" fill="#1e1b4b"/>
            <circle cx="8" cy="-22" r="9" fill="#c084fc"/>
            <path d="M-20,-20 Q-10,-30 0,-20 T15,-25" fill="none" stroke="#e9d5ff" stroke-width="1.5" opacity="0.6"/>
        </g>

        <g id="fx-packet">
            <circle cx="0" cy="0" r="3" fill="#fff"/>
            <circle cx="0" cy="0" r="6" fill="none" stroke="#fff" stroke-width="1.5"/>
        </g>
    </defs>
</svg>

<div id="splash-screen">
    <div class="splash-content">
        <h1>CytoSim</h1>
        <h2>The Microverse</h2>
        <div class="splash-objectives">
            <h3>Your Mission: Eukaryotic Survival</h3>
            <p>You are the Nucleus. Your job is to command the cell, synthesize proteins, and prepare for Mitosis while avoiding toxic apoptosis or viral infection!</p>
            <ul>
                <li>Import <strong>Glucose</strong> (üç¨) through Membrane Pores.</li>
                <li>Burn Glucose in Mitochondria to create <strong>ATP Energy</strong> (‚ö°).</li>
                <li>Use ATP to run Ribosomes, creating structural <strong>Proteins</strong> (üß¨).</li>
                <li>Clear toxic <strong>Metabolic Waste</strong> (üóëÔ∏è) using Lysosomes or your cell will die!</li>
                <li>Beware of <strong>Viral RNA</strong> (ü¶†). If a virus strikes, build Proteasomes to cure infected organelles!</li>
            </ul>
        </div>
        <p class="splash-tip">Grade 8 Science: Build the Cytoskeleton first to connect your organelles.</p>
        <button class="btn btn-primary btn-start" onclick="Game.init()">Awaken Cell</button>
    </div>
</div>

<div id="app-container" style="display:none;">
    <header id="top-hud">
        <div class="hud-left">
            <div class="game-title"><h1>CytoSim</h1><span>Biology Sim</span></div>
            <div class="hud-metrics">
                <div class="metric-card metric-atp" data-tooltip="tt-atp">
                    <div class="metric-label"><span>ATP Energy</span><span>‚ö°</span></div>
                    <div class="metric-value"><span id="hud-val-atp">1,000</span><span class="metric-delta" id="hud-del-atp" style="color:var(--color-atp)">+0/s</span></div>
                </div>
                <div class="metric-card metric-glucose" data-tooltip="tt-glucose">
                    <div class="metric-label"><span>Glucose</span><span>üç¨</span></div>
                    <div class="metric-value"><span id="hud-val-glucose">0</span><span class="metric-cap"> / <span id="hud-cap-glucose">500</span></span></div>
                    <div class="metric-bar-bg"><div class="metric-bar-fill" id="hud-bar-glucose"></div></div>
                </div>
                <div class="metric-card metric-protein" data-tooltip="tt-protein">
                    <div class="metric-label"><span>Proteins</span><span>üß¨</span></div>
                    <div class="metric-value"><span id="hud-val-protein">0</span><span class="metric-cap"> / <span id="hud-cap-protein">500</span></span></div>
                    <div class="metric-bar-bg"><div class="metric-bar-fill" id="hud-bar-protein"></div></div>
                </div>
                <div class="metric-card metric-waste" data-tooltip="tt-waste">
                    <div class="metric-label"><span>Toxicity</span><span>üóëÔ∏è</span></div>
                    <div class="metric-value"><span id="hud-val-waste">0</span><span class="metric-cap">%</span></div>
                    <div class="metric-bar-bg"><div class="metric-bar-fill" id="hud-bar-waste"></div></div>
                </div>
                <div class="metric-card metric-health" data-tooltip="tt-health">
                    <div class="metric-label"><span>Health</span><span>‚ù§Ô∏è</span></div>
                    <div class="metric-value"><span id="hud-val-health">100</span><span class="metric-delta" id="hud-del-health" style="color:var(--text-muted)">Stable</span></div>
                    <div class="metric-bar-bg"><div class="metric-bar-fill" id="hud-bar-health" style="width:100%"></div></div>
                </div>
                <div class="metric-card metric-viral" id="metric-viral" style="display:none;" data-tooltip="tt-viral">
                    <div class="metric-label"><span style="color:var(--color-health)">Viral Load</span><span>ü¶†</span></div>
                    <div class="metric-value"><span id="hud-val-viral">0</span><span class="metric-cap">%</span></div>
                    <div class="metric-bar-bg"><div class="metric-bar-fill" id="hud-bar-viral" style="background:var(--color-health);"></div></div>
                </div>
            </div>
        </div>
        <div class="hud-right">
            <button class="btn btn-dash" onclick="UI.openDashboard('mitosis')">üß† Nucleus</button>
            <button class="btn btn-codex" onclick="UI.openCodex('intro')">üî¨ Textbook</button>
        </div>
    </header>

    <main id="game-area">
        <div id="apoptosis-overlay"></div>
        <svg id="svg-canvas"><g id="map-transform"><g id="layer-grid"></g><g id="layer-buildings"></g><g id="layer-particles"></g><g id="layer-ui"></g></g></svg>
    </main>

    <div id="build-mode-indicator"><span>Synthesizing: <strong id="bmi-name">---</strong></span><span class="bmi-esc">ESC cancel</span></div>
    <div id="quick-bar"></div>

    <aside id="sidebar-left" class="sidebar">
        <button class="sidebar-toggle-btn" onclick="UI.toggleSidebar('left')">‚óÄ</button>
        <div class="sidebar-header"><h2>Organelles</h2><button class="cancel-tool-btn" onclick="UI.selectTool(null)" id="btn-cancel-tool" style="display:none;">‚úï Cancel</button></div>
        <div class="sidebar-content" id="build-menu-container"></div>
    </aside>

    <aside id="sidebar-right" class="sidebar">
        <button class="sidebar-toggle-btn" onclick="UI.toggleSidebar('right')">‚ñ∂</button>
        <div id="quest-panel"><div class="quest-header">üìã Cellular Directive</div><div class="quest-title" id="ui-quest-title">...</div><div class="quest-desc" id="ui-quest-desc">...</div><div class="quest-tasks" id="ui-quest-tasks"></div></div>
        <div id="chart-panel">
            <div class="chart-header"><span>Metabolism Telemetry</span>
                <div class="chart-legend">
                    <div class="legend-item"><div class="legend-color" style="background:var(--color-atp)"></div>ATP</div>
                    <div class="legend-item"><div class="legend-color" style="background:var(--color-protein)"></div>Pro</div>
                    <div class="legend-item"><div class="legend-color" style="background:var(--color-waste)"></div>Tox</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="metrics-canvas"></canvas></div>
        </div>
    </aside>
</div>

<div style="display:none;">
    <div id="tt-atp"><h4>ATP Energy</h4><p>Adenosine Triphosphate. Generated by Mitochondria. Needed to build organelles and power synthesis.</p></div>
    <div id="tt-glucose"><h4>Glucose (Nutrients)</h4><p>Imported through the membrane. Required by Mitochondria to create ATP.</p></div>
    <div id="tt-protein"><h4>Proteins</h4><p>Built by Ribosomes. Required for cell growth, repair, and eventually Mitosis.</p></div>
    <div id="tt-waste"><h4>Metabolic Toxicity</h4><p>Waste products from cellular reactions. <span class="tooltip-req">If Toxicity > 70%, Cell Health drops! Build Lysosomes!</span></p></div>
    <div id="tt-health"><h4>Cell Health</h4><p>Overall stability. <span class="tooltip-req">If this hits 0%, Apoptosis (programmed death) occurs!</span></p></div>
    <div id="tt-viral"><h4>Viral Infection</h4><p>Foreign RNA is hijacking your Ribosomes! <span class="tooltip-req">If this hits 100%, the cell bursts (Lysis). Build a Proteasome to cure it!</span></p></div>
</div>

<div id="game-tooltip"></div>
<div id="notification-area"></div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-window" id="modal-standard"><div class="modal-header"><h2 class="modal-title" id="modal-std-title">Alert</h2><button class="modal-close-btn" onclick="UI.closeModal()">√ó</button></div><div class="modal-body" id="modal-std-body"></div><div class="modal-footer" id="modal-std-footer"><button class="btn btn-primary" onclick="UI.closeModal()">Continue</button></div></div>
    
    <div class="modal-window" id="modal-codex" style="display:none;">
        <div class="modal-header" style="background:rgba(56,189,248,0.08);border-bottom-color:var(--color-glucose);"><h2 class="modal-title" style="color:var(--color-glucose);">üî¨ Biology Textbook</h2><button class="modal-close-btn" onclick="UI.closeModal()">√ó</button></div>
        <div class="modal-body" style="padding:0;overflow:hidden;"><div class="dash-layout"><div class="dash-sidebar" id="codex-nav"></div><div class="dash-content" id="codex-content"></div></div></div>
        <div class="modal-footer"><button class="btn btn-codex" onclick="UI.closeModal()">Resume Activity</button></div>
    </div>

    <div class="modal-window" id="modal-dashboard" style="display:none; border-color:var(--color-nucleus); box-shadow:0 0 40px rgba(168,85,247,0.15);">
        <div class="modal-header" style="background:rgba(168,85,247,0.08);border-bottom-color:rgba(168,85,247,0.2);">
            <h2 class="modal-title" style="color:var(--color-nucleus);">üß† Nucleus Command</h2><button class="modal-close-btn" onclick="UI.closeModal()">√ó</button>
        </div>
        <div class="modal-body" style="padding:0;overflow:hidden;">
            <div class="dash-layout">
                <div class="dash-sidebar">
                    <button class="dash-tab" id="tab-btn-mitosis" onclick="UI.switchDashTab('mitosis')">üîÑ Cell Cycle (Mitosis)</button>
                    <button class="dash-tab" id="tab-btn-metabolism" onclick="UI.switchDashTab('metabolism')">‚ö° Metabolic Pathways</button>
                    <button class="dash-tab" id="tab-btn-genes" onclick="UI.switchDashTab('genes')">üß¨ Gene Expression</button>
                </div>
                <div class="dash-content" id="dash-content-area"></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-dash" onclick="UI.closeModal()">Close</button></div>
    </div>
</div>

<div id="inspector-panel"><div class="inspector-header"><div class="inspector-title"><h3 id="insp-name">Organelle</h3><span id="insp-cat">Category</span></div><button class="modal-close-btn" onclick="UI.closeInspector()" style="font-size:1.4rem;">√ó</button></div><div class="inspector-body" id="insp-desc"></div><div class="inspector-stats" id="insp-stats"></div><div id="insp-custom-controls" style="margin-top:10px;"></div></div>

<script>
// ============================================================================
// CODEX (EDUCATIONAL CONTENT)
// ============================================================================
const CODEX_DB = {
    intro: { title: "The Cell Factory", html: `<h2>Life's Building Blocks</h2><p>Cells are the fundamental units of life. Think of a cell like a microscopic city. It has a power plant (<strong>Mitochondria</strong>), factories (<strong>Ribosomes</strong>), waste disposal (<strong>Lysosomes</strong>), and a command center (<strong>Nucleus</strong>).</p><div class="edu-callout info"><span class="edu-callout-title">Simulation Goal</span>Your job is to build these organelles, maintain <strong>homeostasis</strong> (balance), and grow the cell until it can undergo Mitosis (division).</div>` },
    respiration: { title: "Cellular Respiration", html: `<h2>Mitochondria & ATP</h2><p><strong>Cellular respiration</strong> is how cells extract energy. <strong>Mitochondria</strong> take in Glucose and Oxygen, converting them into <strong>ATP</strong> (Adenosine Triphosphate).</p><h3>The Trade-off</h3><p>This process creates metabolic waste (like free radicals). If waste builds up, the cell becomes toxic.</p><div class="edu-callout"><span class="edu-callout-title">Game Mechanic</span>Build Membrane Pores to get Glucose, then build Mitochondria to make ATP. Without ATP, your cell shuts down!</div>` },
    proteins: { title: "Protein Synthesis", html: `<h2>Ribosomes & The ER</h2><p>Proteins do all the heavy lifting in your body. <strong>Ribosomes</strong> read instructions from the Nucleus to stitch amino acids into proteins. The <strong>Rough ER</strong> folds these proteins into useful shapes.</p><div class="edu-callout"><span class="edu-callout-title">Game Mechanic</span>Ribosomes consume huge amounts of ATP and Nutrients. You need Proteins to advance the Cell Cycle.</div>` },
    waste: { title: "Waste Management", html: `<h2>Lysosomes</h2><p>Living is messy. Chemical reactions produce toxic byproducts. <strong>Lysosomes</strong> are vesicles filled with enzymes that digest cellular garbage.</p><div class="edu-callout warning"><span class="edu-callout-title">Apoptosis</span>If Toxicity exceeds 70%, Cell Health drops. If Health hits 0%, the cell triggers <strong>Apoptosis</strong> (programmed cell death) and you lose massive energy!</div>` },
    virus: { title: "Viral Infection", html: `<h2>Viral RNA Hijacking</h2><p>Viruses aren't technically alive. They enter a cell and hijack the <strong>Ribosomes</strong> to make copies of themselves instead of normal proteins.</p><div class="edu-callout warning"><span class="edu-callout-title">Game Mechanic</span>Infected Ribosomes turn red, drain ATP, and produce <strong>Viral Load</strong>. Build a <strong>Proteasome</strong> to cure them before the cell bursts (Lysis)!</div>` },
    mitosis: { title: "Mitosis (Cell Division)", html: `<h2>The Cell Cycle</h2><p>To divide, a cell progresses through phases: <strong>G1</strong> (growth), <strong>S</strong> (DNA replication), <strong>G2</strong> (preparation), and <strong>M phase</strong> (Mitosis).</p><div class="edu-callout info"><span class="edu-callout-title">Game Mechanic</span>Open the Nucleus to synthesize DNA base pairs using ATP and Nutrients. Reaching Mitosis levels up your Cell Generation!</div>` }
};

// ============================================================================
// BUILDINGS (ORGANELLES)
// ============================================================================
const BUILDINGS = {
    road: { id:'road', name:'Cytoskeleton', category:'Transport', svg:'asset-tile-road', cost:10, icon:'üï∏Ô∏è', desc:'Microtubules. Connects organelles so transport vesicles can travel.' },
    pore: { id:'pore', name:'Membrane Pore', category:'Intake', svg:'asset-bld-pore', cost:100, icon:'üö™', desc:'Passive transport. Steadily imports Glucose from the blood.', stats:{genGlu: 5} },
    endo: { id:'endo', name:'Endocytosis Pump', category:'Intake', svg:'asset-bld-endo', cost:300, icon:'üíß', desc:'Active transport. Burns ATP to engulf massive amounts of Nutrients.', stats:{genGlu: 20, costAtp: 15} },
    mito: { id:'mito', name:'Mitochondrion', category:'Energy', svg:'asset-bld-mito', cost:500, icon:'‚ö°', desc:'Cellular Respiration! Burns Glucose to generate massive ATP.', stats:{genAtp: 40, costGlu: 8, genWaste: 2.0} },
    ribo: { id:'ribo', name:'Ribosome', category:'Synthesis', svg:'asset-bld-ribo', cost:400, icon:'üî¥', desc:'Reads mRNA to build Proteins. Needs ATP and Nutrients.', stats:{genPro: 5, costAtp: 10, costGlu: 5, genWaste: 1.0} },
    rer: { id:'rer', name:'Rough ER', category:'Synthesis', svg:'asset-bld-rer', cost:1200, icon:'„Ä∞Ô∏è', desc:'Massive protein-folding factory. High output, high energy cost.', stats:{genPro: 20, costAtp: 35, costGlu: 15, genWaste: 3.5} },
    golgi: { id:'golgi', name:'Golgi Apparatus', category:'Packaging', svg:'asset-bld-golgi', cost:2500, icon:'ü•û', desc:'Packages proteins and exports them to the host body for ATP rewards.', stats:{costPro: 10, costAtp: 20, genAtpBase: 100} },
    lyso: { id:'lyso', name:'Lysosome', category:'Cleanup', svg:'asset-bld-lyso', cost:600, icon:'üü°', desc:'Digestive vesicle. Breaks down toxic Metabolic Waste.', stats:{clearWaste: 4.0, costAtp: 5} },
    vac_s: { id:'vac_s', name:'Storage Vacuole', category:'Storage', svg:'asset-bld-vacuole', cost:800, icon:'ü´ß', desc:'Expands the cell\'s capacity to store Nutrients and Proteins.', stats:{addCap: 1000} },
    protea: { id:'protea', name:'Proteasome', category:'Defense', svg:'asset-bld-protea', cost:3000, icon:'üõ°Ô∏è', desc:'Destroys viral RNA and damaged proteins. Cures infected Ribosomes!', stats:{costAtp: 25, isDefense: true} },
    nucleus: { id:'nucleus', name:'Nucleus (HQ)', category:'Command', svg:'asset-bld-nucleus', cost:5000, icon:'üß†', desc:'The brain of the cell. Open the Dashboard to trigger Mitosis.', stats:{isNucleus:true, costAtp: 20} }
};

// ============================================================================
// STATE & SIMULATION LOGIC
// ============================================================================
const State = {
    atp: 2000,
    glucose: 0, 
    protein: 0, 
    capacity: 500, // Base cap for both
    toxicity: 0, // 0-100
    health: 100, // 0-100
    viralLoad: 0, virusActive: false,
    
    cellGeneration: 1,
    chromosomes: 0,
    
    // Toggles
    pathways: { fermentation: false, exportDrive: false, phagocytosis: false },
    genes: { antioxidants: false, interferon: false },
    
    isApoptosis: false, apoptosisTimer: 0,
    grid:[], buildings:[], particles:[],
    selectedTool:null, missionIndex:0, isPaused:false, lastTickTime:0, dragDistance:0,
    historyAtp:Array(30).fill(0), historyPro:Array(30).fill(0), historyTox:Array(30).fill(0),
    wildcardTimer:0, wildcardInterval:140, totalTicks:0,

    init(){ for(let y=0;y<Config.gridSize;y++){let r=[];for(let x=0;x<Config.gridSize;x++)r.push(null);this.grid.push(r);} },
    countBuilding(id){ return this.buildings.filter(b=>b.id===id).length; },

    processTick(){
        if(this.isPaused) return;
        this.totalTicks++;
        let dAtp=0, dGlu=0, dPro=0, dTox=0;
        this.capacity = 500; 

        // Apoptosis Stun
        if(this.isApoptosis){ 
            this.apoptosisTimer--; 
            if(this.apoptosisTimer<=0){
                this.isApoptosis=false;
                this.health=50; this.toxicity=0; this.atp+=500; 
                UI.toast("Cell recovered from shock. Homeostasis re-established.","success");
                UI.updateHUD(0, 0);
            } 
            document.getElementById('apoptosis-overlay').classList.toggle('active', this.isApoptosis);
            UI.updateHUD(0, -15);
            return; 
        }

        // Toggles Modifiers
        if(this.pathways.fermentation) { dAtp+=40; dTox+=4.0; dGlu-=10; } // Fast ATP, high waste
        if(this.genes.antioxidants) { dAtp-=30; dTox-=2.0; }
        if(this.genes.interferon) { dAtp-=60; this.viralLoad -= 1.5; }

        let rawToxAdd=0, rawToxRem=0;
        let bldInfectedChange = false;
        
        this.buildings.forEach(b=>{
            let d=BUILDINGS[b.id];
            
            if(d.stats && d.stats.addCap) this.capacity += d.stats.addCap;
            
            let reqAtp = d.stats ? (d.stats.costAtp || 0) : 0;
            let reqGlu = d.stats ? (d.stats.costGlu || 0) : 0;
            let reqPro = d.stats ? (d.stats.costPro || 0) : 0;

            // Viral override
            if (b.infected) {
                reqAtp = 25; reqGlu = 0; reqPro = 0;
            } else if (d.id === 'golgi' && this.pathways.exportDrive) {
                reqAtp *= 2; reqPro *= 2;
            }

            let canRun = true;
            if (reqAtp > 0 && this.atp + dAtp < reqAtp) canRun = false;
            if (reqGlu > 0 && this.glucose + dGlu < reqGlu) canRun = false;
            if (reqPro > 0 && this.protein + dPro < reqPro) canRun = false;

            if (canRun) {
                dAtp -= reqAtp;
                dGlu -= reqGlu;
                dPro -= reqPro;

                if (b.infected) {
                    this.viralLoad += 2.0;
                    rawToxAdd += 4.0;
                    if (Math.random() < 0.15) this.spawnPacket(b.x, b.y, 'virus');
                } else if (d.stats) {
                    if(d.stats.genGlu) {
                        let gain = d.stats.genGlu;
                        if (d.id === 'endo' && this.pathways.phagocytosis) gain *= 2;
                        dGlu += gain;
                        
                        // Virus Entry Risks
                        if (d.id === 'endo' && this.pathways.phagocytosis && Math.random() < 0.04) {
                            if (!this.virusActive) {
                                this.virusActive = true;
                                UI.triggerNarrativeEvent("ü¶† Viral Breach!", "Phagocytosis brought in a hostile virus! It will hijack your Ribosomes to replicate itself. Build Proteasomes or activate Interferon immediately!", "virus");
                            }
                            this.spawnPacket(b.x, b.y, 'virus');
                        }
                        if (this.virusActive && Math.random() < 0.05) this.spawnPacket(b.x, b.y, 'virus');
                    }
                    if(d.stats.genAtp) dAtp += d.stats.genAtp;
                    if(d.stats.genAtpBase) {
                        let payout = d.stats.genAtpBase * this.cellGeneration;
                        if (this.pathways.exportDrive) payout *= 2;
                        dAtp += payout;
                    }
                    if(d.stats.genPro) dPro += d.stats.genPro;
                    if(d.stats.genWaste) rawToxAdd += d.stats.genWaste;
                    if(d.stats.clearWaste) rawToxRem += d.stats.clearWaste;

                    // Proteasome curing
                    if(d.id === 'protea' && this.virusActive && Math.random() < 0.4) {
                        this.spawnPacket(b.x, b.y, 'cure');
                    }
                }
                
                // Normal Visuals
                if(!b.infected && d.stats && (d.stats.genPro || d.stats.genAtpBase || d.stats.genGlu) && Math.random()<0.25) {
                    this.spawnPacket(b.x, b.y, 'normal');
                }
            } else if (!b.infected && d.id !== 'road') {
                if(Math.random()<0.05) R.floatText("Stalled", b.x, b.y, "txt-expense");
            }
        });

        // Toxicity Calculation
        dTox = rawToxAdd - rawToxRem - 0.2; // Passive diffusion
        this.toxicity = Math.max(0, Math.min(100, this.toxicity + dTox));

        // Health / Homeostasis
        let dHealth = 0;
        if (this.toxicity > 70) dHealth = - ((this.toxicity - 60) / 10); // Exponential damage
        else if (this.toxicity < 40) dHealth = +1.0; 

        if (this.viralLoad > 0) dHealth -= 1.0;

        this.health = Math.max(0, Math.min(100, this.health + dHealth));

        if(this.health <= 0){
            this.isApoptosis=true; this.apoTimer=15;
            this.atp = Math.floor(this.atp / 2); this.protein = 0;
            UI.toast("üö® APOPTOSIS TRIGGERED! Severe shock. Cell shutting down.","error");
            UI.triggerNarrativeEvent("‚ò£Ô∏è Apoptosis (Programmed Death)", "Cellular health reached 0 due to extreme metabolic stress. The cell has initiated programmed cell death to protect the organism. All functions are frozen while emergency repairs happen. You lost all stored proteins and half your ATP. Build Lysosomes!", "waste");
            return;
        }

        // Virus Resolution
        if (this.virusActive) {
            this.viralLoad = Math.max(0, this.viralLoad);
            let infectedBlds = this.buildings.filter(b => b.infected);
            
            // Interferon passive cure
            if (this.genes.interferon && Math.random() < 0.1 && infectedBlds.length > 0) {
                infectedBlds[Math.floor(Math.random() * infectedBlds.length)].infected = false;
                bldInfectedChange = true;
            }
            
            if (infectedBlds.length === 0 && this.viralLoad <= 0 && !this.pathways.phagocytosis) {
                this.virusActive = false;
                UI.toast("Viral infection cleared!", "success");
            }
            if (this.viralLoad >= 100) {
                this.isPaused = true;
                let modal=document.getElementById('modal-standard');
                modal.style.display='flex'; modal.className='modal-window theme-wildcard';
                document.getElementById('modal-std-title').innerHTML=`<span>üíÄ Lysis (Game Over)</span>`;
                document.getElementById('modal-std-body').innerHTML=`<div class="event-main-text">The Viral Load reached 100%. The cell membrane ruptured, releasing millions of new viruses into the organism. Refresh the page to try again.</div>`;
                document.getElementById('modal-std-footer').innerHTML=``;
                document.getElementById('modal-overlay').classList.add('active');
                return;
            }
            document.getElementById('metric-viral').style.display = 'flex';
            document.getElementById('hud-val-viral').innerText = Math.floor(this.viralLoad);
            document.getElementById('hud-bar-viral').style.width = this.viralLoad + '%';
        } else {
            document.getElementById('metric-viral').style.display = 'none';
        }

        // Apply Resources
        this.atp = Math.max(0, this.atp + dAtp);
        this.glucose = Math.max(0, Math.min(this.capacity, this.glucose + dGlu));
        this.protein = Math.max(0, Math.min(this.capacity, this.protein + dPro));

        // Wildcards
        this.wildcardTimer++;
        if(this.wildcardTimer>=this.wildcardInterval){this.wildcardTimer=0;this.wildcardInterval=120+Math.floor(Math.random()*60);this.triggerWildcard();}

        // History & Update
        if(bldInfectedChange) R.renderStatic();
        this.historyAtp.shift(); this.historyAtp.push(dAtp);
        this.historyPro.shift(); this.historyPro.push(dPro);
        this.historyTox.shift(); this.historyTox.push(this.toxicity);
        ChartMgr.draw();
        UI.updateHUD(dAtp, dHealth);
        MissionMgr.check();
    },

    getPhaseReqs() {
        // G1 -> S -> G2 -> M
        let gen = this.cellGeneration;
        return {
            dnaReq: 100, // fixed percentage
            dnaAtpCost: 3000 * gen,
            dnaGluCost: 1000 * gen,
            proReq: 2000 * gen,
            atpReq: 4000 * gen
        };
    },

    buyDNA() {
        let req = this.getPhaseReqs();
        if (this.atp >= req.dnaAtpCost && this.glucose >= req.dnaGluCost && !this.dnaReplicated) {
            this.atp -= req.dnaAtpCost;
            this.glucose -= req.dnaGluCost;
            this.dnaReplicated = true;
            UI.refreshDashboardIfOpen();
        }
    },

    triggerMitosis() {
        let req = this.getPhaseReqs();
        if(this.atp >= req.atpReq && this.protein >= req.proReq && this.dnaReplicated && this.health >= 80) {
            this.atp -= req.atpReq;
            this.protein -= req.proReq;
            this.dnaReplicated = false;
            this.cellGeneration++;
            UI.closeModal();
            UI.triggerNarrativeEvent("üéâ Mitosis Complete!", `Your cell successfully divided! You are now playing as Daughter Cell Generation ${this.cellGeneration}. Your Golgi Apparatus will now yield massive ATP multipliers. Keep surviving!`, "mitosis");
            MissionMgr.check();
        }
    },

    triggerWildcard(){
        let WILDCARDS = [
            { title:"ü¶† Free Virus", text:"Foreign viral RNA has breached the membrane! It will infect ribosomes and generate massive waste.", effects:{tox:20, health:-10}, condition:()=>!this.genes.interferon },
            { title:"üç¨ Sugar Spike", text:"The organism just ate a heavy carbohydrate meal. A massive influx of glucose enters the cell.", effects:{glu:1000}, condition:()=>State.countBuilding('pore')>0 },
            { title:"üèÉ‚Äç‚ôÇÔ∏è Exercise Stress", text:"The organism is exercising. Energy demand spikes, draining your reserves.", effects:{atp:-1500}, condition:()=>State.atp>2000 },
            { title:"üõ°Ô∏è Antioxidant Intake", text:"Nutrients neutralized free radicals, clearing metabolic waste.", effects:{tox:-40, health:15}, condition:()=>State.toxicity>40 },
            { title:"üß¨ Enzyme Burst", text:"A burst of metabolic efficiency temporarily grants free proteins.", effects:{pro:600}, condition:()=>State.countBuilding('ribo')>0 }
        ];
        let eligible=WILDCARDS.filter(w=>w.condition());
        if(eligible.length===0)return;
        let wc=eligible[Math.floor(Math.random()*eligible.length)];
        
        if(wc.effects.tox)this.toxicity=Math.max(0,Math.min(100,this.toxicity+wc.effects.tox));
        if(wc.effects.health)this.health=Math.max(0,Math.min(100,this.health+wc.effects.health));
        if(wc.effects.atp)this.atp=Math.max(0,this.atp+wc.effects.atp);
        if(wc.effects.glu)this.glucose=Math.min(this.capacity,this.glucose+(wc.effects.glu||0));
        if(wc.effects.pro)this.protein=Math.min(this.capacity,this.protein+(wc.effects.pro||0));
        
        if (wc.title==="ü¶† Free Virus" && !this.virusActive) { this.virusActive=true; this.spawnPacket(this.buildings.find(b=>b.id==='pore')?.x||1, 1, 'virus'); }

        State.isPaused=true;
        let modal=document.getElementById('modal-standard');
        modal.style.display='flex';modal.className='modal-window theme-wildcard';
        document.getElementById('modal-std-title').innerHTML=`<span>${wc.title}</span>`;
        let effHtml='';
        if(wc.effects.tox)effHtml+=`<span class="${wc.effects.tox<0?'eff-pos':'eff-neg'}">Toxicity ${wc.effects.tox>0?'+':''}${wc.effects.tox}%</span>`;
        if(wc.effects.health)effHtml+=`<span class="${wc.effects.health>0?'eff-pos':'eff-neg'}">Health ${wc.effects.health>0?'+':''}${wc.effects.health}</span>`;
        if(wc.effects.atp)effHtml+=`<span class="${wc.effects.atp>0?'eff-pos':'eff-neg'}">ATP ${wc.effects.atp>0?'+':''}${wc.effects.atp}</span>`;
        if(wc.effects.glu)effHtml+=`<span class="eff-pos">Glucose +${wc.effects.glu}</span>`;
        if(wc.effects.pro)effHtml+=`<span class="eff-pos">Proteins +${wc.effects.pro}</span>`;
        
        document.getElementById('modal-std-body').innerHTML=`<div class="event-main-text">${wc.text}</div><div style="text-align:center;"><div class="choice-effects" style="justify-content:center;">${effHtml}</div></div>`;
        document.getElementById('modal-std-footer').innerHTML=`<button class="btn btn-primary" onclick="UI.closeModal()">React</button>`;
        document.getElementById('modal-overlay').classList.add('active');
    },

    spawnPacket(x,y, type){
        let targets = ['Storage', 'Command'];
        if (type === 'virus' || type === 'cure') targets = ['Synthesis', 'Packaging'];
        let p = Pathing.findPath(x, y, targets);
        if (p && p.length > 0) this.particles.push({ path: p, pathIdx: 0, x, y, px: 0, py: 0, type: type });
    },
    updateParticles(){
        let bldChange = false;
        for(let i=this.particles.length-1;i>=0;i--){
            let p=this.particles[i];
            if(p.pathIdx>=p.path.length-1){
                let bAtDest = this.buildings.find(b => b.x === p.x && b.y === p.y);
                if (bAtDest && BUILDINGS[bAtDest.id].category) {
                    if (p.type === 'virus' && !bAtDest.infected && ['Synthesis', 'Packaging'].includes(BUILDINGS[bAtDest.id].category)) {
                        bAtDest.infected = true; bldChange = true;
                    }
                    if (p.type === 'cure' && bAtDest.infected) {
                        bAtDest.infected = false; bldChange = true;
                        this.viralLoad = Math.max(0, this.viralLoad - 10);
                    }
                }
                this.particles.splice(i,1);
                continue;
            }
            let t=p.path[p.pathIdx+1];
            let s = p.type==='cure'? 0.2 : 0.15; // Cures move faster
            let dx=t.x-p.x, dy=t.y-p.y;
            p.px+=dx*s; p.py+=dy*s;
            if(Math.abs(p.px)>=1||Math.abs(p.py)>=1){ p.x=t.x; p.y=t.y; p.px=0; p.py=0; p.pathIdx++; }
        }
        if (bldChange) R.renderStatic();
    }
};

const Config = { gridSize:16, tileW:120, tileH:60, tickMs:1000 };

class PQ{constructor(){this.e=[]}isEmpty(){return this.e.length===0}put(i,p){this.e.push({i,p});this.e.sort((a,b)=>a.p-b.p)}get(){return this.e.shift().i}}
class PF{constructor(s,g){this.s=s;this.g=g}
findPath(sx,sy,cats){const k=(x,y)=>`${x},${y}`;let f=new PQ();f.put({x:sx,y:sy},0);let cf=new Map(),cs=new Map();cf.set(k(sx,sy),null);cs.set(k(sx,sy),0);let found=null,it=0;
while(!f.isEmpty()&&it<400){it++;let c=f.get();let ct=this.g(c.x,c.y);if(ct&&ct!=='road'){let d=BUILDINGS[ct];if(d&&cats.includes(d.category)){found=c;break;}}
[{x:c.x+1,y:c.y},{x:c.x-1,y:c.y},{x:c.x,y:c.y+1},{x:c.x,y:c.y-1}].forEach(n=>{if(n.x<0||n.x>=this.s||n.y<0||n.y>=this.s)return;let nt=this.g(n.x,n.y);let w=(nt==='road'||(nt&&BUILDINGS[nt]&&cats.includes(BUILDINGS[nt].category)));if(!w)return;let nc=cs.get(k(c.x,c.y))+1;if(!cs.has(k(n.x,n.y))||nc<cs.get(k(n.x,n.y))){cs.set(k(n.x,n.y),nc);f.put(n,nc);cf.set(k(n.x,n.y),c);}});}
if(!found)return null;let c=found,p=[];while(c&&(c.x!==sx||c.y!==sy)){p.push(c);c=cf.get(k(c.x,c.y));}return p.reverse();}}
const Pathing=new PF(Config.gridSize,(x,y)=>State.grid[y]?.[x]);

// ============================================================================
// RENDERER
// ============================================================================
const R={
    gGrid:null,gBld:null,gPart:null,gUi:null,gT:null,panX:0,panY:0,zoom:1,tiles:{},
    iso(cx,cy){return{x:(cx-cy)*(Config.tileW/2),y:(cx+cy)*(Config.tileH/2)}},
    s2i(sx,sy){let lx=(sx-this.panX)/this.zoom,ly=(sy-this.panY)/this.zoom;let tw=Config.tileW/2,th=Config.tileH/2;return{x:Math.floor((ly/th+lx/tw)/2),y:Math.floor((ly/th-lx/tw)/2)}},
    cam(){this.gT.setAttribute('transform',`translate(${this.panX},${this.panY}) scale(${this.zoom})`);},
    initGrid(){
        this.gGrid=document.getElementById('layer-grid');this.gBld=document.getElementById('layer-buildings');this.gPart=document.getElementById('layer-particles');this.gUi=document.getElementById('layer-ui');this.gT=document.getElementById('map-transform');
        this.panX=window.innerWidth/2;this.panY=100;this.gGrid.innerHTML='';this.tiles={};
        for(let y=0;y<Config.gridSize;y++)for(let x=0;x<Config.gridSize;x++){let p=this.iso(x,y);let g=document.createElementNS('http://www.w3.org/2000/svg','g');g.setAttribute('transform',`translate(${p.x},${p.y})`);g.setAttribute('class','tile-interactive');let u=document.createElementNS('http://www.w3.org/2000/svg','use');u.setAttribute('href','#asset-tile-base');u.setAttribute('class','iso-base-tile');u.id=`tile-${x}-${y}`;g.appendChild(u);this.gGrid.appendChild(g);this.tiles[`${x},${y}`]=g;}
        this.cam();
    },
    hlTile(x,y,m){Object.values(this.tiles).forEach(e=>{e.classList.remove('tile-highlight-valid','tile-highlight-invalid','tile-highlight-occupied');});if(x===null)return;let e=this.tiles[`${x},${y}`];if(!e)return;if(m==='valid')e.classList.add('tile-highlight-valid');else if(m==='invalid')e.classList.add('tile-highlight-invalid');else if(m==='occupied')e.classList.add('tile-highlight-occupied');},
    renderStatic(){
        this.gBld.innerHTML='';let rl=[];
        for(let y=0;y<Config.gridSize;y++)for(let x=0;x<Config.gridSize;x++){let id=State.grid[y][x];if(id){rl.push({x,y,id});if(id==='road')document.getElementById(`tile-${x}-${y}`).setAttribute('href','#asset-tile-road');}}
        rl.sort((a,b)=>(a.x+a.y)-(b.x+b.y));
        rl.forEach(i=>{
            if(i.id==='road')return;
            let p=this.iso(i.x,i.y);let u=document.createElementNS('http://www.w3.org/2000/svg','use');
            u.setAttribute('href','#'+BUILDINGS[i.id].svg);u.setAttribute('transform',`translate(${p.x},${p.y})`);
            
            let bData = State.buildings.find(b => b.x === i.x && b.y === i.y);
            let classes = 'iso-building';
            if (bData && bData.infected) classes += ' bld-infected';
            u.setAttribute('class', classes);
            
            this.gBld.appendChild(u);
        });
    },
    renderDynamic(){
        this.gPart.innerHTML='';
        State.particles.forEach(p=>{
            let lx=p.x+p.px,ly=p.y+p.py;let pos=this.iso(lx,ly);
            let u=document.createElementNS('http://www.w3.org/2000/svg','use');
            u.setAttribute('href','#fx-packet');u.setAttribute('transform',`translate(${pos.x},${pos.y-10})`);
            
            let pClass = 'data-packet';
            if (p.type === 'virus') pClass = 'virus-packet';
            else if (p.type === 'cure') pClass = 'cure-packet';
            u.setAttribute('class', pClass);
            
            if(p.type === 'normal') u.style.fill='var(--color-protein)';
            this.gPart.appendChild(u);
        });
        this.gUi.innerHTML='';
        if(State.selectedTool&&UI.hover){
            let hx=UI.hover.x,hy=UI.hover.y;
            if(hx>=0&&hx<Config.gridSize&&hy>=0&&hy<Config.gridSize){
                let p=this.iso(hx,hy);let d=BUILDINGS[State.selectedTool];let ok=(State.grid[hy][hx]===null&&State.atp>=d.cost);
                let u=document.createElementNS('http://www.w3.org/2000/svg','use');u.setAttribute('href','#'+d.svg);u.setAttribute('transform',`translate(${p.x},${p.y})`);
                u.setAttribute('class',`iso-building ${ok?'ghost-valid':'ghost-invalid'}`);this.gUi.appendChild(u);
                this.hlTile(hx,hy,ok?'valid':State.grid[hy][hx]?'occupied':'invalid');
            }
        }else this.hlTile(null,null);
    },
    floatText(t,x,y,c){let p=this.iso(x,y);let sx=p.x*this.zoom+this.panX,sy=p.y*this.zoom+this.panY-40;let d=document.createElement('div');d.className=`canvas-float-text ${c}`;d.innerText=t;d.style.left=sx+'px';d.style.top=sy+'px';document.getElementById('game-area').appendChild(d);setTimeout(()=>d.remove(),1500);}
};

// ============================================================================
// UI & DASHBOARD
// ============================================================================
const UI={
    hover:null, dashTabOpen: 'mitosis',
    init(){this.buildSidebar();this.buildQB();this.setupInputs();this.setupTT();ChartMgr.init();},
    buildQB(){
        const bar=document.getElementById('quick-bar');bar.innerHTML='';
        const order=['road','pore','endo','mito','ribo','rer','golgi','lyso','vac_s','protea'];
        const keys=['1','2','3','4','5','6','7','8','9','0'];
        order.forEach((id,i)=>{
            if(i===1||i===3||i===4||i===7||i===9){let d=document.createElement('div');d.className='qb-divider';bar.appendChild(d);}
            let b=BUILDINGS[id];b._hk=keys[i];let item=document.createElement('div');item.className='qb-item';item.id=`qb-${id}`;
            let fcost = b.cost>=1000 ? (b.cost/1000)+'k' : b.cost;
            item.innerHTML=`<span class="qb-icon">${b.icon||'‚ñ™'}</span><span class="qb-label">${b.name.split(' ')[0]}</span><span class="qb-cost">${fcost}‚ö°</span><span class="qb-key">${keys[i]}</span>`;
            item.title=`${b.name} (${b.cost} ATP)`;item.onclick=()=>this.selectTool(id);bar.appendChild(item);
        });
    },
    buildSidebar(){
        const c=document.getElementById('build-menu-container');c.innerHTML='';let cats={};
        for(let k in BUILDINGS){let cat=BUILDINGS[k].category;if(!cats[cat])cats[cat]=[];cats[cat].push(BUILDINGS[k]);}
        for(let cat in cats){let cd=document.createElement('div');cd.innerHTML=`<div class="build-category-title">${cat}</div>`;
        cats[cat].forEach(b=>{let card=document.createElement('div');card.className='build-card';card.id=`btn-build-${b.id}`;
        let sh='';
        if(b.stats&&b.stats.genGlu)sh+=`<span class="stat-badge glu-gen">+${b.stats.genGlu} Glu</span>`;
        if(b.stats&&b.stats.costGlu)sh+=`<span class="stat-badge glu-cost">-${b.stats.costGlu} Glu</span>`;
        if(b.stats&&b.stats.genAtp)sh+=`<span class="stat-badge atp-gen">+${b.stats.genAtp} ATP</span>`;
        if(b.stats&&b.stats.costAtp)sh+=`<span class="stat-badge atp-cost">-${b.stats.costAtp} ATP</span>`;
        if(b.stats&&b.stats.genPro)sh+=`<span class="stat-badge pro-gen">+${b.stats.genPro} Pro</span>`;
        if(b.stats&&b.stats.genWaste)sh+=`<span class="stat-badge wst-gen">+Tox</span>`;
        if(b.stats&&b.stats.clearWaste)sh+=`<span class="stat-badge wst-rem">-Tox</span>`;
        if(b.stats&&b.stats.addCap)sh+=`<span class="stat-badge cap-add">+${b.stats.addCap} Cap</span>`;
        if(b.stats&&b.stats.isNucleus)sh+=`<span class="stat-badge div">Dashboard</span>`;
        if(b.stats&&b.stats.isDefense)sh+=`<span class="stat-badge div">Antiviral</span>`;
        card.innerHTML=`<div class="build-card-header"><span class="build-name">${b.icon||''} ${b.name}</span><span class="build-cost">${b.cost.toLocaleString()}‚ö°</span></div><div class="build-desc">${b.desc}</div><div class="build-stats">${sh}</div>`;
        card.onclick=()=>{if(!card.classList.contains('locked'))this.selectTool(b.id);};cd.appendChild(card);});c.appendChild(cd);}
    },
    selectTool(id){
        State.selectedTool=id;const ga=document.getElementById('game-area');const bmi=document.getElementById('build-mode-indicator');
        document.querySelectorAll('.build-card').forEach(e=>e.classList.remove('selected'));document.querySelectorAll('.qb-item').forEach(e=>e.classList.remove('qb-selected'));
        if(id){let e1=document.getElementById(`btn-build-${id}`),e2=document.getElementById(`qb-${id}`);if(e1)e1.classList.add('selected');if(e2)e2.classList.add('qb-selected');document.getElementById('btn-cancel-tool').style.display='block';ga.classList.add('placing');bmi.classList.add('active');document.getElementById('bmi-name').innerText=BUILDINGS[id].name;this.closeInspector();}
        else{document.getElementById('btn-cancel-tool').style.display='none';ga.classList.remove('placing');bmi.classList.remove('active');R.hlTile(null,null);}
    },
    updateLocks(){for(let k in BUILDINGS){let e=document.getElementById(`btn-build-${k}`),q=document.getElementById(`qb-${k}`);if(e){if(State.atp<BUILDINGS[k].cost)e.classList.add('locked');else e.classList.remove('locked');}if(q){if(State.atp<BUILDINGS[k].cost)q.classList.add('qb-locked');else q.classList.remove('qb-locked');}}},
    updateHUD(dAtp, dHealth){
        const f=n=>Math.floor(n).toLocaleString();
        document.getElementById('hud-val-atp').innerText=f(State.atp);
        let bd=document.getElementById('hud-del-atp');bd.innerText=`${dAtp>=0?'+':''}${f(dAtp)}/s`;bd.style.color=dAtp>=0?'var(--color-health)':'var(--color-danger)';
        
        document.getElementById('hud-val-glucose').innerText=f(State.glucose);document.getElementById('hud-cap-glucose').innerText=f(State.capacity);
        document.getElementById('hud-bar-glucose').style.width=Math.min(100,State.glucose/Math.max(1,State.capacity)*100)+'%';
        
        document.getElementById('hud-val-protein').innerText=f(State.protein);document.getElementById('hud-cap-protein').innerText=f(State.capacity);
        document.getElementById('hud-bar-protein').style.width=Math.min(100,State.protein/Math.max(1,State.capacity)*100)+'%';
        
        document.getElementById('hud-val-waste').innerText=Math.floor(State.toxicity);
        document.getElementById('hud-bar-waste').style.width=State.toxicity+'%';
        this.toggleWarn('waste',State.toxicity>70, 'metric-warning-waste');
        
        document.getElementById('hud-val-health').innerText=Math.floor(State.health);document.getElementById('hud-bar-health').style.width=State.health+'%';
        let hd=document.getElementById('hud-del-health');if(dHealth>0){hd.innerText="Healing";hd.style.color="var(--color-glucose)";}else if(dHealth<0){hd.innerText="Dropping!";hd.style.color="var(--color-health)";}else{hd.innerText="Stable";hd.style.color="var(--text-muted)";}
        this.toggleWarn('health',State.health<40, 'metric-warning-health');
        
        this.updateLocks();
        document.getElementById('apoptosis-overlay').classList.toggle('active',State.isApoptosis);
    },
    toggleWarn(m,w, customClass='metric-warning'){const c=document.querySelector(`.metric-${m}`);
        if(w) { c.classList.add(customClass); } else { c.classList.remove(`metric-warning-waste`, `metric-warning-health`); }
    },
    toast(msg,type='info'){const a=document.getElementById('notification-area');const t=document.createElement('div');t.className=`toast-msg ${type}`;let ic='‚ÑπÔ∏è',ti='Cell OS';if(type==='success'){ic='‚úì';ti='Success';}if(type==='error'){ic='‚ö†Ô∏è';ti='Danger';}if(type==='warning'){ic='‚ö†';ti='Warning';}
    t.innerHTML=`<div class="toast-icon">${ic}</div><div class="toast-content"><div class="toast-title">${ti}</div><div class="toast-desc">${msg}</div></div>`;a.appendChild(t);setTimeout(()=>{if(t.parentNode)t.remove();},5500);},
    toggleSidebar(s){const sb=document.getElementById(`sidebar-${s}`);sb.classList.toggle('collapsed');const b=sb.querySelector('.sidebar-toggle-btn');if(s==='left')b.innerText=sb.classList.contains('collapsed')?'‚ñ∂':'‚óÄ';if(s==='right')b.innerText=sb.classList.contains('collapsed')?'‚óÄ':'‚ñ∂';},
    setupInputs(){
        const svg=document.getElementById('game-area');let isDrag=false,dStart={x:0,y:0},mDown={x:0,y:0};
        svg.addEventListener('mousedown',e=>{if(e.button!==0)return;isDrag=true;State.dragDistance=0;mDown={x:e.clientX,y:e.clientY};dStart={x:e.clientX-R.panX,y:e.clientY-R.panY};});
        window.addEventListener('mousemove',e=>{if(isDrag){let dx=e.clientX-mDown.x,dy=e.clientY-mDown.y;State.dragDistance=Math.sqrt(dx*dx+dy*dy);R.panX=e.clientX-dStart.x;R.panY=e.clientY-dStart.y;R.cam();}const rect=svg.getBoundingClientRect();this.hover=R.s2i(e.clientX-rect.left,e.clientY-rect.top);});
        window.addEventListener('mouseup',()=>{isDrag=false;});
        svg.addEventListener('wheel',e=>{e.preventDefault();let oz=R.zoom;R.zoom+=e.deltaY*-0.001;R.zoom=Math.max(0.3,Math.min(2.5,R.zoom));const rect=svg.getBoundingClientRect();let mx=e.clientX-rect.left,my=e.clientY-rect.top;R.panX=mx-(mx-R.panX)*(R.zoom/oz);R.panY=my-(my-R.panY)*(R.zoom/oz);R.cam();},{passive:false});
        svg.addEventListener('click',e=>{if(State.dragDistance>5||!this.hover)return;let hx=this.hover.x,hy=this.hover.y;if(hx<0||hx>=Config.gridSize||hy<0||hy>=Config.gridSize)return;
        if(State.selectedTool){
            if(State.grid[hy][hx]!==null){this.toast("Space occupied by another organelle.","warning");return;}
            let d=BUILDINGS[State.selectedTool];
            if(d.id === 'nucleus') { this.toast("Nucleus already exists!","error"); return; }
            if(State.atp>=d.cost){
                State.atp-=d.cost;State.grid[hy][hx]=d.id;State.buildings.push({x:hx,y:hy,id:d.id, infected:false});R.floatText(`-${d.cost.toLocaleString()}‚ö°`,hx,hy,'txt-expense');R.renderStatic();State.processTick();
            }else this.toast("Insufficient ATP energy.","error");}
        else{let id=State.grid[hy][hx];if(id&&id!=='road')this.openInspector(hx,hy,id);else this.closeInspector();}});
        window.addEventListener('keydown',e=>{if(e.key==='Escape'){this.selectTool(null);this.closeInspector();this.closeModal();return;}const k=e.key.toUpperCase();for(let id in BUILDINGS)if(BUILDINGS[id]._hk&&BUILDINGS[id]._hk===k){if(State.atp>=BUILDINGS[id].cost)this.selectTool(id);return;}});
    },
    setupTT(){const tt=document.getElementById('game-tooltip');document.querySelectorAll('[data-tooltip]').forEach(el=>{el.addEventListener('mouseenter',e=>{const t=document.getElementById(el.getAttribute('data-tooltip'));if(t){tt.innerHTML=t.innerHTML;tt.style.opacity='1';const r=el.getBoundingClientRect();tt.style.left=r.left+r.width/2-tt.offsetWidth/2+'px';tt.style.top=r.bottom+10+'px';}});el.addEventListener('mouseleave',()=>{tt.style.opacity='0';});});},
    closeModal(){document.getElementById('modal-overlay').classList.remove('active');document.getElementById('modal-codex').style.display='none';document.getElementById('modal-standard').style.display='none';document.getElementById('modal-dashboard').style.display='none';State.isPaused=false;},
    triggerNarrativeEvent(title,desc,codexLink=null){
        State.isPaused=true;let m=document.getElementById('modal-standard');m.style.display='flex';m.className='modal-window theme-event';
        document.getElementById('modal-std-title').innerHTML=`<span>üî¨ ${title}</span>`;
        let h=`<div class="event-main-text">${desc}</div>`;
        if(codexLink)h+=`<div class="edu-callout info"><span class="edu-callout-title">Science Connection</span>Review the Textbook to understand the biology behind this event.</div><div class="event-choices"><button class="choice-btn" onclick="UI.openCodex('${codexLink}')"><span class="choice-title">üìñ Open Textbook</span></button></div>`;
        document.getElementById('modal-std-body').innerHTML=h;document.getElementById('modal-std-footer').innerHTML=`<button class="btn btn-primary" onclick="UI.closeModal()">Continue</button>`;
        document.getElementById('modal-overlay').classList.add('active');
    },
    openCodex(startTab='intro'){State.isPaused=true;document.getElementById('modal-standard').style.display='none';document.getElementById('modal-dashboard').style.display='none';document.getElementById('modal-codex').style.display='flex';const nav=document.getElementById('codex-nav'),content=document.getElementById('codex-content');nav.innerHTML='';for(let k in CODEX_DB){let btn=document.createElement('button');btn.className='dash-tab';btn.innerText=CODEX_DB[k].title;btn.onclick=()=>{document.querySelectorAll('#codex-nav .dash-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');content.innerHTML=CODEX_DB[k].html;};nav.appendChild(btn);if(k===startTab)btn.click();}document.getElementById('modal-overlay').classList.add('active');},
    
    // NUCLEUS DASHBOARD LOGIC
    openDashboard(startTab='mitosis'){
        State.isPaused=true;
        document.getElementById('modal-standard').style.display='none';
        document.getElementById('modal-codex').style.display='none';
        document.getElementById('modal-dashboard').style.display='flex';
        document.getElementById('modal-overlay').classList.add('active');
        this.switchDashTab(startTab);
    },
    refreshDashboardIfOpen() {
        if(document.getElementById('modal-dashboard').style.display === 'flex') {
            this.switchDashTab(this.dashTabOpen);
        }
    },
    switchDashTab(tab){
        this.dashTabOpen = tab;
        document.querySelectorAll('#modal-dashboard .dash-tab').forEach(b=>b.classList.remove('active'));
        document.getElementById(`tab-btn-${tab}`).classList.add('active');
        const c=document.getElementById('dash-content-area');
        let h='';
        
        if(tab==='mitosis'){
            let req = State.getPhaseReqs();
            let f = n=>Math.floor(n).toLocaleString();
            
            h=`<div class="dash-section">
                <h3>Mitosis Preparation <span class="model-version-badge">Generation ${State.cellGeneration}</span></h3>
                <p>Replicate your DNA and accumulate Proteins to divide the cell. Higher generations yield a massive multiplier to Golgi ATP payouts!</p>
                <div class="train-grid">
                    <div class="train-stat-box">
                        <div class="train-stat-label">Proteins Required</div>
                        <div class="train-stat-val ${State.protein>=req.proReq?'meet':'fail'}">${f(State.protein)} / ${f(req.proReq)}</div>
                    </div>
                    <div class="train-stat-box">
                        <div class="train-stat-label">ATP Required</div>
                        <div class="train-stat-val ${State.atp>=req.atpReq?'meet':'fail'}">${f(State.atp)} / ${f(req.atpReq)}</div>
                    </div>
                    <div class="train-stat-box" style="grid-column: span 2; display:flex; justify-content:space-between; align-items:center; text-align:left;">
                        <div>
                            <div class="train-stat-label">DNA Replicated (S Phase)</div>
                            <div class="train-stat-val ${State.dnaReplicated?'meet':'fail'}">${State.dnaReplicated ? '100% Complete' : '0% (Needs Replication)'}</div>
                        </div>
                        <button class="btn btn-dash" style="background:rgba(251,191,36,0.15); border-color:var(--color-atp); color:var(--color-atp);" onclick="State.buyDNA()" ${State.atp<req.dnaAtpCost || State.glucose<req.dnaGluCost || State.dnaReplicated ? 'disabled':''}>
                            ${State.dnaReplicated ? 'DNA Copied ‚úÖ' : 'Synthesize DNA (-'+req.dnaAtpCost+'‚ö°, -'+req.dnaGluCost+'üç¨)'}
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" style="width:100%; padding:14px; font-size:1.1rem; background:rgba(168,85,247,0.2); border-color:var(--color-nucleus); color:#fff" onclick="State.triggerMitosis()" ${(State.protein<req.proReq || State.atp<req.atpReq || !State.dnaReplicated || State.health<80)?'disabled':''}>
                    ü¶† Initiate Cell Division (Mitosis)
                </button>
            </div>`;
        }
        else if(tab==='metabolism'){
            h=`<div class="dash-section">
                <h3>Metabolic Pathways</h3>
                <p>Override standard cellular functions to boost energy or intake. Warning: these generate extreme metabolic stress.</p>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Anaerobic Fermentation</h4>
                        <p>Generate emergency <span style="color:var(--color-atp)">+40 ATP/s</span> without Mitochondria. Causes extreme <span style="color:var(--color-waste)">+4 Toxicity/s</span> and burns Glucose.</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.pathways.fermentation = this.checked; UI.refreshDashboardIfOpen();" ${State.pathways.fermentation?'checked':''}><span class="slider"></span></label>
                </div>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Protein Export Drive</h4>
                        <p>Forces the Golgi Apparatus to work overtime. <span style="color:var(--color-atp)">Doubles ATP Payout</span> from exports, but it consumes <span style="color:var(--color-protein)">2x Proteins</span> and ATP.</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.pathways.exportDrive = this.checked; UI.refreshDashboardIfOpen();" ${State.pathways.exportDrive?'checked':''}><span class="slider"></span></label>
                </div>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Phagocytosis Mode</h4>
                        <p>Endocytosis pumps yield <span style="color:var(--color-glucose)">2x Nutrients</span>. However, there is a constant risk of engulfing <span style="color:var(--color-health)">Viral Particles</span>!</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.pathways.phagocytosis = this.checked; UI.refreshDashboardIfOpen();" ${State.pathways.phagocytosis?'checked':''}><span class="slider"></span></label>
                </div>
            </div>`;
        }
        else if(tab==='genes'){
            h=`<div class="dash-section">
                <h3>Gene Expression & Defense</h3>
                <p>Express specific protective genes. These require a constant supply of ATP to maintain.</p>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Antioxidant Enzymes</h4>
                        <p>Continuously neutralizes free radicals, passively clearing <span style="color:var(--color-glucose)">-1.5 Toxicity/s</span>. Costs <span style="color:var(--color-health)">-15 ATP/s</span>.</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.genes.antioxidants = this.checked; UI.refreshDashboardIfOpen();" ${State.genes.antioxidants?'checked':''}><span class="slider"></span></label>
                </div>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Interferon Signaling</h4>
                        <p>Antiviral defense mechanism. Passively destroys Viral Load and cures infected ribosomes. Costs <span style="color:var(--color-health)">-60 ATP/s</span>.</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.genes.interferon = this.checked; UI.refreshDashboardIfOpen();" ${State.genes.interferon?'checked':''}><span class="slider"></span></label>
                </div>
                <div class="dash-row">
                    <div class="dash-info">
                        <h4>Autophagy</h4>
                        <p>Break down damaged proteins for raw materials. Costs <span style="color:var(--color-danger)">-10 ATP/s</span>. Reduces <span style="color:var(--color-waste)">-2.0 Waste/s</span> and provides <span style="color:var(--color-glucose)">+3 Glucose/s</span>.</p>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" onchange="State.activeGenes.autophagy = this.checked; UI.refreshDashboardIfOpen();" ${State.activeGenes.autophagy?'checked':''}><span class="slider"></span></label>
                </div>
            </div>`;
        }
        c.innerHTML=h;
    },

    openInspector(x,y,id){
        if(id === 'nucleus') { this.openDashboard('mitosis'); return; }
        const d=BUILDINGS[id];document.getElementById('insp-name').innerText=`${d.icon||''} ${d.name}`;document.getElementById('insp-cat').innerText=d.category;document.getElementById('insp-desc').innerText=d.desc;
        let sh='';
        
        let bld = State.buildings.find(b => b.x===x && b.y===y);

        if (bld && bld.infected) {
            sh+=`<div class="inspect-row"><span class="inspect-label">Status:</span><span class="inspect-val" style="color:var(--color-health)">INFECTED ü¶†</span></div>`;
            sh+=`<div class="inspect-row"><span class="inspect-label">Viral Output:</span><span class="inspect-val" style="color:var(--color-health)">+2.0 Viral/s</span></div>`;
            sh+=`<div class="inspect-row"><span class="inspect-label">Toxicity:</span><span class="inspect-val" style="color:var(--color-health)">+4.0 Waste/s</span></div>`;
            sh+=`<div class="inspect-row"><span class="inspect-label">ATP cost:</span><span class="inspect-val" style="color:var(--color-health)">-25 ATP/s</span></div>`;
        } else if (d.stats) {
            if(d.stats.genGlu)sh+=`<div class="inspect-row"><span class="inspect-label">Glucose in:</span><span class="inspect-val" style="color:var(--color-glucose)">+${d.id==='endo'&&State.pathways.phagocytosis?d.stats.genGlu*2:d.stats.genGlu}/s</span></div>`;
            if(d.stats.costGlu)sh+=`<div class="inspect-row"><span class="inspect-label">Glucose used:</span><span class="inspect-val" style="color:var(--color-glucose)">-${d.stats.costGlu}/s</span></div>`;
            if(d.stats.genAtp)sh+=`<div class="inspect-row"><span class="inspect-label">ATP gen:</span><span class="inspect-val" style="color:var(--color-atp)">+${d.stats.genAtp}/s</span></div>`;
            if(d.stats.genAtpBase)sh+=`<div class="inspect-row"><span class="inspect-label">Export ATP:</span><span class="inspect-val" style="color:var(--color-atp)">+${(State.pathways.exportDrive?d.stats.genAtpBase*2:d.stats.genAtpBase) * State.cellGeneration}/s</span></div>`;
            if(d.stats.costAtp)sh+=`<div class="inspect-row"><span class="inspect-label">ATP cost:</span><span class="inspect-val" style="color:var(--color-health)">-${d.stats.costAtp}/s</span></div>`;
            if(d.stats.genPro)sh+=`<div class="inspect-row"><span class="inspect-label">Proteins:</span><span class="inspect-val" style="color:var(--color-protein)">+${d.stats.genPro}/s</span></div>`;
            if(d.stats.costPro)sh+=`<div class="inspect-row"><span class="inspect-label">Prot used:</span><span class="inspect-val" style="color:var(--color-protein)">-${State.pathways.exportDrive?d.stats.costPro*2:d.stats.costPro}/s</span></div>`;
            if(d.stats.genWaste)sh+=`<div class="inspect-row"><span class="inspect-label">Toxicity:</span><span class="inspect-val" style="color:var(--color-health)">+${d.stats.genWaste}/s</span></div>`;
            if(d.stats.clearWaste)sh+=`<div class="inspect-row"><span class="inspect-label">Cleaned:</span><span class="inspect-val" style="color:var(--color-glucose)">-${d.stats.clearWaste}/s</span></div>`;
            if(d.stats.addCap)sh+=`<div class="inspect-row"><span class="inspect-label">Storage:</span><span class="inspect-val">+${d.stats.addCap}</span></div>`;
        }

        document.getElementById('insp-stats').innerHTML=sh;
        
        const ctrl=document.getElementById('insp-custom-controls');ctrl.innerHTML='';
        let db=document.createElement('button');db.className='btn btn-danger';db.style.width='100%';db.style.marginTop='8px';db.innerText='Lysis (Deconstruct)';
        db.onclick=()=>{State.grid[y][x]=null;State.buildings=State.buildings.filter(b=>!(b.x===x&&b.y===y));document.getElementById(`tile-${x}-${y}`).setAttribute('href','#asset-tile-base');R.floatText("Lysis",x,y,"txt-expense");R.renderStatic();State.processTick();this.closeInspector();};
        ctrl.appendChild(db);document.getElementById('inspector-panel').style.display='block';
    },
    closeInspector(){document.getElementById('inspector-panel').style.display='none';}
};

// ============================================================================
// CHART
// ============================================================================
const ChartMgr={
    canvas:null,ctx:null,
    init(){this.canvas=document.getElementById('metrics-canvas');this.ctx=this.canvas.getContext('2d');this.resize();window.addEventListener('resize',()=>this.resize());},
    resize(){const r=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=r.width;this.canvas.height=r.height;this.draw();},
    draw(){if(!this.ctx)return;const w=this.canvas.width,h=this.canvas.height;this.ctx.clearRect(0,0,w,h);this.drawLine(State.historyAtp,'#fbbf24',w,h);this.drawLine(State.historyPro,'#ec4899',w,h);this.drawLine(State.historyTox,'#84cc16',w,h);},
    drawLine(arr,col,w,h){if(!arr.length)return;const mx=Math.max(...arr.map(Math.abs),10);const sx=w/(arr.length-1);this.ctx.beginPath();this.ctx.strokeStyle=col;this.ctx.lineWidth=1.5;this.ctx.lineJoin='round';arr.forEach((v,i)=>{const x=i*sx,y=h-((v/mx)*h*0.85);if(i===0)this.ctx.moveTo(x,y);else this.ctx.lineTo(x,y);});this.ctx.stroke();this.ctx.lineTo(w,h);this.ctx.lineTo(0,h);this.ctx.fillStyle=col;this.ctx.globalAlpha=0.06;this.ctx.fill();this.ctx.globalAlpha=1;}
};

// ============================================================================
// MISSIONS
// ============================================================================
const MISSIONS = [
    { id:1, title:"Energy Generation", desc:"A cell needs ATP to survive. Import Glucose and burn it in Mitochondria.",
      tasks:[{id:'t1',desc:"Build 1 Membrane Pore",check:s=>s.countBuilding('pore')>=1},{id:'t2',desc:"Build 1 Mitochondrion",check:s=>s.countBuilding('mito')>=1}],
      reward:500, onComplete:()=>{ UI.triggerNarrativeEvent("Cellular Respiration Active","Your Mitochondria are burning Glucose to produce ATP energy! But be careful: this process produces toxic metabolic waste.","respiration"); }
    },
    { id:2, title:"Protein Synthesis", desc:"Use your energy to start building the cell's physical structure.",
      tasks:[{id:'t1',desc:"Build 1 Ribosome",check:s=>s.countBuilding('ribo')>=1},{id:'t2',desc:"Accumulate 100 Proteins",check:s=>s.protein>=100}],
      reward:800, onComplete:()=>{ UI.triggerNarrativeEvent("Proteins Synthesized","Ribosomes are assembling amino acids into proteins! Notice how your Toxicity is rising? You need to handle waste before it kills the cell.","waste"); }
    },
    { id:3, title:"Homeostasis", desc:"Toxicity is building up. Build Lysosomes to digest the waste and prevent Apoptosis.",
      tasks:[{id:'t1',desc:"Build 2 Lysosomes",check:s=>s.countBuilding('lyso')>=2},{id:'t2',desc:"Keep Toxicity below 40%",check:s=>s.toxicity<40}],
      reward:1000, onComplete:()=>{ UI.triggerNarrativeEvent("Homeostasis Achieved","Waste levels are dropping. The cell is stable. Now scale up your operations to prepare for Cell Division.","intro"); }
    },
    { id:4, title:"The Endomembrane System", desc:"Basic Ribosomes aren't enough. Build the advanced protein-folding network and expand storage.",
      tasks:[{id:'t1',desc:"Build Rough ER",check:s=>s.countBuilding('rer')>=1},{id:'t2',desc:"Build Golgi Apparatus",check:s=>s.countBuilding('golgi')>=1},{id:'t3',desc:"Build Vacuole",check:s=>s.countBuilding('vac_s')>=1}],
      reward:2000, onComplete:()=>{ UI.triggerNarrativeEvent("Mass Production","Your cell is rapidly producing complex proteins. Ensure you have enough Mitochondria to power this heavy machinery.","proteins"); }
    },
    { id:5, title:"Preparation for Mitosis", desc:"Open the Nucleus Command to synthesize DNA during the S-Phase.",
      tasks:[{id:'t1',desc:"Open Nucleus & Synthesize DNA",check:s=>s.dnaReplicated}],
      reward:3000, onComplete:()=>{ UI.triggerNarrativeEvent("DNA Replication","The cell has copied its DNA! Keep gathering resources to reach full Mitosis!","mitosis"); }
    },
    { id:6, title:"Mitosis", desc:"Complete the cell cycle. Gather enough resources in the Nucleus to divide!",
      tasks:[{id:'t1',desc:"Trigger Mitosis",check:s=>s.cellGeneration>=2}],
      reward:5000, onComplete:()=>{ UI.triggerNarrativeEvent("üéâ Cell Division Complete!","Congratulations! You successfully balanced the complex metabolic needs of the cell and completed Mitosis. Two identical daughter cells have been formed. Keep playing to explore Epigenetics and higher generations!","intro"); }
    }
];
const MissionMgr={
    check(){if(State.missionIndex>=MISSIONS.length)return;const m=MISSIONS[State.missionIndex];let allDone=true;
    document.getElementById('ui-quest-title').innerText=m.title;document.getElementById('ui-quest-desc').innerText=m.desc;
    const tc=document.getElementById('ui-quest-tasks');tc.innerHTML='';
    m.tasks.forEach(t=>{let done=t.check(State);if(!done)allDone=false;let d=document.createElement('div');d.className=`quest-task ${done?'completed':''}`;d.innerHTML=`<div class="task-checkbox"></div><span>${t.desc}</span>`;tc.appendChild(d);});
    if(allDone){State.atp+=m.reward;UI.toast(`Objective Complete! +${m.reward.toLocaleString()}‚ö°`,"success");if(m.onComplete)m.onComplete();State.missionIndex++;}}
};

// ============================================================================
// GAME LOOP
// ============================================================================
const Game={
    init(){document.getElementById('splash-screen').style.display='none';document.getElementById('app-container').style.display='flex';
    State.init();R.initGrid();UI.init();
    
    // Initial Cytoskeleton layout cross around the nucleus
    const mid=Math.floor(Config.gridSize/2);
    for(let i=-2;i<=2;i++){
        if(i!==0) {
            State.grid[mid][mid+i]='road';State.grid[mid+i][mid]='road';
            State.buildings.push({x:mid+i,y:mid,id:'road', infected:false});
            State.buildings.push({x:mid,y:mid+i,id:'road', infected:false});
        }
    }
    
    R.renderStatic();State.lastTickTime=performance.now();requestAnimationFrame(this.loop.bind(this));
    UI.toast("Cell awakened. Begin metabolic processes!","success");MissionMgr.check();},
    loop(ts){const dt=ts-State.lastTickTime;if(dt>=Config.tickMs){State.processTick();State.lastTickTime=ts-(dt%Config.tickMs);}if(!State.isPaused){State.updateParticles();R.renderDynamic();}requestAnimationFrame(this.loop.bind(this));}
};
</script>
</body>
</html>
