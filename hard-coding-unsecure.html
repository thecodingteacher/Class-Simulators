<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediSecure Diagnostics - Health Testing (Vulnerable - Reworked)</title>
    <style>
        /* Basic Professional Styling (Same as before) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        .container { width: 80%; margin: auto; overflow: hidden; }
        header { background: #0056b3; color: #fff; padding-top: 30px; min-height: 70px; border-bottom: #003d80 3px solid; }
        header a { color: #fff; text-decoration: none; text-transform: uppercase; font-size: 16px; }
        header ul { padding: 0; margin: 0; list-style: none; float: right; }
        header li { display: inline; padding: 0 20px 0 20px; }
        header #branding { float: left; }
        header #branding h1 { margin: 0; font-size: 24px; }
        header nav { margin-top: 10px; }
        header .highlight { color: #e8491d; }
        header .current a { color: #e8491d; font-weight: bold; }
        header a:hover { color: #ccc; font-weight: bold; }
        main { padding: 20px 0; }
        section { background: #fff; padding: 20px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; }
        h1, h2 { color: #0056b3; }
        label { display: block; margin: 10px 0 5px; }
        input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
        input[type="submit"], button { display: inline-block; background: #e8491d; color: #fff; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 3px; margin-top: 10px; margin-right: 10px; }
        input[type="submit"]:hover, button:hover { background: #333; }
        textarea { height: 100px; }
        #message-output, #search-results, #record-details, #status-output, #upload-status, #fake-accounts-status { margin-top: 15px; padding: 10px; background-color: #e9e9e9; border: 1px dashed #ccc; min-height: 30px; word-wrap: break-word; }
        footer { background: #333; color: #fff; text-align: center; padding: 20px; margin-top: 30px; }
        /* Hide sections initially, JS will show 'home' */
        #home, #about, #login, #admin_dashboard, #tools { display: none; }
        /* Vulnerable Comment Example */
        /* TODO: Remember to change the default admin password 'Qwertz432' before going live! */
        /* Server Info: Apache/2.4.41 (Win64) running PHP/7.4.3 (Simulated) */
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><span class="highlight">MediSecure</span> Diagnostics</h1>
            </div>
            <nav>
                <ul>
                    <!-- data-target attribute used by JS for navigation -->
                    <li><a href="#home" data-target="home">Home</a></li>
                    <li><a href="#about" data-target="about">About</a></li>
                    <li><a href="#tools" data-target="tools">Tools</a></li>
                    <li><a href="#login" data-target="login">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="home">
            <h1>Welcome to MediSecure Diagnostics</h1>
            <p>Your health, our priority. Advanced diagnostics from just a single drop of blood. Fast, accurate, and secure.</p>
            <h2>Leave a Public Comment</h2>
            <!-- Add ID for JS targeting -->
            <form id="comment-form" action="#" method="POST">
                <label for="comment">Comment:</label>
                <textarea id="comment" name="comment" placeholder="Enter your public comment here... e.g., <script>alert('XSS')</script>"></textarea>
                <input type="submit" value="Post Comment">
            </form>
            <div id="message-output">
                <!-- Vulnerability: XSS - Comments will appear here unescaped -->
                <p>User1: Great service!</p>
            </div>
        </section>

        <section id="about">
            <h1>About MediSecure Diagnostics</h1>
            <p>Founded in 2023, MediSecure Diagnostics leverages cutting-edge biotechnology to provide comprehensive health insights from minimal samples. Our patented analysis process ensures quick turnaround times without compromising accuracy.</p>
            <p>We are committed to data privacy and employ state-of-the-art security measures (or so we claim).</p>
        </section>

        <section id="tools">
            <h1>Diagnostic Tools (Simulated Vulnerabilities)</h1>

            <!-- Simulated SQL Injection -->
            <h2>Search Patient Records (SQLi)</h2>
            <!-- Add ID for JS targeting -->
            <form id="search-form">
                <label for="patientId">Patient ID:</label>
                <input type="text" id="patientId" name="patientId" placeholder="e.g., 101 or 101' OR '1'='1">
                <input type="submit" value="Search">
            </form>
            <div id="search-results">Search results will appear here.</div>

            <!-- Simulated Directory Traversal -->
            <h2>Load Patient Record File (Path Traversal)</h2>
             <!-- Add ID for JS targeting -->
            <form id="load-record-form">
                <label for="recordFile">Record Filename:</label>
                <input type="text" id="recordFile" name="recordFile" placeholder="e.g., record_101.pdf or ../../../etc/passwd">
                <input type="submit" value="Load File">
            </form>
            <div id="record-details">File content simulation appears here.</div>

             <!-- Simulated Command Injection -->
            <h2>Check Server Status (Command Injection)</h2>
            <!-- Add ID for JS targeting -->
             <form id="status-form">
                <label for="serverIp">Server IP:</label>
                <input type="text" id="serverIp" name="serverIp" placeholder="e.g., 192.168.1.1 or 127.0.0.1; whoami">
                <input type="submit" value="Check Status">
            </form>
            <div id="status-output">Server status simulation appears here.</div>

            <!-- Simulated Insecure File Upload -->
            <h2>Upload Test Results (Insecure Upload)</h2>
             <!-- Add ID for JS targeting -->
            <form id="upload-form">
                 <label for="fileUpload">Select File (Client-side PDF check only):</label>
                 <input type="file" id="fileUpload" name="fileUpload" accept=".pdf">
                 <input type="submit" value="Upload">
            </form>
            <div id="upload-status">Upload status...</div>
        </section>

        <section id="login">
            <h1>Admin Login</h1>
            <!-- Vulnerability: Lack of CSRF token -->
             <!-- Add ID for JS targeting -->
            <form id="login-form" action="#" method="POST">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
                <input type="submit" value="Login">
            </form>
            <div id="login-error" style="color: red; margin-top: 10px;"></div>
        </section>

        <section id="admin_dashboard">
            <h1>Admin Dashboard</h1>
            <p>Welcome, <span id="admin-username">Admin</span>!</p>
            <p>Current Access Level (from localStorage): <span id="admin-level-display">Normal</span></p>
            <p>This area contains sensitive administrative functions.</p>

            <!-- Add IDs for JS targeting -->
            <button id="delete-records-btn">Delete All Patient Records (Simulated - Requires 'admin' role)</button>
            <button id="delete-fake-btn">Delete Fake User Accounts (Simulated - Requires adminLevel '2' in localStorage)</button>
            <div id="fake-accounts-status"></div>

            <p style="margin-top: 20px;"><button id="logout-btn">Logout</button></p>
        </section>
    </main>

    <footer>
        <p>MediSecure Diagnostics Â© 2024 | <a href="#" style="color:#fff;">Privacy Policy</a> | All Rights Reserved (For educational purposes only)</p>
        <!-- Vulnerability Hint: Check Local Storage in Developer Tools (F12 -> Application) -->
    </footer>

    <script>
        // --- Global Variables & Initial Data ---

        // Vulnerability: Sensitive Data Exposure in Local Storage
        localStorage.setItem("sessionToken", "sess_abc123xyz789_demo_v3");
        localStorage.setItem("userRole", "guest"); // Initial role ('guest', 'admin')
        localStorage.setItem("trackingId", "trk_987654321_demo_v3");
        localStorage.setItem("lastLoginTimestamp", Date.now());
        // Vulnerability: Control flag for privilege escalation in localStorage
        if (localStorage.getItem("adminLevel") === null || !['0','1','2'].includes(localStorage.getItem("adminLevel"))) {
             localStorage.setItem("adminLevel", "0"); // 0=Normal, 1=Admin, 2=SuperSuperAdmin
        }

        // Simulated Fake User Accounts Data (Client-Side)
        let fakeUserAccounts = [
            { id: 1, username: "testuser1", email: "test1@example.com" }, { id: 2, username: "demo_user", email: "demo@example.com" },
            { id: 3, username: "jsmith", email: "jsmith@sample.org" }, { id: 4, username: "another_user", email: "another@example.com" },
            { id: 5, username: "pentest_dummy", email: "dummy@test.local" }, { id: 6, username: "user_six", email: "six@example.net" },
            { id: 7, username: "tester_beta", email: "beta@sample.org" }, { id: 8, username: "final_test", email: "final@test.local" },
            { id: 9, username: "some_guy", email: "guy@example.com" }, { id: 10, username: "last_one", email: "last@example.net" },
        ];

        // --- Helper Functions ---

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                 .replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">")
                 .replace(/"/g, """).replace(/'/g, "'");
         }

        function displaySection(targetId) {
            const sections = document.querySelectorAll('main > section');
            const navListItems = document.querySelectorAll('header nav li');
            let foundTarget = false;

            sections.forEach(section => {
                if (section.id === targetId) {
                    section.style.display = 'block';
                    foundTarget = true;
                } else {
                    section.style.display = 'none';
                }
            });

            if (!foundTarget) {
                console.error("Target section not found:", targetId);
                const homeSection = document.getElementById('home');
                if (homeSection) homeSection.style.display = 'block'; // Fallback
                targetId = 'home'; // Adjust for highlighting
            }

             // Update Admin dashboard display elements whenever it's shown
             if(targetId === 'admin_dashboard') {
                updateAdminDashboardDisplay();
             }

            // Update nav highlight
            navListItems.forEach(li => {
                const link = li.querySelector('a');
                const linkTarget = link ? link.getAttribute('data-target') : null;
                if (linkTarget === targetId || (targetId === 'admin_dashboard' && linkTarget === 'login' && localStorage.getItem('userRole') === 'admin')) {
                    li.classList.add('current');
                } else {
                    li.classList.remove('current');
                }
            });
            // console.log("Displayed section:", targetId); // Debug log
        }

        function updateAdminDashboardDisplay() {
            try {
                const currentLevel = localStorage.getItem('adminLevel') || '0';
                let levelText = 'Normal (0)';
                if (currentLevel === '1') levelText = 'Admin (1)';
                if (currentLevel === '2') levelText = 'Super Super Admin (2)';

                const username = localStorage.getItem('lastAdminUser') || 'Admin';
                const levelDisplay = document.getElementById('admin-level-display');
                const usernameDisplay = document.getElementById('admin-username');

                if(levelDisplay) levelDisplay.textContent = levelText;
                if(usernameDisplay) usernameDisplay.textContent = escapeHtml(username);

                updateFakeAccountsDisplay(); // Refresh account list too
            } catch (error) {
                console.error("Error updating admin dashboard display:", error);
            }
        }

        function updateFakeAccountsDisplay() {
            try {
                const fakeAccountsDiv = document.getElementById('fake-accounts-status');
                if (!fakeAccountsDiv) return;

                if (fakeUserAccounts.length > 0) {
                    let listHtml = '<h3>Current Fake User Accounts:</h3><ul>';
                    fakeUserAccounts.forEach(acc => {
                        listHtml += `<li>ID: ${acc.id}, Username: ${escapeHtml(acc.username)}, Email: ${escapeHtml(acc.email)}</li>`;
                    });
                    listHtml += '</ul>';
                    fakeAccountsDiv.innerHTML = listHtml;
                } else {
                    fakeAccountsDiv.innerHTML = '<p style="color: green;">All fake user accounts have been deleted.</p>';
                }
                fakeAccountsDiv.innerHTML += `<p>Total fake accounts: ${fakeUserAccounts.length}</p>`;
             } catch (error) {
                 console.error("Error updating fake accounts display:", error);
                 if(fakeAccountsDiv) fakeAccountsDiv.innerHTML = "<p style='color:red;'>Error displaying fake accounts.</p>";
             }
        }

        // --- Core Logic Functions (Vulnerabilities Here) ---

        function postComment() {
            try {
                const commentInput = document.getElementById("comment");
                const outputDiv = document.getElementById("message-output");
                if(!commentInput || !outputDiv) {
                    console.error("Comment elements not found"); return;
                }
                const comment = commentInput.value;
                // VULNERABILITY: XSS - Direct insertion of 'comment' into innerHTML
                outputDiv.innerHTML += `<p><span style="color: blue;">You (${escapeHtml(localStorage.getItem('userRole')) || 'guest'}):</span> ${comment}</p>`;
                commentInput.value = ''; // Clear input
                console.log("Posted comment (check output div):", comment);
            } catch (error) { console.error("Error in postComment:", error); }
        }

        function searchPatients() {
            try {
                const patientIdInput = document.getElementById('patientId');
                const resultsDiv = document.getElementById('search-results');
                 if(!patientIdInput || !resultsDiv) { console.error("Search elements not found"); return; }
                const patientId = patientIdInput.value;
                // VULNERABILITY: Simulated SQL Injection
                const query = `SELECT * FROM patients WHERE id = '${patientId}';`;
                console.warn("Simulated SQL Query (VULNERABLE):", query);
                resultsDiv.innerHTML = `Simulating search based on ID: ${escapeHtml(patientId)}... <br>(Check console for vulnerable query)`;
            } catch (error) { console.error("Error in searchPatients:", error); }
        }

        function loadRecord() {
             try {
                const recordFileInput = document.getElementById('recordFile');
                const detailsDiv = document.getElementById('record-details');
                if(!recordFileInput || !detailsDiv) { console.error("Load record elements not found"); return; }
                const recordFile = recordFileInput.value;
                // VULNERABILITY: Simulated Path Traversal
                const basePath = "/var/www/html/records/";
                const filePath = basePath + recordFile;
                console.warn("Simulated File Path Access (VULNERABLE):", filePath);
                detailsDiv.innerHTML = `Simulating loading file: ${escapeHtml(recordFile)}... <br>(Check console for vulnerable path)`;
            } catch (error) { console.error("Error in loadRecord:", error); }
        }

        function checkServerStatus() {
             try {
                 const serverIpInput = document.getElementById('serverIp');
                 const statusDiv = document.getElementById('status-output');
                  if(!serverIpInput || !statusDiv) { console.error("Status elements not found"); return; }
                 const serverIp = serverIpInput.value;
                 // VULNERABILITY: Simulated Command Injection
                 const command = `ping -c 4 ${serverIp}`;
                 console.warn("Simulated Command Execution (VULNERABLE):", command);
                 statusDiv.innerHTML = `Simulating ping to: ${escapeHtml(serverIp)}... <br>(Check console for vulnerable command)`;
            } catch (error) { console.error("Error in checkServerStatus:", error); }
        }

        function handleFileUpload() {
            try {
                const fileInput = document.getElementById('fileUpload');
                const statusDiv = document.getElementById('upload-status');
                 if(!fileInput || !statusDiv) { console.error("Upload elements not found"); return; }
                const allowedClientType = 'application/pdf';

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    // VULNERABILITY: Client-side check only
                    if (file.type === allowedClientType) {
                         statusDiv.innerHTML = `Simulating upload of ${escapeHtml(file.name)} (${escapeHtml(file.type)})... OK (Client Check Passed).`;
                         console.log(`Simulated upload of ${file.name}. VULNERABILITY: Server-side validation MISSING!`);
                    } else {
                         statusDiv.innerHTML = `Error: Invalid file type (client check). Only PDF allowed. You selected: ${escapeHtml(file.type)}`;
                         console.warn(`Client block: Invalid file type (${file.type}). Bypassable.`);
                    }
                } else {
                    statusDiv.innerHTML = 'Please select a file to upload.';
                }
            } catch (error) { console.error("Error in handleFileUpload:", error); }
        }

        function checkPassword() {
            try {
                const usernameInput = document.getElementById("username");
                const passwordInput = document.getElementById("password");
                const errorDiv = document.getElementById("login-error");
                 if(!usernameInput || !passwordInput || !errorDiv) { console.error("Login elements not found"); return false; }

                const username = usernameInput.value;
                const password = passwordInput.value;
                errorDiv.textContent = ''; // Clear errors

                // VULNERABILITY: Hardcoded Credentials
                const validUsers = { "admin": "Qwertz432", "super-admin": "superlols123" };

                if (validUsers[username] && validUsers[username] === password) {
                    // VULNERABILITY: Broken Access Control (client sets own role/level)
                    localStorage.setItem("userRole", "admin");
                    if (localStorage.getItem("adminLevel") !== '2') { // Don't downgrade if already escalated
                        localStorage.setItem("adminLevel", "1");
                    }
                    localStorage.setItem("lastAdminUser", username); // Store for display
                    console.log(`Login OK for ${username}. Role='admin', Level='${localStorage.getItem("adminLevel")}'.`);
                    displaySection('admin_dashboard'); // Show admin section
                } else {
                    errorDiv.textContent = "Invalid username or password.";
                    console.log(`Login failed for username: ${username}`);
                    passwordInput.value = ""; // Clear password only
                }
            } catch (error) {
                console.error("Error in checkPassword:", error);
                 const errorDiv = document.getElementById("login-error");
                 if(errorDiv) errorDiv.textContent = "Login error occurred.";
            }
             // Prevent form submission regardless of outcome
             return false;
        }

        function deleteAllRecords() {
            try {
                // VULNERABILITY: Broken Access Control (client-side role check)
                if (localStorage.getItem("userRole") !== 'admin') {
                    alert("Access Denied. Requires 'admin' role (checked client-side)."); return;
                }
                if (confirm("DANGER: Delete all PATIENT records? (Simulated)")) {
                    console.error(`SIMULATION: Deleting patient records by ${escapeHtml(localStorage.getItem('lastAdminUser'))}`);
                    alert("All patient records deleted (Simulated).");
                }
            } catch (error) { console.error("Error in deleteAllRecords:", error); }
        }

        function deleteFakeAccounts() {
            try {
                // VULNERABILITY: Privilege Escalation via LocalStorage level check
                const currentLevel = localStorage.getItem('adminLevel');
                if (currentLevel !== '2') {
                    alert("Access Denied. Requires adminLevel '2' in localStorage (checked client-side).");
                    console.warn(`deleteFakeAccounts blocked. Required Level: 2, Current: ${currentLevel}`);
                    return;
                }
                 if (confirm("Level 2 Access OK! Delete all FAKE user accounts? (Simulated)")) {
                    const initialCount = fakeUserAccounts.length;
                    fakeUserAccounts = []; // Clear the global array
                    console.log(`SUPER-ADMIN ACTION (${escapeHtml(localStorage.getItem('lastAdminUser'))}): Deleted ${initialCount} fake accounts.`);
                    alert(`Success: ${initialCount} fake accounts deleted (Simulated).`);
                    updateFakeAccountsDisplay(); // Update list on dashboard
                }
            } catch (error) { console.error("Error in deleteFakeAccounts:", error); }
        }

        function logout() {
             try {
                 localStorage.setItem("userRole", "guest");
                 localStorage.setItem("adminLevel", "0");
                 // localStorage.removeItem("sessionToken"); // Optional cleanup
                 // localStorage.removeItem("lastLoginTimestamp"); // Optional cleanup
                 // Keep lastAdminUser? Optional.

                 // Clear login form for better UX
                 const usernameInput = document.getElementById("username");
                 const passwordInput = document.getElementById("password");
                 const errorDiv = document.getElementById("login-error");
                 if(usernameInput) usernameInput.value = "";
                 if(passwordInput) passwordInput.value = "";
                 if(errorDiv) errorDiv.textContent = "";

                 displaySection('home'); // Go back home
                 console.log("User logged out. Role='guest', Level='0'.");
            } catch (error) { console.error("Error during logout:", error); }
        }

        // --- Event Listener Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Attaching listeners.");

            // Initial state: Show home section
            displaySection('home');

            // Navigation Links
            document.querySelectorAll('header nav a').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault(); // Stop anchor jump/reload
                    const targetId = link.getAttribute('data-target');
                    if (targetId === 'login' && localStorage.getItem('userRole') === 'admin') {
                        displaySection('admin_dashboard'); // Show dashboard if admin clicks "Login"
                    } else if (targetId) {
                        displaySection(targetId);
                    } else {
                         console.error("Link missing data-target:", link);
                         displaySection('home'); // Fallback
                    }
                });
            });

            // Form Submissions (using IDs added to forms)
            document.getElementById('comment-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); postComment();
            });
            document.getElementById('search-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); searchPatients();
            });
            document.getElementById('load-record-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); loadRecord();
            });
            document.getElementById('status-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); checkServerStatus();
            });
             document.getElementById('upload-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); handleFileUpload();
            });
            document.getElementById('login-form')?.addEventListener('submit', (event) => {
                event.preventDefault(); checkPassword(); // Login function handles display change
            });

            // Admin Buttons (using IDs added to buttons)
            document.getElementById('delete-records-btn')?.addEventListener('click', deleteAllRecords);
            document.getElementById('delete-fake-btn')?.addEventListener('click', deleteFakeAccounts);
            document.getElementById('logout-btn')?.addEventListener('click', logout);

             // Ensure fake accounts list is ready for admin dash (even if hidden)
             updateFakeAccountsDisplay();

            console.log("Listeners attached.");

        }); // End DOMContentLoaded

    </script>

</body>
</html>
