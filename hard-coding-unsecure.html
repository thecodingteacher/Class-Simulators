<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCare Innovations - Patient Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Lato', sans-serif; /* Changed font */
            line-height: 1.6;
            background: linear-gradient(to bottom, #f0f4f9, #e6eaf0); /* Subtle gradient */
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Container */
        .container {
            max-width: 1000px; /* Slightly wider */
            margin: 25px auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        /* Header */
        header {
            background-color: #ffffff; /* White header */
            color: #0056b3; /* Blue text */
            padding: 1rem 0;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #007bff; /* Blue bottom border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; /* For logo alignment */
            align-items: center;
            justify-content: center;
        }
        .logo {
             font-family: 'Roboto', sans-serif;
             font-size: 1.8em;
             font-weight: 500;
             color: #0056b3;
             margin-right: 15px; /* Space between logo and title */
             border: 2px solid #007bff;
             padding: 5px 10px;
             border-radius: 5px;
        }
        header h1 {
            font-family: 'Roboto', sans-serif;
            margin-bottom: 0; /* Removed bottom margin */
            font-weight: 500;
            font-size: 1.6em; /* Adjusted size */
            color: #333;
        }
        /* Removed subtitle from header, can be placed elsewhere if needed */

        /* Navigation */
        nav {
            background: #007bff; /* Primary blue */
            padding: 0.9rem 0;
            margin-bottom: 30px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        nav ul {
            list-style: none;
            text-align: center;
        }
        nav ul li {
            display: inline;
            margin: 0 18px;
        }
        nav ul li a {
            color: #ffffff;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-weight: 700; /* Bolder nav links */
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        nav ul li a:hover,
        nav ul li a.active {
            background-color: #0056b3; /* Darker blue on hover/active */
            color: #fff;
        }
        nav ul li a#nav-logout,
        nav ul li a#nav-admin,
        nav ul li a#nav-view-record {
             display: none; /* Initially hidden */
        }
         /* Explicitly hide the About link visually, handled by CSS rule below */
         /* nav ul li a[href="#about"] {  } */


        /* Content Sections */
        .content-section {
            background: #ffffff; /* White background for content */
            padding: 35px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Softer shadow */
            border: 1px solid #e0e0e0; /* Light border */
        }
        .content-section h2, .content-section h1 {
            font-family: 'Roboto', sans-serif;
            color: #0056b3;
            margin-bottom: 25px;
            border-bottom: 2px solid #007bff; /* Match nav border */
            padding-bottom: 12px;
            font-weight: 500; /* Less heavy headings */
            font-size: 1.8em;
        }
         /* Hidden About Section */
         #about {
             display: none; /* VULNERABILITY: Hidden via CSS */
         }

        /* Forms */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700; /* Bolder labels */
            color: #555;
            font-size: 0.9em;
        }
        form input[type="text"],
        form input[type="password"],
        form textarea,
        form select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ced4da; /* Slightly darker border */
            border-radius: 4px;
            font-size: 1em;
            font-family: 'Lato', sans-serif;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
         form input[type="text"]:focus,
         form input[type="password"]:focus,
         form textarea:focus,
         form select:focus {
             border-color: #80bdff;
             outline: 0;
             box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
         }
        form textarea {
            resize: vertical;
            min-height: 100px;
        }
        form input[type="submit"],
        button {
            display: inline-block;
            background: #28a745; /* Green for primary actions */
            color: #fff;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1em;
            font-weight: 700; /* Bolder buttons */
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
         form input[type="submit"]:hover,
         button:hover {
             background: #218838; /* Darker green */
             transform: translateY(-1px); /* Subtle lift */
         }
         form input[type="submit"]:active,
         button:active {
              transform: translateY(0px);
              box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
         }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
         button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
             transform: none;
             box-shadow: none;
         }

        /* Message Output / Status / XSS Demo / Info Boxes */
        #status-message,
        #patient-query-output-safe,
        #patient-query-output-unsafe,
        #sql-output,
        .debug-info,
        .info-box,
        .vulnerability-note { /* New class for specific notes */
            margin-top: 20px;
            padding: 15px 20px;
            border-left-width: 5px;
            border-left-style: solid;
            background-color: #f8f9fa;
            border-radius: 5px;
            word-wrap: break-word;
            font-size: 0.95em;
            border: 1px solid #eee;
        }
         .info-box {
            border-left-color: #17a2b8; /* Teal for general info */
            background-color: #eef9fc;
         }
          .vulnerability-note {
              border-left-color: #fd7e14; /* Orange for vulnerability highlights */
              background-color: #fff8f2;
          }
          .vulnerability-note strong { color: #d9534f; } /* Reddish text for emphasis */
        #status-message { border-left-color: #17a2b8; display: none; } /* Hide initially */
        #status-message.error { border-left-color: #dc3545; background-color: #f8d7da; color: #721c24; }
        #status-message.success { border-left-color: #28a745; background-color: #d4edda; color: #155724; }
        #patient-query-output-safe { border-left-color: #28a745; background-color: #f3fcf4; }
         #patient-query-output-unsafe { border-left-color: #ffc107; background-color: #fffaf3; margin-top: 10px; }
         #sql-output { border-left-color: #6c757d; background-color: #f1f3f5; white-space: pre-wrap; font-family: monospace; display: none; }
         .debug-info { border-left-color: #fd7e14; background-color: #fff8f2; display: none; }
         .debug-info h4 { margin-bottom: 10px; color: #c85a0a; }
         .debug-info pre { background: #e9ecef; padding: 10px; border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; }

        /* Admin Specific */
        #admin-dashboard .user-list {
            list-style: none;
            margin-top: 15px;
            padding: 0;
            background-color: #fff;
            border-radius: 4px;
            max-height: 300px; /* Increased height */
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        #admin-dashboard .user-list li {
            padding: 12px 18px;
            border-bottom: 1px solid #eee;
            display: grid; /* Use grid for better alignment */
            grid-template-columns: 1fr auto auto auto; /* Username | PatientID | Password | Button */
            gap: 15px;
            align-items: center;
            font-size: 0.9em;
        }
        #admin-dashboard .user-list li:last-child { border-bottom: none; }
         #admin-dashboard .user-list li span:nth-child(1) { font-weight: bold; } /* Username */
         #admin-dashboard .user-list li span:nth-child(3) { font-family: monospace; color: #c82333; } /* Password - Highlight insecurity */
         #admin-dashboard .user-list button {
            padding: 4px 10px;
            font-size: 0.85em;
            text-transform: none;
            letter-spacing: 0;
            justify-self: end; /* Align button to the right */
         }
        .admin-section { margin-top: 30px; padding-top: 25px; border-top: 1px solid #eee; }
        .admin-section h3 { margin-bottom: 20px; color: #343a40; font-weight: 700; font-size: 1.3em; }
        .sql-interface input[type="text"] { margin-bottom: 10px; }
        .sql-interface small { color: #6c757d; display: block; margin-top: 8px;}

        /* View Record Specific */
        #view-record .record-card {
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 20px;
            background-color: #f8f9fa;
            margin-top: 15px;
        }
         #view-record .record-card h3 {
             margin-bottom: 15px;
             color: #007bff;
             font-size: 1.4em;
             border-bottom: 1px solid #eee;
             padding-bottom: 8px;
         }
        #view-record .record-card p {
            margin-bottom: 8px;
            font-size: 1em;
        }
        #view-record .record-card strong {
             color: #343a40;
             min-width: 120px; /* Align labels */
             display: inline-block;
        }
         #view-record .not-found {
             color: #721c24;
             background-color: #f8d7da;
             border: 1px solid #f5c6cb;
             padding: 15px;
             border-radius: 4px;
             text-align: center;
         }


        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            background: #343a40; /* Dark footer */
            color: #adb5bd; /* Lighter gray text */
            font-size: 0.9em;
        }
        footer p { margin: 5px 0; }
        footer strong { color: #dee2e6; }
    </style>
</head>
<body>

    <header>
        <div class="logo">MI</div> <!-- Simple Logo Placeholder -->
        <h1>MediCare Innovations Patient Portal</h1>
    </header>

    <div class="container">
        <nav>
            <ul>
                <li><a href="#home" class="nav-link active">Home</a></li>
                <li><a href="#about" class="nav-link">About (Hidden)</a></li> <!-- Link still exists -->
                <li><a href="#patient-query" class="nav-link">Patient Query</a></li>
                <li><a href="#login" class="nav-link" id="nav-login">Login</a></li>
                <!-- Links shown when logged in -->
                 <!-- The href here is just a placeholder; functionality relies on logged-in user's patientId -->
                <li><a href="#view-record" class="nav-link" id="nav-view-record">My Record</a></li>
                <li><a href="#admin-dashboard" class="nav-link" id="nav-admin">Admin</a></li>
                <li><a href="#" class="nav-link" id="nav-logout">Logout</a></li>
            </ul>
        </nav>

        <!-- Status Message Area -->
        <div id="status-message"></div>

        <!-- Home Section -->
        <div id="home" class="content-section">
            <h2>Welcome to Your Patient Portal</h2>
            <p>Access your health information, manage queries, and learn about web security vulnerabilities through this interactive demonstration portal.</p>

             <div class="vulnerability-note">
                 <strong>VULNERABILITY NOTE: Hidden Content</strong><br>
                 The "About" section, containing details about the vulnerabilities demonstrated on this site, is initially hidden using CSS (`display: none;`). To view it:
                 <ol>
                     <li>Right-click on the "About (Hidden)" link in the navigation above.</li>
                     <li>Select "Inspect" or "Inspect Element" to open Developer Tools.</li>
                     <li>Find the HTML element `<div id="about" class="content-section" ...>`.</li>
                     <li>In the "Styles" panel of the Developer Tools, find the rule `#about { display: none; }`.</li>
                     <li>Uncheck the `display: none;` property or change `none` to `block`.</li>
                 </ol>
                 This demonstrates how developers might hide content client-side, which can sometimes be bypassed.
             </div>

            <div class="info-box" style="margin-top: 20px;">
                <strong>Security Teaching Point: Information Exposure (Client-Side Storage)</strong><br>
                Remember to check your browser's developer tools (F12) → Application (or Storage) → Local Storage. Notice how potentially sensitive identifiers (`customerId`, `institutionId`, user credentials, and even patient data!) are stored directly in your browser? This is highly insecure.
            </div>
            <p style="margin-top: 15px;">Use the navigation above to log in, try the "Patient Query" feature (for an XSS demo), or attempt to view patient records.</p>
        </div>

        <!-- About Section (Hidden by default via CSS rule #about { display: none; }) -->
        <div id="about" class="content-section">
             <h1>About This Educational Site (Hidden Section)</h1>
             <p>If you are seeing this, you've successfully used Developer Tools to reveal hidden content!</p>
             <p>This "MediCare Innovations" portal simulates a poorly secured web application to teach fundamental cyber security concepts.</p>
             <h3>Demonstrated Vulnerabilities & Concepts:</h3>
             <ul>
                 <li><strong>Insecure Direct Object References (IDOR):</strong> The "My Record" feature allows viewing patient data based on an ID in the URL (`#view-record?patientId=...`). There's no proper authorization, so changing the ID allows viewing *any* patient's data stored locally.</li>
                 <li><strong>Hidden Content (CSS Manipulation):</strong> You are viewing this section because you likely modified the CSS `display` property.</li>
                 <li><strong>Insecure Client-Side Storage:</strong> Sensitive IDs, user credentials (plain text passwords!), and fake patient medical data are stored directly in `localStorage`.</li>
                 <li><strong>Insecure Authentication:</strong> Client-side password checks, weak default/guessable passwords for multiple users.</li>
                 <li><strong>Plain Text Passwords:</strong> Passwords stored and compared without hashing (visible in Admin panel!).</li>
                 <li><strong>Reflected Cross-Site Scripting (XSS):</strong> The "Patient Query" section has an unsafe area demonstrating how unsanitized input can lead to script execution.</li>
                 <li><strong>Broken Access Control:</strong> Relying on `adminLevel` in `localStorage` for admin/super-admin privileges, which can be manually edited by the user for privilege escalation.</li>
                 <li><strong>Information Exposure (Debug Features):</strong> Potential for leftover debug code (`?debug=true`) revealing internal state or data.</li>
                 <li><strong>Potential for Input Injection:</strong> The "SQL-like" interface simulates risks of unvalidated command input.</li>
             </ul>
            <p><strong>Disclaimer:</strong> These practices are <strong>intentionally insecure</strong> for teaching. <strong>Never use these techniques in production systems.</strong> Always prioritize server-side validation, secure password hashing, robust authorization checks, input sanitization, and minimizing client-side sensitive data.</p>
         </div>

         <!-- Patient Query Section (for XSS Demo) -->
        <div id="patient-query" class="content-section">
            <h2>Submit a Patient Query</h2>
            <p>Enter your query below. Observe how the system reflects your input in the safe and unsafe display areas.</p>
            <form id="patient-query-form">
                <label for="query-message">Your Query:</label>
                <textarea id="query-message" name="query-message" rows="4" placeholder="e.g., Details about fasting before blood test ID BT-451?"></textarea>
                <input type="submit" value="Submit Query">
            </form>
            <div id="patient-query-output-safe" style="display: none; margin-top: 20px;"></div>
             <div id="patient-query-output-unsafe" style="display: none; margin-top: 10px;">
                 <h4 style="color: #ffc107; font-weight: bold;">Unsafe Display Area (XSS Demo):</h4>
                 <p><small>Input rendered here using `innerHTML` without proper sanitization.</small></p>
                 <div id="unsafe-content" style="border: 1px dashed #ffc107; padding: 10px; margin-top: 5px; background: #fffbeb;"></div>
                  <p style="margin-top:15px;"><small><strong>Try submitting:</strong> <code><img src=x onerror=alert('XSS Vulnerability!')></code> or <code><b onmouseover=alert('Gotcha!')>Hover Me</b></code></small></p>
             </div>
        </div>

        <!-- Login Section -->
        <div id="login" class="content-section">
            <h1>Patient & Staff Login</h1>
             <p><em>(Demonstrates insecure client-side authentication and weak default/guessable passwords)</em></p>
            <form id="login-form">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required autocomplete="username">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
                <input type="submit" value="Login">
            </form>
             <div class="info-box" style="margin-top: 25px;">
                <p style="font-weight: bold; color: #0056b3;">Hints & Security Notes:</p>
                 <ul>
                     <li>Try default admin: <code>admin</code> / <code>password123</code></li>
                     <li>Try other guessable accounts: <code>bsmith</code> / <code>Password!</code>, <code>jjones</code> / <code>jjones</code>, <code>guest</code> / <code>guest</code>, etc. (See DevTools LocalStorage for more!)</li>
                     <li><strong>Super Admin (Privilege Escalation):</strong> Log in as `admin`. Use DevTools (F12) → Application → Local Storage → `mediCareUsers` key. Edit the JSON, changing `adminLevel` for the `admin` user from `1` to `2`. Refresh & log in again.</li>
                     <li>Passwords are stored in plain text! (Visible in Admin Dashboard)</li>
                 </ul>
             </div>
        </div>

        <!-- View Patient Record Section (IDOR Target) -->
        <div id="view-record" class="content-section" style="display: none;">
             <h1>Patient Record Access</h1>
             <div id="record-content">
                <!-- Content dynamically added by JS based on URL patientId -->
             </div>
             <div class="vulnerability-note" style="margin-top: 25px;">
                <strong>VULNERABILITY NOTE: Insecure Direct Object References (IDOR)</strong><br>
                This page displays patient data based *directly* on the `patientId` found in the URL (e.g., `#view-record?patientId=1005`). Because there is no proper authorization check on the server (or even simulated here), you can change the `patientId` number in the URL to view the records of *other patients* (try IDs from 1001 to 1012). In a real system, this is a critical flaw allowing unauthorized access to sensitive data. Secure systems MUST validate on the server that the logged-in user is authorized to view the requested record ID.
             </div>
        </div>


        <!-- Admin Dashboard Section -->
        <div id="admin-dashboard" class="content-section" style="display: none;">
            <!-- Content generated by JavaScript -->
        </div>

        <!-- Debug Info Section -->
        <div id="debug-info" class="debug-info content-section">
             <!-- Content generated by JavaScript -->
        </div>


    </div> <!-- /container -->

    <footer>
        <p>© 2023 <strong>MediCare Innovations</strong> - Educational Demonstration Portal</p>
        <p>This site contains <strong>intentional security vulnerabilities</strong> for learning purposes only. Not for real use.</p>
    </footer>

    <script>
        // --- Constants and State ---
        const USERS_STORAGE_KEY = 'mediCareUsers';
        const PATIENT_DATA_STORAGE_KEY = 'mediCarePatientData';
        let currentUser = null; // Store logged-in user info { username, adminLevel, patientId }
        let isDebugMode = false;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupNavigation();
            setupEventListeners();
            handleUrlChange(); // Handle initial URL hash/params
            updateUIBasedOnLogin();

            // Check for debug mode parameter
            const urlParams = new URLSearchParams(window.location.search);
            isDebugMode = urlParams.has('debug') && urlParams.get('debug') === 'true';
            console.log(`Debug mode is ${isDebugMode ? 'ON' : 'OFF'}`);

            // SECURITY TEACHING POINT: Insecure initial other data in localStorage
            if (!localStorage.getItem("institutionId")) {
                localStorage.setItem("institutionId", "INST-MEDCR-11A");
                localStorage.setItem("customerId", "MC-CUST-98765");
                localStorage.setItem("analyticsId", "TRACKID_MC_PROD_45");
                console.warn("WARNING: Initialized insecure demo identifiers in localStorage.");
            }
        });

        // Handle hash changes and back/forward navigation
        window.addEventListener('hashchange', handleUrlChange);

        function initializeApp() {
            // Initialize users if not present
            if (!localStorage.getItem(USERS_STORAGE_KEY)) {
                const defaultUsers = generateInitialUsers();
                saveUsers(defaultUsers);
                console.log("Initialized default users in localStorage.");
            }
             // Initialize patient data if not present
             if (!localStorage.getItem(PATIENT_DATA_STORAGE_KEY)) {
                 const defaultPatientData = generateInitialPatientData();
                 savePatientData(defaultPatientData);
                 console.log("Initialized default patient data in localStorage.");
             }
            clearStatusMessage();
        }

        // --- Data Generation ---
        function generateInitialUsers() {
            // SECURITY TEACHING POINT: Weak/guessable passwords, plain text storage
            let patientIdCounter = 1001;
            return [
                { username: 'admin', password: 'password123', adminLevel: 1, patientId: patientIdCounter++ }, // 1001
                { username: 'student', password: 'changeme', adminLevel: 0, patientId: patientIdCounter++ }, // 1002
                { username: 'bsmith', password: 'Password!', adminLevel: 0, patientId: patientIdCounter++ }, // 1003 - Barbara Smith
                { username: 'jjones', password: 'jjones', adminLevel: 0, patientId: patientIdCounter++ }, // 1004 - John Jones
                { username: 'guest', password: 'guest', adminLevel: 0, patientId: patientIdCounter++ }, // 1005
                { username: 'testuser', password: 'testuser', adminLevel: 0, patientId: patientIdCounter++ }, // 1006
                { username: 'r.davis', password: 'monkey1', adminLevel: 0, patientId: patientIdCounter++ }, // 1007 - Robert Davis
                { username: 's.miller', password: 'password', adminLevel: 0, patientId: patientIdCounter++ }, // 1008 - Susan Miller
                { username: 'demo', password: 'demo', adminLevel: 0, patientId: patientIdCounter++ }, // 1009
                { username: 'temp', password: 'temp', adminLevel: 0, patientId: patientIdCounter++ }, // 1010
                { username: 'wilsonp', password: 'Wilson<3', adminLevel: 0, patientId: patientIdCounter++ }, // 1011 - Patricia Wilson
                { username: 'nurse_a', password: 'NursePass1', adminLevel: 1, patientId: patientIdCounter++ } // 1012 - Admin Nurse
            ];
        }

        function generateInitialPatientData() {
            const data = {};
            const bloodTypes = ['O+', 'A+', 'B+', 'AB+', 'O-', 'A-', 'B-', 'AB-'];
            const conditions = ['Hypertension', 'Type 2 Diabetes', 'Asthma', 'High Cholesterol', 'None', 'Arthritis', 'Migraines'];
            const allergies = ['Penicillin', 'Peanuts', 'None', 'Shellfish', 'Pollen', 'Dust Mites', 'Aspirin'];
            const names = ['Admin User', 'Student User', 'Barbara Smith', 'John Jones', 'Guest User', 'Test Subject', 'Robert Davis', 'Susan Miller', 'Demo Patient', 'Temporary Record', 'Patricia Wilson', 'Nurse Admin'];
            let patientIdCounter = 1001;

            for (let i = 0; i < 12; i++) {
                const id = patientIdCounter++;
                data[id] = {
                    patientId: id,
                    name: names[i] || `Patient ${id}`,
                    bloodType: bloodTypes[Math.floor(Math.random() * bloodTypes.length)],
                    bmi: (18.5 + Math.random() * 15).toFixed(1), // Random BMI between 18.5 and 33.5
                    lastCheckup: `202${Math.floor(Math.random() * 4)}-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    conditions: conditions[Math.floor(Math.random() * conditions.length)],
                    allergies: allergies[Math.floor(Math.random() * allergies.length)]
                };
            }
            return data;
        }


        // --- LocalStorage Accessors ---
        function getUsers() {
            try {
                const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
                const users = usersJson ? JSON.parse(usersJson) : [];
                return Array.isArray(users)
                    ? users.map(u => ({ ...u, adminLevel: parseInt(u.adminLevel, 10) || 0, patientId: parseInt(u.patientId) || null }))
                    : [];
            } catch (e) {
                console.error("Error parsing users from localStorage:", e);
                setStatusMessage("Critical Error: Could not read user data.", "error");
                return [];
            }
        }

        function saveUsers(users) {
             try {
                 const sanitizedUsers = users.map(u => ({
                    ...u,
                    adminLevel: parseInt(u.adminLevel, 10) || 0,
                    patientId: parseInt(u.patientId) || null // Ensure patientId is saved as number or null
                }));
                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(sanitizedUsers));
             } catch (e) {
                 console.error("Error saving users to localStorage:", e);
                 setStatusMessage("Error saving user data.", "error");
             }
        }

        function getPatientData() {
             try {
                 const dataJson = localStorage.getItem(PATIENT_DATA_STORAGE_KEY);
                 return dataJson ? JSON.parse(dataJson) : {};
             } catch (e) {
                 console.error("Error parsing patient data from localStorage:", e);
                 setStatusMessage("Critical Error: Could not read patient data.", "error");
                 return {};
             }
        }

         function savePatientData(data) {
             try {
                 localStorage.setItem(PATIENT_DATA_STORAGE_KEY, JSON.stringify(data));
             } catch (e) {
                 console.error("Error saving patient data to localStorage:", e);
                 setStatusMessage("Error saving patient data.", "error");
             }
         }


        // --- User Management (Add/Remove) ---
        function addUser(username, password, adminLevel = 0) {
            // Simplified: Doesn't add patient data automatically here for demo
            // Would need logic to assign next available patientId and create data entry
            if (!username || !password) {
                setStatusMessage("Username and password cannot be empty.", "error");
                return false;
            }
            const users = getUsers();
            if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                setStatusMessage(`User "${username}" already exists.`, "error");
                return false;
            }
            const numericAdminLevel = parseInt(adminLevel, 10);
            if (isNaN(numericAdminLevel) || numericAdminLevel < 0 || numericAdminLevel > 1) {
                 setStatusMessage("Invalid Admin Level via UI (must be 0 or 1).", "error");
                 return false;
             }
            // Assign a placeholder patientId or null if not linking automatically
            users.push({ username, password, adminLevel: numericAdminLevel, patientId: null });
            saveUsers(users);
            setStatusMessage(`User "${username}" added successfully (Level ${numericAdminLevel}). Note: No patient record linked automatically.`, "success");
            return true;
        }

        function removeUser(usernameToRemove) {
            let users = getUsers();
            const initialLength = users.length;
            const lowerCaseUsernameToRemove = usernameToRemove.toLowerCase();

            if (currentUser && lowerCaseUsernameToRemove === currentUser.username.toLowerCase()) {
                 setStatusMessage("Action blocked: Cannot remove yourself.", "error");
                 return false;
            }

            // Also remove associated patient data (for demo cleanup)
            const userToRemove = users.find(u => u.username.toLowerCase() === lowerCaseUsernameToRemove);
            const patientIdToRemove = userToRemove?.patientId;

            users = users.filter(u => u.username.toLowerCase() !== lowerCaseUsernameToRemove);

            if (users.length < initialLength) {
                saveUsers(users);
                 // Remove patient data if ID existed
                 if (patientIdToRemove) {
                     const patientData = getPatientData();
                     if (patientData[patientIdToRemove]) {
                         delete patientData[patientIdToRemove];
                         savePatientData(patientData);
                         console.log(`Removed associated patient data for ID: ${patientIdToRemove}`);
                     }
                 }
                setStatusMessage(`User "${usernameToRemove}" removed successfully.`, "success");
                return true;
            } else {
                setStatusMessage(`User "${usernameToRemove}" not found.`, "error");
                return false;
            }
        }

        // --- Authentication ---
        function handleLogin(event) {
            event.preventDefault();
            clearStatusMessage();
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                setStatusMessage("Please enter both username and password.", "error"); return;
            }

            const users = getUsers();
            const foundUser = users.find(u => u.username === username && u.password === password);

            if (foundUser) {
                currentUser = {
                    username: foundUser.username,
                    adminLevel: parseInt(foundUser.adminLevel, 10) || 0,
                    patientId: parseInt(foundUser.patientId) || null // Store patientId
                };
                setStatusMessage(`Login successful. Welcome, ${currentUser.username}!`, "success");
                updateUIBasedOnLogin();

                 // Set the 'My Record' link correctly
                 updateViewRecordLink();

                 let redirectSection = 'home';
                 if (currentUser.adminLevel > 0) redirectSection = 'admin-dashboard';
                 else if (currentUser.patientId) redirectSection = `view-record?patientId=${currentUser.patientId}`; // Go to own record if exists

                window.location.hash = `#${redirectSection}`;
                usernameInput.value = ''; passwordInput.value = '';
            } else {
                setStatusMessage("Invalid username or password.", "error");
                currentUser = null;
                updateUIBasedOnLogin();
                passwordInput.value = '';
            }
            toggleDebugInfoVisibility();
        }

        function handleLogout() {
            if (!currentUser) return;
            setStatusMessage(`User ${currentUser.username} logged out.`, "success");
            currentUser = null;
            updateUIBasedOnLogin();
            toggleDebugInfoVisibility();
            window.location.hash = '#home';
        }

        // --- UI Updates ---
        function updateUIBasedOnLogin() {
            const navLogin = document.getElementById('nav-login');
            const navAdmin = document.getElementById('nav-admin');
            const navLogout = document.getElementById('nav-logout');
            const navViewRecord = document.getElementById('nav-view-record');

            if (currentUser) {
                navLogin.style.display = 'none';
                navLogout.style.display = 'inline-block';
                // Only show 'My Record' if user has a patientId associated
                navViewRecord.style.display = currentUser.patientId ? 'inline-block' : 'none';
                 updateViewRecordLink(); // Update href just in case
                navAdmin.style.display = currentUser.adminLevel > 0 ? 'inline-block' : 'none';
            } else {
                navLogin.style.display = 'inline-block';
                navLogout.style.display = 'none';
                navAdmin.style.display = 'none';
                navViewRecord.style.display = 'none';
            }
        }

         // Update the href of the "My Record" link
         function updateViewRecordLink() {
             const navViewRecord = document.getElementById('nav-view-record');
             if (currentUser && currentUser.patientId) {
                 navViewRecord.href = `#view-record?patientId=${currentUser.patientId}`;
             } else {
                 navViewRecord.href = '#view-record'; // Default or hide if no ID
             }
         }

        function setStatusMessage(message, type = 'info', duration = 7000) {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) return;
            // Simple text sanitization for status messages to prevent accidental HTML
            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.style.display = 'block';
             if (duration > 0) setTimeout(clearStatusMessage, duration);
        }

         function clearStatusMessage() {
            const statusDiv = document.getElementById('status-message');
             if (statusDiv) {
                 statusDiv.textContent = '';
                 statusDiv.style.display = 'none';
                 statusDiv.className = '';
             }
        }

        // --- Navigation & Section Display ---
        function setupNavigation() {
             document.querySelector('nav').addEventListener('click', (event) => {
                 const targetLink = event.target.closest('a.nav-link');
                 if (!targetLink) return;

                 if (targetLink.id === 'nav-logout') {
                     event.preventDefault();
                     handleLogout();
                 }
                 // Allow hash change to trigger routing via handleUrlChange for other links
             });
         }

        function handleUrlChange() {
            const hash = window.location.hash;
            let sectionId = 'home';
            let params = new URLSearchParams();

            if (hash && hash.includes('?')) {
                 const parts = hash.split('?');
                 sectionId = parts[0].substring(1); // Remove '#'
                 params = new URLSearchParams(parts[1]);
            } else if (hash && hash.length > 1) {
                 sectionId = hash.substring(1);
            }

            // Check permissions before showing section
            if (sectionId === 'admin-dashboard' && (!currentUser || currentUser.adminLevel === 0)) {
                 setStatusMessage("Access denied. Please log in as an admin.", "error");
                 window.location.hash = '#login'; // Force redirect
            } else if (sectionId === 'view-record' && !currentUser) {
                 setStatusMessage("Please log in to view records.", "error");
                 window.location.hash = '#login'; // Force redirect
            } else if (sectionId === 'view-record' && !params.has('patientId')) {
                 setStatusMessage("Patient ID missing. Cannot view record.", "error");
                 // Optionally redirect or just show an error on the view-record page itself
                 showSection('view-record'); // Show the section to display the error within it
                 renderPatientRecordPage(null); // Render with null ID
            } else {
                showSection(sectionId);
                // Render specific page content if needed
                 if (sectionId === 'view-record') {
                     renderPatientRecordPage(params.get('patientId'));
                 }
            }
             toggleDebugInfoVisibility();
             updateActiveNavLink(sectionId); // Update nav highlight
        }


        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = (section.id === sectionId) ? 'block' : 'none';
            });

            // Special handling for hidden 'about' section - keep it hidden unless CSS is changed
            const aboutSection = document.getElementById('about');
            if (aboutSection && sectionId !== 'about') {
                // Don't force display:block if it's meant to be hidden by rule
            } else if (aboutSection && sectionId === 'about') {
                 aboutSection.style.display = 'block'; // Allow showing if navigated directly (after CSS change)
            }

            if (sectionId === 'admin-dashboard' && currentUser?.adminLevel > 0) {
                renderAdminDashboard();
            }
            clearStatusMessage();
        }

         function updateActiveNavLink(sectionId) {
             document.querySelectorAll('nav .nav-link').forEach(link => {
                 link.classList.remove('active');
                 // Match base hash part only for highlighting
                 const linkHashBase = link.getAttribute('href')?.split('?')[0];
                 if (linkHashBase === `#${sectionId}`) {
                     link.classList.add('active');
                 }
             });
         }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('patient-query-form')?.addEventListener('submit', handlePatientQuery);
            // Admin listeners are added dynamically
        }

        // --- Patient Query Section (XSS Demo) ---
        function handlePatientQuery(event) {
            event.preventDefault();
            const messageInput = document.getElementById("query-message");
            const safeOutputDiv = document.getElementById("patient-query-output-safe");
            const unsafeContentDiv = document.getElementById("unsafe-content");
            const unsafeOutputDiv = document.getElementById("patient-query-output-unsafe");
            const message = messageInput.value;

            clearStatusMessage();
            safeOutputDiv.textContent = `Query Received (Safely Displayed): "${message}"`;
            safeOutputDiv.style.display = 'block';

            // *** XSS VULNERABILITY ***
            unsafeContentDiv.innerHTML = `Your query was: ${message}`;
            unsafeOutputDiv.style.display = 'block';

            setStatusMessage("Query submitted. Compare safe vs unsafe display.", 'info', 10000);
        }

        // --- View Patient Record Rendering (IDOR Target) ---
         function renderPatientRecordPage(patientId) {
            const contentDiv = document.getElementById('record-content');
            if (!contentDiv) return;

            // VULNERABILITY: Directly use the provided patientId without checking
            // if the logged-in user is authorized to view it.
            const patientDataStore = getPatientData();
            const record = patientId ? patientDataStore[patientId] : null;

            if (record) {
                 contentDiv.innerHTML = `
                     <div class="record-card">
                         <h3>Health Metrics Summary</h3>
                         <p><strong>Patient ID:</strong> ${record.patientId}</p>
                         <p><strong>Name:</strong> ${record.name || 'N/A'}</p>
                         <p><strong>Blood Type:</strong> ${record.bloodType || 'N/A'}</p>
                         <p><strong>BMI:</strong> ${record.bmi || 'N/A'}</p>
                         <p><strong>Last Checkup:</strong> ${record.lastCheckup || 'N/A'}</p>
                         <p><strong>Known Conditions:</strong> ${record.conditions || 'None Recorded'}</p>
                         <p><strong>Reported Allergies:</strong> ${record.allergies || 'None Reported'}</p>
                     </div>
                 `;
            } else if (patientId) {
                 // ID was provided but not found
                 contentDiv.innerHTML = `<div class="not-found">Patient record not found for ID: ${patientId}.</div>`;
            } else {
                 // No ID provided in URL
                 contentDiv.innerHTML = `<div class="not-found">No Patient ID provided in the URL. Please use a link like "#view-record?patientId=1001".</div>`;
            }
         }


        // --- Admin Dashboard Rendering and Functionality ---
        function renderAdminDashboard() {
            const dashboardDiv = document.getElementById('admin-dashboard');
             if (!currentUser || currentUser.adminLevel === 0) {
                 dashboardDiv.innerHTML = '<h1>Access Denied</h1><p>Admin privileges required.</p>'; return;
             }
             const isSuperAdmin = currentUser.adminLevel === 2;

            let superAdminControls = '';
             if (isSuperAdmin) { /* Super Admin HTML */ } // (Shortened for brevity, same as before)

            const users = getUsers();
            let userListHtml = '<p>No users found.</p>';
            if (users.length > 0) {
                userListHtml = '<ul class="user-list">';
                // Show PASSWORDS explicitly - SECURITY TEACHING POINT
                users.forEach(user => {
                    const disableDelete = (currentUser && user.username.toLowerCase() === currentUser.username.toLowerCase()) ? 'disabled title="Cannot remove yourself"' : '';
                    const levelText = user.adminLevel === 2 ? 'Super(2)' : user.adminLevel === 1 ? 'Admin(1)' : 'User(0)';
                    userListHtml += `
                        <li>
                            <span>${user.username} (${levelText})</span>
                            <span>ID: ${user.patientId || 'N/A'}</span>
                            <span>Pass: ${user.password}</span>
                            <button class="danger remove-user-btn" data-username="${user.username}" ${disableDelete}>Remove</button>
                        </li>
                    `;
                });
                userListHtml += '</ul>';
            }

            dashboardDiv.innerHTML = `
                <h1>Admin Dashboard</h1>
                <p>Welcome, <strong>${currentUser.username}</strong>! Access Level: <strong>${currentUser.adminLevel} ${isSuperAdmin ? '(Super Admin)' : ''}</strong></p>
                <div class="admin-section">
                    <h3>User Accounts (Plain Text Passwords Shown!)</h3>
                    ${userListHtml}
                     <p style="color:#dc3545; margin-top:10px; font-size:0.9em;"><strong>Security Risk:</strong> Passwords should never be stored or displayed in plain text!</p>
                </div>
                 <div class="admin-section">
                     <h3>Add New User</h3>
                      <form id="add-user-form">
                          <label for="new-username">Username:</label>
                          <input type="text" id="new-username" required>
                          <label for="new-password">Password:</label>
                          <input type="password" id="new-password" required autocomplete="new-password">
                          <label for="new-adminlevel">Admin Level (0=User, 1=Admin):</label>
                          <select id="new-adminlevel"><option value="0" selected>0 - Standard User</option><option value="1">1 - Administrator</option></select>
                          <button type="submit" class="secondary">Add User</button>
                      </form>
                      <p><small>Note: Super Admin (Level 2) requires manual localStorage edit.</small></p>
                 </div>
                <div class="admin-section sql-interface">
                    <h3>Basic Command Interface</h3>
                    <p><em>(Simulates command injection risks)</em></p>
                    <label for="sql-command">Enter Command:</label>
                    <input type="text" id="sql-command" placeholder="e.g., LIST USERS;">
                    <button id="run-sql-command">Run</button>
                    <div id="sql-output"></div>
                     <small>Commands: ADD USER [u] [p] [lvl(0/1)]; REMOVE USER [u]; LIST USERS;</small>
                </div>
                ${superAdminControls}
            `;
            addAdminDashboardListeners(dashboardDiv);
            toggleDebugInfoVisibility();
        }

        function addAdminDashboardListeners(dashboardDiv) {
            // Remove User buttons
            dashboardDiv.querySelectorAll('.remove-user-btn:not([disabled])').forEach(button => {
                button.addEventListener('click', (e) => {
                    const usernameToRemove = e.target.getAttribute('data-username');
                    if (confirm(`Remove user "${usernameToRemove}" and associated patient data?`)) {
                       if (removeUser(usernameToRemove)) renderAdminDashboard();
                    }
                });
            });
            // Add User form
            const addUserForm = dashboardDiv.querySelector('#add-user-form');
            addUserForm?.addEventListener('submit', (e) => { /* ... same as before ... */ });
            // SQL Command button
             const runSqlCommandBtn = dashboardDiv.querySelector('#run-sql-command');
             runSqlCommandBtn?.addEventListener('click', handleSqlCommand);
            // Super Admin - Delete All Data button
            const deleteAllDataBtn = dashboardDiv.querySelector('#delete-all-data');
            deleteAllDataBtn?.addEventListener('click', () => { /* ... same as before ... */ });
        }


        // --- "SQL-like" Command Handling ---
        function handleSqlCommand() {
            const commandInput = document.getElementById('sql-command');
            const outputDiv = document.getElementById('sql-output');
            const command = commandInput.value.trim();
            const commandUpper = command.toUpperCase();
            outputDiv.textContent = ''; outputDiv.style.display = 'none';
            clearStatusMessage();

            try {
                 if (commandUpper.startsWith('ADD USER ')) {
                    // ... logic same as before, ensure level cannot be 2 ...
                 } else if (commandUpper.startsWith('REMOVE USER ')) {
                    // ... logic same as before ...
                 } else if (commandUpper === 'LIST USERS;') {
                    const users = getUsers();
                    outputDiv.innerHTML = '<strong>Current Users:</strong>\n' + users.map(u => `- ${u.username} (Lvl:${u.adminLevel}, ID:${u.patientId || 'N/A'}, Pass:${u.password})`).join('\n'); // Show Pass!
                    outputDiv.style.display = 'block';
                 } else {
                    outputDiv.textContent = "Unknown command or invalid syntax."; outputDiv.style.display = 'block';
                 }
            } catch (e) { /* ... error handling ... */ }
            commandInput.value = '';
        }


        // --- Super Admin Functionality ---
        function deleteAllSiteData() {
            if (!currentUser || currentUser.adminLevel !== 2) {
                setStatusMessage("Unauthorized.", "error"); return;
            }
            console.warn("SUPER ADMIN ACTION: Deleting all site data...");
            const keysToRemove = [
                USERS_STORAGE_KEY, PATIENT_DATA_STORAGE_KEY, // Added patient data key
                "institutionId", "customerId", "analyticsId" // Other demo keys
            ];
            keysToRemove.forEach(key => { localStorage.removeItem(key); console.log(`Removed: ${key}`); });
            currentUser = null;
            alert("SUPER ADMIN: All users, patient data, and other demo site data deleted from localStorage.");
            initializeApp(); // Re-initialize defaults
            updateUIBasedOnLogin();
            window.location.hash = '#login';
        }

        // --- Debug Info Display ---
        function toggleDebugInfoVisibility() {
             const debugDiv = document.getElementById('debug-info'); if (!debugDiv) return;
             if (isDebugMode && currentUser?.adminLevel > 0) {
                 let localStorageContent = '';
                 try { /* Loop through localStorage, same as before */ } catch (e) { localStorageContent = 'Error.'; }
                 debugDiv.innerHTML = `
                     <h2><span style="color: #fd7e14;"></span> Admin Debug Info</h2>
                     <p><em>(Visible due to "?debug=true" URL param & admin login)</em></p>
                     <h4>Current User:</h4><pre>${JSON.stringify(currentUser, null, 2)}</pre>
                     <h4>LocalStorage:</h4><pre>${localStorageContent || 'Empty/Error.'}</pre>
                     <p><small>RISK: Exposing internal state/data.</small></p>`;
                 debugDiv.style.display = 'block';
             } else {
                 debugDiv.style.display = 'none'; debugDiv.innerHTML = '';
             }
        }

    </script>

</body>
</html>
